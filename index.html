<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Einsatzmeldung (Clickable Fix)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --bg:#071225; --line:#16345e; --text:#e7f0ff; --muted:#9bb1d5;
      --accent:#3aa6ff; --danger:#ff4d6d; --good:#21d19f; --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(33,209,159,.12), transparent 55%),
        var(--bg);
    }
    /* ✅ IMPORTANT: don't let sticky header block clicks */
    .topbar{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(11,26,51,.92), rgba(7,18,37,.78)); border-bottom:1px solid rgba(22,52,94,.7); backdrop-filter: blur(10px); padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .brand.right{flex-direction:row-reverse}
    .brand.top{flex-direction:column; align-items:flex-start}
    .brand.hideLogo #logoImg{display:none!important}
    .logo{width:44px; height:44px; border-radius:12px; object-fit:contain; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); display:none;}
    .brandName{font-weight:900; letter-spacing:.2px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}

    /* ✅ CLICKABLE LINKS FIX */
    a.link{
      color:inherit;
      text-decoration:underline;
      cursor:pointer;
      pointer-events:auto !important;
      position:relative;
      z-index:5;
    }
    a.link:hover{filter:brightness(1.15)}

    .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .status{display:flex; align-items:center; gap:8px; flex-wrap:wrap; padding:8px 10px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--muted); font-size:12px;}
    .dot{width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.35); border:1px solid rgba(255,255,255,.25)}
    .dot.ok{background:rgba(33,209,159,.85); border-color:rgba(33,209,159,.65)}
    .dot.work{background:rgba(58,166,255,.85); border-color:rgba(58,166,255,.65)}
    .dot.err{background:rgba(255,77,109,.85); border-color:rgba(255,77,109,.65)}
    select{padding:9px 10px; border-radius:14px; border:1px solid rgba(22,52,94,.9); background:rgba(7,18,37,.55); color:var(--text); outline:none;}
    .wrap{max-width:1220px; margin:18px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px;}
    .card{background:linear-gradient(180deg, rgba(15,42,79,.92), rgba(11,26,51,.85)); border:1px solid rgba(22,52,94,.8); border-radius:var(--r); box-shadow: 0 16px 40px rgba(0,0,0,.25); padding:14px;}
    .card h2{margin:0 0 6px 0; font-size:18px}
    .muted{color:var(--muted); margin:0 0 12px 0}
    .small{font-size:12px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px}
    .tab{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); color:var(--text); cursor:pointer; font-weight:900; font-size:13px;}
    .tab.active{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.28);}
    .row{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-bottom:10px;}
    .row.actions{display:flex; gap:10px; flex-wrap:wrap}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    input, textarea{width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(22,52,94,.9); background:rgba(7,18,37,.55); color:var(--text); outline:none; resize:vertical;}
    input:focus, textarea:focus, select:focus{border-color:rgba(58,166,255,.9); box-shadow:0 0 0 3px rgba(58,166,255,.15)}
    .btn{border:0; padding:10px 12px; border-radius:14px; color:#061226; background:var(--accent); font-weight:900; cursor:pointer; user-select:none;}
    .btn.ghost{background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12);}
    .btn.danger{background:rgba(255,77,109,.18); color:#ffd7de; border:1px solid rgba(255,77,109,.35);}
    .btn:hover{filter:brightness(1.05)}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{display:flex; justify-content:space-between; align-items:flex-start; gap:10px; padding:10px; border-radius:14px; background:rgba(7,18,37,.45); border:1px solid rgba(22,52,94,.7);}
    .item b{display:block}
    .item .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .item .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(58,166,255,.12); border:1px solid rgba(58,166,255,.22); color:var(--text);}
    .countPill{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(33,209,159,.12); border:1px solid rgba(33,209,159,.22); color:var(--text);}
    .pickWrap{border:1px solid rgba(255,255,255,.12); background:rgba(7,18,37,.35); border-radius:16px; padding:10px;}
    .pickHdr{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;}
    .pickList{display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto; padding-right:4px;}
    .pickRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:14px; border:1px solid rgba(22,52,94,.7); background:rgba(7,18,37,.45);}
    .pickLeft{display:flex; gap:10px; align-items:flex-start;}
    .chk{width:18px; height:18px; margin-top:2px; accent-color: var(--accent);}
    .pickName{font-weight:900}
    .pickMeta{color:var(--muted); font-size:12px; margin-top:2px}
    .sigBox{border:1px dashed rgba(255,255,255,.22); background:rgba(7,18,37,.35); border-radius:16px; padding:10px;}
    canvas{width:100%; height:180px; border-radius:14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); touch-action:none;}
    .sigActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .note{border:1px solid rgba(33,209,159,.25); background:rgba(33,209,159,.08); padding:10px; border-radius:14px; margin-top:10px; color:#dbfff5;}
    .span2{grid-column: 1 / span 2}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .row{grid-template-columns:1fr}
      .brand{min-width:unset}
    }
    .modal{position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55); padding:16px;}
    .modal.show{display:flex}
    .modalCard{width:min(820px, 100%); background:linear-gradient(180deg, rgba(15,42,79,.98), rgba(11,26,51,.96)); border:1px solid rgba(22,52,94,.9); border-radius:18px; box-shadow: 0 20px 70px rgba(0,0,0,.45); padding:14px;}
    .modalTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modalTop h3{margin:0; font-size:16px}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand" id="brandWrap">
      <img class="logo" id="logoImg" alt="Logo"/>
      <div>
        <div class="brandName" id="brandName">Masculine Security</div>
        <div class="brandSub" id="brandSub"></div>
      </div>
    </div>

    <div class="topActions">
      <div class="status" title="Auto-save status">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Ready</span>
      </div>

      <select id="logoPosApp" title="Logo position in App">
        <option value="left">App: Left</option>
        <option value="right">App: Right</option>
        <option value="top">App: Top</option>
        <option value="hide">App: Hide</option>
      </select>

      <select id="logoPos" title="Logo position in PDF">
        <option value="left">Logo Left (PDF)</option>
        <option value="right">Logo Right (PDF)</option>
        <option value="top">Logo Top (PDF)</option>
        <option value="hide">Hide Logo (PDF)</option>
      </select>

      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px">
        Logo PNG (optional)
        <input id="logoFile" type="file" accept="image/png" style="display:none">
      </label>
      <button class="btn ghost" id="btnClearLogo" type="button">Remove Logo</button>

      <button class="btn ghost" id="btnBackup" type="button">Backup (Full)</button>
      <button class="btn ghost" id="btnRestore" type="button">Restore (Full)</button>
      <button class="btn ghost" id="btnClearDraft" type="button">Clear Draft</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="app" type="button">App</button>
      <button class="tab" data-tab="settings" type="button">Einstellungen</button>
    </div>

    <section id="tab-app">
      <section class="grid">
        <div class="card">
          <h2>Mitarbeiter (unlimited)</h2>
          <p class="muted">Mitarbeiter walba wuxuu leeyahay <b>signature gaar ah</b> ✅ (pen/stylus waa shaqeeyaa).</p>

          <div class="row">
            <div class="field">
              <label>Vorname & Nachname</label>
              <input id="empName" placeholder="z.B. Ahmed Ali"/>
            </div>
            <div class="field">
              <label>Bewacher-ID (optional)</label>
              <input id="empBewacher" placeholder="z.B. HB-123456"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Telefon (optional)</label>
              <input id="empPhone" placeholder="z.B. 0157..."/>
            </div>
            <div class="field">
              <label>Position (optional)</label>
              <input id="empRole" placeholder="z.B. Wachmann"/>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnAddEmp" type="button">Add Mitarbeiter</button>
            <button class="btn danger" id="btnClearEmp" type="button">Clear</button>
          </div>

          <div class="list" id="empList"></div>
        </div>

        <div class="card">
          <h2>Kunde & Objekt</h2>
          <p class="muted">Typing/Select = auto-save ✅</p>

          <div class="row">
            <div class="field">
              <label>Kunde (Firma/Name)</label>
              <input id="custName" placeholder="z.B. Hotel Bremen GmbH"/>
            </div>
            <div class="field">
              <label>Objektname</label>
              <input id="objName" placeholder="z.B. Eingang / Lobby"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Einsatzort (Adresse)</label>
              <input id="objAddr" placeholder="Straße, PLZ Ort"/>
            </div>
            <div class="field">
              <label>Objekt-Typ</label>
              <select id="objType">
                <option value="Hotel">Hotel</option>
                <option value="Baustelle">Baustelle</option>
                <option value="Event">Event</option>
                <option value="Asylheim">Asylheim</option>
                <option value="Nachtwache">Nachtwache</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnSaveObj" type="button">Save Objekt</button>
            <button class="btn danger" id="btnClearObj" type="button">Clear</button>
          </div>

          <div class="list" id="objList"></div>
        </div>

        <div class="card span2">
          <h2>Einsatzmeldung erstellen</h2>

          <div class="row">
            <div class="field">
              <label>Objekt wählen</label>
              <select id="selObj"></select>
            </div>
            <div class="field">
              <label>Selected Mitarbeiter</label>
              <div class="countPill" id="selEmpCount">0 selected</div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Mitarbeiter auswählen</label>
              <div class="pickWrap">
                <div class="pickHdr">
                  <div class="muted small">Tick + “Sign” → qor signature.</div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn ghost" id="btnEmpSelectAll" type="button">Select all</button>
                    <button class="btn ghost" id="btnEmpClearAll" type="button">Clear all</button>
                  </div>
                </div>
                <div class="pickList" id="empPickList"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Datum</label>
              <input id="shiftDate" type="date"/>
            </div>
            <div class="field">
              <label>Start</label>
              <input id="shiftStart" type="time" step="60"/>
            </div>
            <div class="field">
              <label>Ende</label>
              <input id="shiftEnd" type="time" step="60"/>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Unterschrift Arbeitgeber / Auftraggeber (saved)</label>
              <div class="sigBox">
                <canvas id="sigCanvasAg" width="900" height="240"></canvas>
                <div class="sigActions">
                  <button class="btn ghost" id="btnSigClearAg" type="button">Clear</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnCreate" type="button">Save / Update Einsatz</button>
            <button class="btn" id="btnPDF" type="button">Generate PDF</button>
          </div>

          <div class="list" id="einsatzList"></div>
        </div>
      </section>
    </section>

    <section id="tab-settings" style="display:none">
      <div class="card">
        <h2>Einstellungen — Firmendaten (saved)</h2>

        <div class="row">
          <div class="field">
            <label>Firmenname</label>
            <input id="setCompanyName"/>
          </div>
          <div class="field">
            <label>Straße & Hausnummer</label>
            <input id="setStreet"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>PLZ & Ort</label>
            <input id="setCity"/>
          </div>
          <div class="field">
            <label>Telefon</label>
            <input id="setPhone"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>E-Mail</label>
            <input id="setEmail"/>
          </div>
          <div class="field">
            <label>Steuernummer/USt-IdNr (optional)</label>
            <input id="setTax"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Hinweis (PDF footer)</label>
            <input id="setFooterNote"/>
          </div>
          <div class="field">
            <label>Default Einsatz-Typ (optional)</label>
            <input id="setDefaultType"/>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnSaveSettings" type="button">Save Settings</button>
        </div>
      </div>
    </section>
  </main>

  <div class="modal" id="sigModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <h3 id="sigModalTitle">Unterschrift</h3>
          <p class="muted small" id="sigModalSub" style="margin:6px 0 0 0;">Pen / finger / mouse</p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ghost" id="btnSigModalClose" type="button">Close</button>
        </div>
      </div>

      <div class="sigBox" style="margin-top:10px">
        <canvas id="sigCanvasEmpModal" width="900" height="260"></canvas>
        <div class="sigActions">
          <button class="btn ghost" id="btnSigModalClear" type="button">Clear</button>
          <button class="btn" id="btnSigModalSave" type="button">Save Signature</button>
          <button class="btn danger" id="btnSigModalRemove" type="button">Remove Signature</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =======================
       STORAGE
    ======================= */
    const STORE_KEY="ms_einsatz_store_v18";
    const DRAFT_KEY="ms_einsatz_draft_v18";
    const $=(id)=>document.getElementById(id);
    const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
    function safeParse(raw,fallback){ try{return JSON.parse(raw)}catch{return fallback} }
    function escapeHtml(s){
      return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function defaultStore(){
      return {
        employees:[],
        objects:[],
        einsaetze:[],
        logoDataUrl:null,
        logoPosition:"left",
        logoPositionApp:"left",
        sigAgDataUrl:null,
        company:{
          name:"Masculine Security",
          street:"Werschenregerstraße 6",
          city:"28237 Bremen",
          phone:"015778697052",
          email:"Kontakt.mass.bremen@hotmail.com",
          tax:"",
          footerNote:"Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.",
          defaultType:""
        }
      };
    }

    let store=safeParse(localStorage.getItem(STORE_KEY), null) || defaultStore();
    function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

    /* ✅ CLICKABLE FIX (also works if something blocks default click) */
    document.addEventListener("click", (e)=>{
      const a = e.target.closest && e.target.closest("a.link");
      if(!a) return;
      const href=a.getAttribute("href")||"";
      if(href.startsWith("mailto:") || href.startsWith("tel:")){
        e.preventDefault();
        window.location.href = href; // force open
      }
    }, true);

    /* =======================
       AUTO-SAVE STATUS
    ======================= */
    let saveTimer=null;
    function setSaveStatus(mode){
      const dot=$("saveDot"), txt=$("saveText");
      dot.classList.remove("ok","work","err");
      if(mode==="saving"){ dot.classList.add("work"); txt.textContent="Saving…"; }
      else if(mode==="saved"){ dot.classList.add("ok"); txt.textContent="Saved"; }
      else if(mode==="error"){ dot.classList.add("err"); txt.textContent="Save error"; }
      else txt.textContent="Ready";
    }

    /* =======================
       LOGO AUTO FROM logo.png
    ======================= */
    async function forceAutoLogoFromPng(){
      if (store.logoDataUrl && String(store.logoDataUrl).startsWith("data:image/")) return;
      try{
        const url = new URL("logo.png", location.href);
        url.searchParams.set("v", Date.now().toString());
        const res = await fetch(url.href, { cache: "no-store" });
        if(!res.ok) throw new Error("logo.png not found");
        const blob = await res.blob();
        if(blob.type !== "image/png") throw new Error("logo is not PNG");
        const dataUrl = await new Promise((resolve, reject)=>{
          const fr = new FileReader();
          fr.onload = ()=> resolve(String(fr.result || ""));
          fr.onerror = reject;
          fr.readAsDataURL(blob);
        });
        store.logoDataUrl = dataUrl;
        saveStore();
        applyLogo();
        refreshBrand();
      }catch(e){
        console.warn("Auto logo load failed:", e);
      }
    }

    function companyAddressLine(c){
      const street=(c.street||"").trim(), city=(c.city||"").trim();
      return [street,city].filter(Boolean).join(", ");
    }
    function refreshBrand(){
      const c=store.company||{};
      $("brandName").textContent=c.name||"Security";
      const addr=companyAddressLine(c) || "—";
      const tel=(c.phone||"").trim();
      const mail=(c.email||"").trim();
      const telHtml = tel ? `Tel: <a class="link" href="tel:${encodeURIComponent(tel)}">${escapeHtml(tel)}</a>` : `Tel: —`;
      const mailHtml = mail ? `E-Mail: <a class="link" href="mailto:${encodeURIComponent(mail)}">${escapeHtml(mail)}</a>` : `E-Mail: —`;
      const logoTxt = store.logoDataUrl ? "Logo: OK" : "Logo: none (logo.png in same folder)";
      $("brandSub").innerHTML = `${escapeHtml(addr)} • ${telHtml} • ${mailHtml} • ${logoTxt}`;
    }
    function applyLogo(){
      const img=$("logoImg");
      if(store.logoDataUrl){ img.src=store.logoDataUrl; img.style.display="block"; }
      else { img.removeAttribute("src"); img.style.display="none"; }
    }
    function applyLogoPositionUI(){
      const pos=store.logoPositionApp||"left";
      const brand=$("brandWrap");
      brand.classList.remove("right","top","hideLogo");
      if(pos==="right") brand.classList.add("right");
      if(pos==="top") brand.classList.add("top");
      if(pos==="hide") brand.classList.add("hideLogo");
      $("logoPosApp").value=pos;
    }

    /* =======================
       SIMPLE INIT (for clickable demo)
    ======================= */
    (function init(){
      const base=defaultStore();
      store = { ...base, ...store, company:{...base.company, ...(store.company||{})} };
      saveStore();
      forceAutoLogoFromPng();
      applyLogoPositionUI();
      applyLogo();
      refreshBrand();
      setSaveStatus("saved");
    })();
  </script>
</body>
</html>
