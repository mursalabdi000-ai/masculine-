<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Einsatzmeldung (99% Auto + Download/Restore)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --bg:#071225;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --danger:#ff4d6d;
      --good:#21d19f;
      --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(33,209,159,.12), transparent 55%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg, rgba(11,26,51,.92), rgba(7,18,37,.78));
      border-bottom:1px solid rgba(22,52,94,.7);
      backdrop-filter: blur(10px);
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .brand.right{flex-direction:row-reverse}
    .brand.top{flex-direction:column; align-items:flex-start}
    .brand.hideLogo #logoImg{display:none!important}

    .logo{
      width:44px; height:44px; border-radius:12px;
      object-fit:contain; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:none;
    }
    .brandName{font-weight:800; letter-spacing:.2px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}

    a.link{
      color:inherit;
      text-decoration:none;
      border-bottom:1px dotted rgba(255,255,255,.35);
      cursor:pointer;
    }
    a.link:hover{ border-bottom-color: rgba(255,255,255,.75); }

    .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .wrap{max-width:1220px; margin:18px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px;}
    .card{
      background:linear-gradient(180deg, rgba(15,42,79,.92), rgba(11,26,51,.85));
      border:1px solid rgba(22,52,94,.8);
      border-radius:var(--r);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      padding:14px;
    }
    .card h2{margin:0 0 6px 0; font-size:18px}
    .muted{color:var(--muted); margin:0 0 12px 0}
    .small{font-size:12px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px}
    .tab{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .tab.active{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.28);}

    .row{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-bottom:10px;}
    .row.actions{display:flex; gap:10px; flex-wrap:wrap}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
      resize:vertical;
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(58,166,255,.9); box-shadow:0 0 0 3px rgba(58,166,255,.15)}

    .btn{
      border:0;
      padding:10px 12px;
      border-radius:14px;
      color:#061226;
      background:var(--accent);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn.ghost{background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12);}
    .btn.danger{background:rgba(255,77,109,.18); color:#ffd7de; border:1px solid rgba(255,77,109,.35);}
    .btn:hover{filter:brightness(1.05)}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(7,18,37,.45);
      border:1px solid rgba(22,52,94,.7);
    }
    .item b{display:block}
    .item .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .item .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(58,166,255,.12);
      border:1px solid rgba(58,166,255,.22);
      color:var(--text);
    }
    .linkbtn{
      background:transparent; border:1px solid rgba(255,255,255,.14);
      color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer;
    }
    .linkbtn:hover{background:rgba(255,255,255,.06)}

    .note{
      border:1px solid rgba(33,209,159,.25);
      background:rgba(33,209,159,.08);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      color:#dbfff5;
    }

    .pickWrap{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(7,18,37,.35);
      border-radius:16px;
      padding:10px;
    }
    .pickHdr{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap; margin-bottom:8px;
    }
    .pickList{display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:4px;}
    .pickRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; padding:8px 10px; border-radius:14px;
      border:1px solid rgba(22,52,94,.7);
      background:rgba(7,18,37,.45);
    }
    .pickLeft{display:flex; gap:10px; align-items:flex-start;}
    .chk{width:18px; height:18px; margin-top:2px; accent-color: var(--accent);}
    .pickName{font-weight:800}
    .pickMeta{color:var(--muted); font-size:12px; margin-top:2px}
    .countPill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(33,209,159,.12);
      border:1px solid rgba(33,209,159,.22);
      color:var(--text);
    }

    .sigBox{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(7,18,37,.35);
      border-radius:16px;
      padding:10px;
    }
    canvas{
      width:100%;
      height:180px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      touch-action:none;
    }
    .sigActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}

    .status{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.25);
    }
    .dot.ok{background:rgba(33,209,159,.85); border-color:rgba(33,209,159,.65);}
    .dot.work{background:rgba(58,166,255,.85); border-color:rgba(58,166,255,.65);}
    .dot.err{background:rgba(255,77,109,.85); border-color:rgba(255,77,109,.65);}

    .span2{grid-column: 1 / span 2}
    .foot{padding:14px 2px 22px}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .row{grid-template-columns:1fr}
      .brand{min-width:unset}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand" id="brandWrap">
      <img class="logo" id="logoImg" alt="Logo"/>
      <div class="brandText">
        <div class="brandName" id="brandName">Masculine Security</div>
        <div class="brandSub" id="brandSub"></div>
      </div>
    </div>

    <div class="topActions">
      <div class="status" title="Auto-save status">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Ready</span>
      </div>

      <select id="logoPosApp" title="Logo position in App">
        <option value="left">App: Left</option>
        <option value="right">App: Right</option>
        <option value="top">App: Top</option>
        <option value="hide">App: Hide</option>
      </select>

      <select id="logoPos" title="Logo position in PDF">
        <option value="left">Logo Left (PDF)</option>
        <option value="right">Logo Right (PDF)</option>
        <option value="top">Logo Top (PDF)</option>
        <option value="hide">Hide Logo (PDF)</option>
      </select>

      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px">
        Logo PNG
        <input id="logoFile" type="file" accept="image/png" style="display:none">
      </label>
      <button class="btn ghost" id="btnClearLogo" type="button">Remove Logo</button>

      <button class="btn ghost" id="btnBackup" type="button">Backup (Full)</button>
      <button class="btn ghost" id="btnRestore" type="button">Restore (Full)</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="app" type="button">App</button>
      <button class="tab" data-tab="settings" type="button">Einstellungen</button>
    </div>

    <!-- APP -->
    <section id="tab-app">
      <section class="grid">
        <!-- Mitarbeiter -->
        <div class="card">
          <h2>Mitarbeiter</h2>
          <p class="muted">Typing = auto-save draft ✅</p>

          <div class="row">
            <div class="field">
              <label>Vorname & Nachname</label>
              <input id="empName" placeholder="z.B. Ahmed Ali"/>
            </div>
            <div class="field">
              <label>Bewacher-ID (optional)</label>
              <input id="empBewacher" placeholder="z.B. HB-123456"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Telefon (optional)</label>
              <input id="empPhone" placeholder="z.B. 0157..."/>
            </div>
            <div class="field">
              <label>Position (optional)</label>
              <input id="empRole" placeholder="z.B. Wachmann"/>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnAddEmp" type="button">Add Mitarbeiter</button>
            <button class="btn danger" id="btnClearEmp" type="button">Clear</button>
          </div>

          <div class="list" id="empList"></div>
        </div>

        <!-- Kunde/Objekt -->
        <div class="card">
          <h2>Kunde & Objekt</h2>
          <p class="muted">Typing/Select = auto-save draft ✅</p>

          <div class="row">
            <div class="field">
              <label>Kunde (Firma/Name)</label>
              <input id="custName" placeholder="z.B. Hotel Bremen GmbH"/>
            </div>
            <div class="field">
              <label>Objektname</label>
              <input id="objName" placeholder="z.B. Eingang / Lobby"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Einsatzort (Adresse)</label>
              <input id="objAddr" placeholder="Straße, PLZ Ort"/>
            </div>
            <div class="field">
              <label>Objekt-Typ</label>
              <select id="objType">
                <option value="Hotel">Hotel</option>
                <option value="Baustelle">Baustelle</option>
                <option value="Event">Event</option>
                <option value="Asylheim">Asylheim</option>
                <option value="Nachtwache">Nachtwache</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnSaveObj" type="button">Save Objekt</button>
            <button class="btn danger" id="btnClearObj" type="button">Clear</button>
          </div>

          <div class="list" id="objList"></div>
        </div>

        <!-- Einsatz -->
        <div class="card span2">
          <h2>Einsatzmeldung erstellen</h2>
          <p class="muted">Company data waxaa lagu geliyaa <b>Einstellungen</b> (PDF kasta auto).</p>

          <div class="row">
            <div class="field">
              <label>Objekt wählen</label>
              <select id="selObj"></select>
            </div>
            <div class="field">
              <label>Selected Mitarbeiter</label>
              <div class="countPill" id="selEmpCount">0 selected</div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Mitarbeiter auswählen</label>
              <div class="pickWrap">
                <div class="pickHdr">
                  <div class="muted small">Tick ku saar 1 ama ka badan (auto-save).</div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn ghost" id="btnEmpSelectAll" type="button">Select all</button>
                    <button class="btn ghost" id="btnEmpClearAll" type="button">Clear all</button>
                  </div>
                </div>
                <div class="pickList" id="empPickList"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Datum</label>
              <input id="shiftDate" type="date"/>
            </div>
            <div class="field">
              <label>Start</label>
              <input id="shiftStart" type="time"/>
            </div>
            <div class="field">
              <label>Ende</label>
              <input id="shiftEnd" type="time"/>
            </div>
          </div>

          <!-- ✅ Export range dates -->
          <div class="row">
            <div class="field">
              <label>Von (Download)</label>
              <input id="expFrom" type="date"/>
            </div>
            <div class="field">
              <label>Bis (Download)</label>
              <input id="expTo" type="date"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Unterschrift Mitarbeiter (auto-save)</label>
              <div class="sigBox">
                <canvas id="sigCanvasEmp" width="900" height="240"></canvas>
                <div class="sigActions">
                  <button class="btn ghost" id="btnSigClearEmp" type="button">Clear</button>
                </div>
              </div>
            </div>
            <div class="field">
              <label>Unterschrift Arbeitgeber / Auftraggeber (auto-save)</label>
              <div class="sigBox">
                <canvas id="sigCanvasAg" width="900" height="240"></canvas>
                <div class="sigActions">
                  <button class="btn ghost" id="btnSigClearAg" type="button">Clear</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnCreate" type="button">Save Einsatz</button>
            <button class="btn" id="btnPDF" type="button">Generate PDF</button>
            <button class="btn danger" id="btnDelete" type="button">Delete selected Einsatz</button>

            <!-- ✅ NEW: download days before -->
            <button class="btn ghost" id="btnExportRangeJson" type="button">Download Einsätze (JSON)</button>
            <button class="btn ghost" id="btnExportRangeCsv" type="button">Download Einsätze (CSV)</button>
            <button class="btn ghost" id="btnImportRangeJson" type="button">Import Einsätze (JSON)</button>
          </div>

          <div class="list" id="einsatzList"></div>

          <div class="note small">
            ✅ “Download Einsätze” = haddii maalmo ka hor loo baahdo → xogta dib ayaad u download-gareyn kartaa. <br>
            ✅ JSON = backup + restore (device kale). CSV = Excel/Sheets.
          </div>
        </div>
      </section>

      <footer class="foot">
        <div class="muted small">Data local (browser). PDF: Generate → Print → “Save as PDF”.</div>
      </footer>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" style="display:none">
      <div class="card">
        <h2>Einstellungen — Firmendaten (saved)</h2>
        <p class="muted">Halkan ku geli xogta shirkadda. Waxay ku save-gareysaa browser-ka oo PDF kasta way ku muuqanaysaa.</p>

        <div class="row">
          <div class="field">
            <label>Firmenname</label>
            <input id="setCompanyName" placeholder="z.B. Masculine Security"/>
          </div>
          <div class="field">
            <label>Straße & Hausnummer</label>
            <input id="setStreet" placeholder="z.B. Werschenregerstraße 6"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>PLZ & Ort</label>
            <input id="setCity" placeholder="z.B. 28237 Bremen"/>
          </div>
          <div class="field">
            <label>Telefon</label>
            <input id="setPhone" placeholder="z.B. 0157..."/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>E-Mail</label>
            <input id="setEmail" placeholder="z.B. Kontakt.mass.bremen@hotmail.com"/>
          </div>
          <div class="field">
            <label>Steuernummer / USt-IdNr (optional)</label>
            <input id="setTax" placeholder="optional"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Hinweis (optional, PDF footer)</label>
            <input id="setFooterNote" placeholder="z.B. Aufbewahrung empfohlen."/>
          </div>
          <div class="field">
            <label>Default Einsatz-Typ (optional)</label>
            <input id="setDefaultType" placeholder="z.B. Hotel / Baustelle"/>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnSaveSettings" type="button">Save Settings</button>
          <button class="btn danger" id="btnResetSettings" type="button">Reset</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // =========================
    // Storage + Migration
    // =========================
    const STORE_KEY = "ms_einsatz_store_v12";
    const DRAFT_KEY = "ms_einsatz_draft_v12";
    const OLD_STORE_KEYS = ["ms_einsatz_store_v11","ms_einsatz_store_v10","ms_einsatz_store_v9","ms_einsatz_store_v8","ms_einsatz_store_v7"];

    const $ = (id)=>document.getElementById(id);
    const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

    function safeParse(raw, fallback){
      try{ return JSON.parse(raw); }catch{ return fallback; }
    }

    function defaultStore(){
      return {
        employees:[], objects:[], einsaetze:[],
        logoDataUrl:null,
        logoPosition:"left",
        logoPositionApp:"left",
        sigEmpDataUrl:null,
        sigAgDataUrl:null,
        company: {
          name: "Masculine Security",
          street: "Werschenregerstraße 6",
          city: "28237 Bremen",
          phone: "015778697052",
          email: "Kontakt.mass.bremen@hotmail.com",
          tax: "",
          footerNote: "Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.",
          defaultType: ""
        }
      };
    }

    function migrateIfNeeded(current){
      if(current) return current;
      for(const k of OLD_STORE_KEYS){
        const old = safeParse(localStorage.getItem(k), null);
        if(old && typeof old === "object"){
          const base = defaultStore();
          const merged = {
            ...base,
            ...old,
            company: { ...base.company, ...(old.company||{}) }
          };
          if(!merged.logoPosition) merged.logoPosition = "left";
          if(!merged.logoPositionApp) merged.logoPositionApp = "left";
          localStorage.setItem(STORE_KEY, JSON.stringify(merged));
          return merged;
        }
      }
      const fresh = defaultStore();
      localStorage.setItem(STORE_KEY, JSON.stringify(fresh));
      return fresh;
    }

    let store = migrateIfNeeded(safeParse(localStorage.getItem(STORE_KEY), null));
    function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

    // =========================
    // Auto-save draft
    // =========================
    let saveTimer = null;

    function setSaveStatus(mode){
      const dot = $("saveDot");
      const txt = $("saveText");
      dot.classList.remove("ok","work","err");
      if(mode==="saving"){ dot.classList.add("work"); txt.textContent="Saving…"; }
      else if(mode==="saved"){ dot.classList.add("ok"); txt.textContent="Saved"; }
      else if(mode==="error"){ dot.classList.add("err"); txt.textContent="Save error"; }
      else { txt.textContent="Ready"; }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function collectDraft(){
      return {
        empName: $("empName").value,
        empBewacher: $("empBewacher").value,
        empPhone: $("empPhone").value,
        empRole: $("empRole").value,

        custName: $("custName").value,
        objName: $("objName").value,
        objAddr: $("objAddr").value,
        objType: $("objType").value,

        selObj: $("selObj").value,
        shiftDate: $("shiftDate").value,
        shiftStart: $("shiftStart").value,
        shiftEnd: $("shiftEnd").value,

        expFrom: $("expFrom").value,
        expTo: $("expTo").value,

        selectedEmpIds: getSelectedEmpIds(),
        logoPosition: $("logoPos").value,
        logoPositionApp: $("logoPosApp").value,
        lastSavedAt: Date.now()
      };
    }

    function saveDraftNow(){
      try{
        localStorage.setItem(DRAFT_KEY, JSON.stringify(collectDraft()));
        setSaveStatus("saved");
      }catch(e){
        setSaveStatus("error");
      }
    }

    function queueAutoSave(){
      setSaveStatus("saving");
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveDraftNow, 250);
    }

    window.addEventListener("beforeunload", ()=>{ try{ saveDraftNow(); saveStore(); }catch{} });

    // =========================
    // Tabs
    // =========================
    function showTab(name){
      $("tab-app").style.display = (name==="app") ? "" : "none";
      $("tab-settings").style.display = (name==="settings") ? "" : "none";
    }
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        showTab(btn.getAttribute("data-tab"));
      });
    });

    // =========================
    // Header clickable + Logo UI
    // =========================
    function refreshBrand(){
      const c = store.company || {};
      const name = c.name || "Security";
      const street = (c.street||"").trim();
      const city = (c.city||"").trim();
      const phone = (c.phone||"").trim();
      const email = (c.email||"").trim();
      const addr = [street, city].filter(Boolean).join(", ");

      $("brandName").textContent = name;

      const telHtml = phone
        ? `Tel: <a class="link" href="tel:${encodeURIComponent(phone)}">${escapeHtml(phone)}</a>`
        : `Tel: —`;

      const mailHtml = email
        ? `E-Mail: <a class="link" href="mailto:${encodeURIComponent(email)}">${escapeHtml(email)}</a>`
        : `E-Mail: —`;

      const logoOk = !!store.logoDataUrl;
      const logoTxt = logoOk ? "Logo: OK" : "Logo: —";

      $("brandSub").innerHTML =
        `${addr ? escapeHtml(addr) : "—"} • ${telHtml} • ${mailHtml} • ${logoTxt} • Auto-Save`;
    }

    function applyLogo(){
      const img = $("logoImg");
      if(store.logoDataUrl){
        img.src = store.logoDataUrl;
        img.style.display = "block";
      }else{
        img.removeAttribute("src");
        img.style.display = "none";
      }
    }

    function applyLogoPos(){ $("logoPos").value = store.logoPosition || "left"; }

    function applyLogoPositionUI(){
      const pos = store.logoPositionApp || "left";
      const brand = $("brandWrap");
      brand.classList.remove("right","top","hideLogo");
      if(pos === "right") brand.classList.add("right");
      if(pos === "top") brand.classList.add("top");
      if(pos === "hide") brand.classList.add("hideLogo");
      $("logoPosApp").value = pos;
    }

    $("logoPos").addEventListener("change", ()=>{
      store.logoPosition = $("logoPos").value;
      saveStore();
      queueAutoSave();
    });

    $("logoPosApp").addEventListener("change", ()=>{
      store.logoPositionApp = $("logoPosApp").value;
      saveStore();
      applyLogoPositionUI();
      queueAutoSave();
    });

    $("logoFile").addEventListener("change", ()=>{
      const file = $("logoFile").files?.[0];
      if(!file) return;
      if(file.type !== "image/png"){ alert("PNG kaliya ✅"); $("logoFile").value=""; return; }
      if(file.size > 3*1024*1024){ alert("Logo < 3MB"); $("logoFile").value=""; return; }
      const fr = new FileReader();
      fr.onload = ()=>{
        store.logoDataUrl = String(fr.result||"");
        saveStore();
        applyLogo();
        refreshBrand();
        $("logoFile").value="";
      };
      fr.readAsDataURL(file);
    });

    $("btnClearLogo").addEventListener("click", ()=>{
      if(!confirm("Remove stored logo?")) return;
      store.logoDataUrl = null;
      saveStore();
      applyLogo();
      refreshBrand();
    });

    // =========================
    // Selection helpers
    // =========================
    function getSelectedEmpIds(){
      return Array.from(document.querySelectorAll('input[data-emp-chk="1"]:checked')).map(i=>i.value);
    }
    function setSelectedEmpIds(ids){
      const set = new Set((ids||[]).map(String));
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(chk=>{
        chk.checked = set.has(String(chk.value));
      });
      updateSelectedCount();
    }
    function updateSelectedCount(){
      $("selEmpCount").textContent = `${getSelectedEmpIds().length} selected`;
    }

    // =========================
    // Settings
    // =========================
    function loadSettingsToUI(){
      const c = store.company || {};
      $("setCompanyName").value = c.name || "";
      $("setStreet").value = c.street || "";
      $("setCity").value = c.city || "";
      $("setPhone").value = c.phone || "";
      $("setEmail").value = c.email || "";
      $("setTax").value = c.tax || "";
      $("setFooterNote").value = c.footerNote || "";
      $("setDefaultType").value = c.defaultType || "";
    }

    function saveSettingsFromUI(){
      store.company = store.company || {};
      store.company.name = $("setCompanyName").value.trim() || "Security";
      store.company.street = $("setStreet").value.trim();
      store.company.city = $("setCity").value.trim();
      store.company.phone = $("setPhone").value.trim();
      store.company.email = $("setEmail").value.trim();
      store.company.tax = $("setTax").value.trim();
      store.company.footerNote = $("setFooterNote").value.trim() ||
        "Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.";
      store.company.defaultType = $("setDefaultType").value.trim();
      saveStore();
      refreshBrand();
      setSaveStatus("saved");
    }

    $("btnSaveSettings").addEventListener("click", ()=>{
      saveSettingsFromUI();
      alert("Settings saved ✅");
    });

    $("btnResetSettings").addEventListener("click", ()=>{
      if(!confirm("Reset company settings?")) return;
      store.company = defaultStore().company;
      saveStore();
      loadSettingsToUI();
      refreshBrand();
    });

    ["setCompanyName","setStreet","setCity","setPhone","setEmail","setTax","setFooterNote","setDefaultType"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        clearTimeout(saveTimer);
        setSaveStatus("saving");
        saveTimer = setTimeout(()=>{ saveSettingsFromUI(); }, 300);
      });
    });

    // =========================
    // Render lists
    // =========================
    let selectedEinsatzId = null;

    function renderEmployees(){
      const box = $("empList");
      box.innerHTML = "";
      if(store.employees.length===0){
        box.innerHTML = `<div class="muted small">No Mitarbeiter yet.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(emp.name)}</b>
              <div class="meta">
                ${emp.bewacher ? `Bewacher-ID: ${escapeHtml(emp.bewacher)}` : "Bewacher-ID: —"}
                ${emp.role ? ` • ${escapeHtml(emp.role)}`:""}
                ${emp.phone ? ` • ${escapeHtml(emp.phone)}`:""}
              </div>
            </div>
            <div class="right">
              <span class="pill">Mitarbeiter</span>
              <button class="linkbtn" data-del-emp="${emp.id}" type="button">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }

      const pick = $("empPickList");
      pick.innerHTML = "";
      if(store.employees.length===0){
        pick.innerHTML = `<div class="muted small">No Mitarbeiter to select.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const row = document.createElement("div");
          row.className="pickRow";
          row.innerHTML = `
            <div class="pickLeft">
              <input class="chk" type="checkbox" data-emp-chk="1" value="${emp.id}">
              <div>
                <div class="pickName">${escapeHtml(emp.name)}</div>
                <div class="pickMeta">
                  ${emp.bewacher ? `Bewacher-ID: ${escapeHtml(emp.bewacher)}` : "Bewacher-ID: —"}
                  ${emp.role ? ` • ${escapeHtml(emp.role)}`:""}
                </div>
              </div>
            </div>
            <div class="pill">Select</div>
          `;
          pick.appendChild(row);
        });

        pick.querySelectorAll('input[data-emp-chk="1"]').forEach(chk=>{
          chk.addEventListener("change", ()=>{
            updateSelectedCount();
            queueAutoSave();
          });
        });
      }
      updateSelectedCount();
    }

    function renderObjects(){
      const box = $("objList");
      box.innerHTML = "";
      if(store.objects.length===0){
        box.innerHTML = `<div class="muted small">No Objekt yet.</div>`;
      }else{
        store.objects.forEach(obj=>{
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(obj.cust)} — ${escapeHtml(obj.obj)}</b>
              <div class="meta">${escapeHtml(obj.type)} • ${escapeHtml(obj.addr)}</div>
            </div>
            <div class="right">
              <span class="pill">Objekt</span>
              <button class="linkbtn" data-del-obj="${obj.id}" type="button">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }

      const sel = $("selObj");
      sel.innerHTML = "";
      if(store.objects.length===0){
        sel.innerHTML = `<option value="">— no Objekt —</option>`;
      }else{
        store.objects.forEach(obj=>{
          const opt = document.createElement("option");
          opt.value = obj.id;
          opt.textContent = `${obj.cust} — ${obj.obj}`;
          sel.appendChild(opt);
        });
      }
    }

    function renderEinsaetze(){
      const box = $("einsatzList");
      box.innerHTML = "";
      if(store.einsaetze.length===0){
        box.innerHTML = `<div class="muted small">No Einsätze saved yet.</div>`;
        return;
      }
      store.einsaetze.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).forEach(ein=>{
        const obj = store.objects.find(x=>x.id===ein.objId);
        const empNames = (ein.empIds||[]).map(id => store.employees.find(e=>e.id===id)?.name || "(missing)").join(", ");
        const title = `${empNames || "(no Mitarbeiter)"} • ${obj?obj.obj:"(missing Objekt)"}`;
        const meta = `${ein.date} • ${ein.start}–${ein.end} • ${obj?obj.cust:""} • ${obj?obj.addr:""}`;
        const active = selectedEinsatzId === ein.id;
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div>
            <b>${escapeHtml(title)} ${active ? "✓" : ""}</b>
            <div class="meta">${escapeHtml(meta)}</div>
          </div>
          <div class="right">
            <span class="pill">${ein.type || "Einsatz"}</span>
            <button class="linkbtn" data-pick-ein="${ein.id}" type="button">${active ? "Selected" : "Select"}</button>
          </div>
        `;
        box.appendChild(div);
      });
    }

    function renderAll(){
      renderEmployees();
      renderObjects();
      renderEinsaetze();
      applyLogo();
      applyLogoPos();
      applyLogoPositionUI();
      refreshBrand();
      loadSettingsToUI();
    }

    // =========================
    // Signature
    // =========================
    function setupSignature(canvasId, clearBtnId, storeKey){
      const canvas = $(canvasId);
      const ctx = canvas.getContext("2d", { willReadFrequently:true });

      function resizeCanvasToDisplaySize(){
        const rect = canvas.getBoundingClientRect();
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const newW = Math.floor(rect.width * dpr);
        const newH = Math.floor(rect.height * dpr);

        if(canvas.width !== newW || canvas.height !== newH){
          const old = document.createElement("canvas");
          old.width = canvas.width;
          old.height = canvas.height;
          old.getContext("2d").drawImage(canvas, 0, 0);

          canvas.width = newW;
          canvas.height = newH;

          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr, dpr);

          ctx.clearRect(0,0,rect.width,rect.height);
          if(old.width && old.height){
            ctx.drawImage(old, 0, 0, old.width, old.height, 0, 0, rect.width, rect.height);
          }
        }else{
          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr, dpr);
        }
      }

      function getPos(ev){
        const rect = canvas.getBoundingClientRect();
        const t = ev.touches && ev.touches[0] ? ev.touches[0] : null;
        const x = (t ? t.clientX : ev.clientX) - rect.left;
        const y = (t ? t.clientY : ev.clientY) - rect.top;
        return {x,y};
      }

      function drawLine(a,b){
        ctx.lineWidth = 2.6;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "rgba(255,255,255,.95)";
        ctx.beginPath();
        ctx.moveTo(a.x,a.y);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
      }

      function saveSignatureImage(){
        try{
          const dataUrl = canvas.toDataURL("image/png");
          store[storeKey] = dataUrl;
          saveStore();
          setSaveStatus("saved");
        }catch{
          setSaveStatus("error");
        }
      }

      let drawing=false, last=null;

      function start(ev){
        resizeCanvasToDisplaySize();
        drawing = true;
        last = getPos(ev);
      }
      function move(ev){
        if(!drawing) return;
        ev.preventDefault();
        const p = getPos(ev);
        drawLine(last,p);
        last=p;
        setSaveStatus("saving");
      }
      function end(){
        if(!drawing) return;
        drawing=false; last=null;
        saveSignatureImage();
      }

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);

      canvas.addEventListener("touchstart", start, {passive:false});
      canvas.addEventListener("touchmove", move, {passive:false});
      canvas.addEventListener("touchend", end, {passive:false});

      $(clearBtnId).addEventListener("click", ()=>{
        resizeCanvasToDisplaySize();
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0,0,rect.width,rect.height);
        store[storeKey] = null;
        saveStore();
        setSaveStatus("saved");
      });

      function restore(){
        resizeCanvasToDisplaySize();
        const dataUrl = store[storeKey];
        if(!dataUrl) return;
        const img = new Image();
        img.onload = ()=>{
          const rect = canvas.getBoundingClientRect();
          ctx.clearRect(0,0,rect.width,rect.height);
          ctx.drawImage(img, 0, 0, rect.width, rect.height);
        };
        img.src = dataUrl;
      }

      window.addEventListener("resize", ()=>{
        const saved = store[storeKey];
        resizeCanvasToDisplaySize();
        if(saved) restore();
      });

      resizeCanvasToDisplaySize();
      return { restore };
    }

    const sigEmp = setupSignature("sigCanvasEmp","btnSigClearEmp","sigEmpDataUrl");
    const sigAg  = setupSignature("sigCanvasAg","btnSigClearAg","sigAgDataUrl");

    // =========================
    // CRUD Mitarbeiter
    // =========================
    $("btnAddEmp").addEventListener("click", ()=>{
      const name = $("empName").value.trim();
      if(!name) return alert("Bitte Name eingeben.");
      store.employees.push({
        id: uid(),
        name,
        bewacher: $("empBewacher").value.trim(),
        phone: $("empPhone").value.trim(),
        role: $("empRole").value.trim()
      });
      saveStore();
      renderAll();
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      queueAutoSave();
    });

    $("btnClearEmp").addEventListener("click", ()=>{
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      queueAutoSave();
    });

    $("empList").addEventListener("click",(e)=>{
      const id = e.target?.getAttribute?.("data-del-emp");
      if(!id) return;
      if(!confirm("Delete Mitarbeiter?")) return;
      store.employees = store.employees.filter(x=>x.id!==id);
      saveStore();
      renderAll();
      queueAutoSave();
    });

    // =========================
    // CRUD Objekt
    // =========================
    $("btnSaveObj").addEventListener("click", ()=>{
      const cust = $("custName").value.trim();
      const obj  = $("objName").value.trim();
      const addr = $("objAddr").value.trim();
      const type = $("objType").value;
      if(!cust || !obj || !addr) return alert("Bitte Kunde, Objektname, Adresse ausfüllen.");
      store.objects.push({ id: uid(), cust, obj, addr, type });
      saveStore();
      renderAll();
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      queueAutoSave();
    });

    $("btnClearObj").addEventListener("click", ()=>{
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      queueAutoSave();
    });

    $("objList").addEventListener("click",(e)=>{
      const id = e.target?.getAttribute?.("data-del-obj");
      if(!id) return;
      if(!confirm("Delete Objekt?")) return;
      store.objects = store.objects.filter(x=>x.id!==id);
      saveStore();
      renderAll();
      queueAutoSave();
    });

    // =========================
    // Einsätze
    // =========================
    $("btnEmpSelectAll").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(c=>c.checked=true);
      updateSelectedCount();
      queueAutoSave();
    });
    $("btnEmpClearAll").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(c=>c.checked=false);
      updateSelectedCount();
      queueAutoSave();
    });

    $("btnCreate").addEventListener("click", ()=>{
      const objId = $("selObj").value;
      const empIds = getSelectedEmpIds();
      const date = $("shiftDate").value;
      const start = $("shiftStart").value;
      const end = $("shiftEnd").value;

      if(!objId) return alert("Objekt wählen.");
      if(empIds.length===0) return alert("Mindestens 1 Mitarbeiter auswählen.");
      if(!date || !start || !end) return alert("Datum/Start/Ende ausfüllen.");

      const obj = store.objects.find(x=>x.id===objId);
      const fallbackType = (store.company?.defaultType || "").trim();

      store.einsaetze.push({
        id: uid(),
        objId,
        empIds,
        date, start, end,
        type: obj?.type || fallbackType || "Einsatz",
        sigEmpDataUrl: store.sigEmpDataUrl || null,
        sigAgDataUrl: store.sigAgDataUrl || null,
        createdAt: Date.now()
      });

      saveStore();
      renderEinsaetze();
      alert("Einsatz saved ✅");
    });

    $("einsatzList").addEventListener("click",(e)=>{
      const pick = e.target?.getAttribute?.("data-pick-ein");
      if(!pick) return;
      selectedEinsatzId = pick;
      renderEinsaetze();
    });

    $("btnDelete").addEventListener("click", ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      if(!confirm("Delete selected Einsatz?")) return;
      store.einsaetze = store.einsaetze.filter(x=>x.id!==selectedEinsatzId);
      selectedEinsatzId = null;
      saveStore();
      renderEinsaetze();
    });

    // =========================
    // Backup / Restore (Full)
    // =========================
    function downloadText(filename, text, mime="text/plain"){
      const blob = new Blob([text], {type:mime});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $("btnBackup").addEventListener("click", ()=>{
      const payload = { store, draft: collectDraft() };
      downloadText("einsatzmeldung-backup-full.json", JSON.stringify(payload, null, 2), "application/json");
    });

    $("btnRestore").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type="file";
      input.accept="application/json";
      input.onchange = ()=>{
        const file = input.files?.[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          const payload = safeParse(String(r.result||""), null);
          if(!payload || typeof payload !== "object"){ alert("Invalid backup."); return; }
          if(payload.store) store = payload.store;
          saveStore();
          if(payload.draft) localStorage.setItem(DRAFT_KEY, JSON.stringify(payload.draft));
          renderAll();
          restoreDraftToUI();
          sigEmp.restore(); sigAg.restore();
          alert("Restore done ✅");
        };
        r.readAsText(file);
      };
      input.click();
    });

    // =========================
    // Range Export/Import (maalmo ka hor)
    // =========================
    function ymdToNum(ymd){
      if(!ymd) return null;
      const s = ymd.replaceAll("-","");
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function getEinsaetzeInRange(fromYmd, toYmd){
      const fromN = ymdToNum(fromYmd);
      const toN   = ymdToNum(toYmd);
      if(!fromN && !toN) return store.einsaetze.slice();
      return store.einsaetze.filter(e=>{
        const d = ymdToNum(e.date);
        if(!d) return false;
        if(fromN && d < fromN) return false;
        if(toN && d > toN) return false;
        return true;
      });
    }

    function resolveObj(objId){ return store.objects.find(o=>o.id===objId) || null; }
    function resolveEmp(empId){ return store.employees.find(e=>e.id===empId) || null; }

    function csvEscape(v){
      const s = String(v ?? "");
      return `"${s.replaceAll('"','""')}"`;
    }

    $("btnExportRangeJson").addEventListener("click", ()=>{
      const from = $("expFrom").value;
      const to   = $("expTo").value;
      const items = getEinsaetzeInRange(from,to);
      if(items.length===0) return alert("No Einsätze in this range.");

      const payload = {
        exportedAt: new Date().toISOString(),
        range: {from: from||null, to: to||null},
        company: store.company || null,
        logoDataUrl: store.logoDataUrl || null,
        logoPosition: store.logoPosition || "left",
        logoPositionApp: store.logoPositionApp || "left",
        employees: store.employees || [],
        objects: store.objects || [],
        einsaetze: items || []
      };

      const name = `einsatz-export-${from||"all"}-to-${to||"all"}.json`;
      downloadText(name, JSON.stringify(payload, null, 2), "application/json");
    });

    $("btnExportRangeCsv").addEventListener("click", ()=>{
      const from = $("expFrom").value;
      const to   = $("expTo").value;
      const items = getEinsaetzeInRange(from,to);
      if(items.length===0) return alert("No Einsätze in this range.");

      const header = [
        "Datum","Start","Ende","Typ",
        "Kunde","Objekt","Adresse","Objekt-Typ",
        "Mitarbeiter Name","Bewacher-ID","Position","Telefon"
      ].map(csvEscape).join(",");

      const rows = [header];

      items.forEach(e=>{
        const obj = resolveObj(e.objId);
        const kunde = obj?.cust || "";
        const objekt = obj?.obj || "";
        const addr = obj?.addr || "";
        const otype = obj?.type || e.type || "";
        const empIds = e.empIds || [];

        if(empIds.length===0){
          rows.push([
            e.date||"", e.start||"", e.end||"", e.type||"",
            kunde,objekt,addr,otype,
            "", "", "", ""
          ].map(csvEscape).join(","));
          return;
        }

        empIds.forEach(empId=>{
          const emp = resolveEmp(empId);
          rows.push([
            e.date||"", e.start||"", e.end||"", e.type||"",
            kunde,objekt,addr,otype,
            emp?.name||"", emp?.bewacher||"", emp?.role||"", emp?.phone||""
          ].map(csvEscape).join(","));
        });
      });

      const name = `einsatz-export-${from||"all"}-to-${to||"all"}.csv`;
      downloadText(name, rows.join("\n"), "text/csv;charset=utf-8");
    });

    // ✅ Import JSON (merge or replace)
    $("btnImportRangeJson").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type="file";
      input.accept="application/json";
      input.onchange = ()=>{
        const file = input.files?.[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          const payload = safeParse(String(r.result||""), null);
          if(!payload || typeof payload !== "object") return alert("Invalid JSON.");

          const incomingEmployees = Array.isArray(payload.employees) ? payload.employees : [];
          const incomingObjects   = Array.isArray(payload.objects) ? payload.objects : [];
          const incomingEinsaetze = Array.isArray(payload.einsaetze) ? payload.einsaetze : [];

          if(incomingEinsaetze.length===0) return alert("No Einsätze inside JSON.");

          const mode = confirm("OK = MERGE (keep existing)\nCancel = REPLACE (overwrite all)");
          if(!mode){
            // REPLACE
            store = defaultStore();
          }

          // keep company/logo if payload has them
          if(payload.company) store.company = { ...store.company, ...payload.company };
          if(payload.logoDataUrl) store.logoDataUrl = payload.logoDataUrl;
          if(payload.logoPosition) store.logoPosition = payload.logoPosition;
          if(payload.logoPositionApp) store.logoPositionApp = payload.logoPositionApp;

          // MERGE employees/objects by id (no duplicates)
          const empMap = new Map((store.employees||[]).map(e=>[String(e.id), e]));
          incomingEmployees.forEach(e=>{
            if(e && e.id) empMap.set(String(e.id), e);
          });
          store.employees = Array.from(empMap.values());

          const objMap = new Map((store.objects||[]).map(o=>[String(o.id), o]));
          incomingObjects.forEach(o=>{
            if(o && o.id) objMap.set(String(o.id), o);
          });
          store.objects = Array.from(objMap.values());

          // MERGE einsaetze by id
          const einMap = new Map((store.einsaetze||[]).map(x=>[String(x.id), x]));
          incomingEinsaetze.forEach(x=>{
            if(x && x.id) einMap.set(String(x.id), x);
          });
          store.einsaetze = Array.from(einMap.values());

          saveStore();
          renderAll();
          sigEmp.restore(); sigAg.restore();
          alert("Import done ✅");
        };
        r.readAsText(file);
      };
      input.click();
    });

    // =========================
    // PDF
    // =========================
    function formatDateISOToDE(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      if(!y||!m||!d) return iso;
      return `${d}.${m}.${y}`;
    }
    function companyAddressLine(c){
      const street = (c.street||"").trim();
      const city = (c.city||"").trim();
      return [street, city].filter(Boolean).join(", ");
    }
    function waitForImagesThenPrint(){
      const imgs = Array.from(document.images || []);
      if(imgs.length === 0){ window.print(); return; }
      let done = 0;
      const finish = () => {
        done++;
        if(done >= imgs.length) setTimeout(()=>window.print(), 250);
      };
      imgs.forEach(img=>{
        if(img.complete) finish();
        else { img.onload = finish; img.onerror = finish; }
      });
      setTimeout(()=>window.print(), 1200);
    }
    function warnIfNoLogoForPdf(){
      const logoPos = store.logoPosition || "left";
      const showLogo = (logoPos !== "hide") && !!store.logoDataUrl;
      if(logoPos !== "hide" && !showLogo){
        alert("Logo ma jiro (PDF). Fadlan ‘Logo PNG’ upload garee, kadib Generate PDF.");
      }
    }

    async function generatePdfForEinsatz(ein){
      warnIfNoLogoForPdf();

      const obj = store.objects.find(x=>x.id===ein.objId);
      const c = store.company || {};

      const logo = store.logoDataUrl || null;
      const logoPos = store.logoPosition || "left";
      const showLogo = (logoPos !== "hide") && !!logo;

      const logoHTML = showLogo ? `
        <div class="logoBox"><img class="logo" src="${logo}" alt="Logo"/></div>
      ` : ``;

      const headerHTML = (()=>{
        if(!showLogo){
          return `
            <div class="head">
              <div class="leftHead">
                <div>
                  <h1>Einsatzmeldung</h1>
                  <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c) || "")}</div>
                  <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                  ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                </div>
              </div>
              <div style="text-align:right;">
                <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>
          `;
        }

        if(logoPos === "top"){
          return `
            <div class="headTop">
              ${logoHTML}
              <div class="head">
                <div class="leftHead">
                  <div>
                    <h1>Einsatzmeldung</h1>
                    <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c) || "")}</div>
                    <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                    ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                  </div>
                </div>
                <div style="text-align:right;">
                  <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                  <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
                </div>
              </div>
            </div>
          `;
        }

        if(logoPos === "right"){
          return `
            <div class="head">
              <div class="leftHead">
                <div>
                  <h1>Einsatzmeldung</h1>
                  <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c) || "")}</div>
                  <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                  ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                </div>
              </div>
              <div style="text-align:right; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                ${logoHTML}
                <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>
          `;
        }

        return `
          <div class="head">
            <div class="leftHead">
              ${logoHTML}
              <div>
                <h1>Einsatzmeldung</h1>
                <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c) || "")}</div>
                <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
              <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
            </div>
          </div>
        `;
      })();

      const employees = (ein.empIds||[]).map(id => store.employees.find(e=>e.id===id)).filter(Boolean);

      const empRows = employees.length
        ? employees.map((e, idx)=>`
          <tr>
            <td style="padding:6px 8px; border:1px solid #111;">${idx+1}</td>
            <td style="padding:6px 8px; border:1px solid #111;"><b>${escapeHtml(e.name)}</b></td>
            <td style="padding:6px 8px; border:1px solid #111;">${escapeHtml(e.bewacher || "—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">${escapeHtml(e.role || "—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">
              <div style="height:26px; border:1px solid #111; border-radius:6px;"></div>
            </td>
          </tr>
        `).join("")
        : `<tr><td colspan="5" style="padding:8px; border:1px solid #111;">—</td></tr>`;

      const sigAgImg  = ein.sigAgDataUrl  || store.sigAgDataUrl  || null;

      const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Einsatzmeldung ${formatDateISOToDE(ein.date)}</title>
  <style>
    @page { size: A4; margin: 18mm; }
    body { font-family: Arial, sans-serif; color:#111; }

    .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .leftHead{ display:flex; gap:12px; align-items:center; }
    .headTop{ display:flex; flex-direction:column; gap:10px; }

    .logoBox{
      width:64px; height:64px;
      border:1px solid #111;
      border-radius:10px;
      padding:6px;
      background:#fff;
      display:flex; align-items:center; justify-content:center;
    }
    .logo{ width:100%; height:100%; object-fit:contain; display:block; }

    h1 { margin:0; font-size:18px; }
    .sub { color:#444; margin-top:4px; font-size:12px; }
    .box { border:1px solid #111; border-radius:10px; padding:12px; margin-top:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .label { font-size:11px; color:#333; margin-bottom:4px; }
    .val { font-size:12px; font-weight:700; }
    .line { height:1px; background:#111; opacity:.18; margin:12px 0; }
    .sigimg { max-height:70px; max-width:100%; display:block; }
    .foot { margin-top:10px; font-size:10px; color:#333; }
    a { color:#111; text-decoration:none; }
    table{ border-collapse:collapse; width:100%; font-size:12px; }
    th{ text-align:left; padding:6px 8px; border:1px solid #111; background:#f2f2f2; }
  </style>
</head>
<body>
  ${headerHTML}

  <div class="box">
    <div class="grid">
      <div>
        <div class="label">Kunde / Objekt</div>
        <div class="val">${escapeHtml(obj?.cust || "—")} — ${escapeHtml(obj?.obj || "—")}</div>
        <div class="sub">Adresse: ${escapeHtml(obj?.addr || "—")}</div>
      </div>
      <div>
        <div class="label">Schichtzeit</div>
        <div class="val">${escapeHtml(ein.start)} – ${escapeHtml(ein.end)}</div>
      </div>
    </div>

    <div class="line"></div>

    <div class="label">Mitarbeiter (Liste)</div>
    <table>
      <thead>
        <tr>
          <th style="width:44px;">#</th>
          <th>Name</th>
          <th style="width:160px;">Bewacher-ID</th>
          <th style="width:140px;">Position</th>
          <th style="width:190px;">Unterschrift Mitarbeiter</th>
        </tr>
      </thead>
      <tbody>${empRows}</tbody>
    </table>

    <div style="margin-top:14px; display:flex; justify-content:space-between; gap:12px; align-items:flex-end;">
      <div style="flex:1;">
        <div class="label">Unterschrift Arbeitgeber / Auftraggeber</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          ${sigAgImg ? `<img class="sigimg" src="${sigAgImg}" alt="Signature Arbeitgeber"/>` : `<div class="sub">—</div>`}
        </div>
      </div>
      <div style="width:240px;">
        <div class="label">Ort / Datum</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          <div style="height:20px;"></div>
          <div style="border-top:1px solid #111; margin-top:26px;"></div>
        </div>
      </div>
    </div>

    <div class="foot">${escapeHtml(c.footerNote || "")}</div>
  </div>

  <script>
    window.onload = () => (${waitForImagesThenPrint.toString()})() ;
  <\/script>
</body>
</html>`;

      const w = window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups to print PDF.");
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    $("btnPDF").addEventListener("click", async ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      const ein = store.einsaetze.find(x=>x.id===selectedEinsatzId);
      if(!ein) return alert("Einsatz not found.");
      await generatePdfForEinsatz(ein);
    });

    // =========================
    // Draft restore
    // =========================
    function restoreDraftToUI(){
      const d = safeParse(localStorage.getItem(DRAFT_KEY), null) || {};
      if(typeof d !== "object" || !d) return;

      $("empName").value = d.empName || "";
      $("empBewacher").value = d.empBewacher || "";
      $("empPhone").value = d.empPhone || "";
      $("empRole").value = d.empRole || "";

      $("custName").value = d.custName || "";
      $("objName").value = d.objName || "";
      $("objAddr").value = d.objAddr || "";
      $("objType").value = d.objType || "Hotel";

      if(d.shiftDate) $("shiftDate").value = d.shiftDate;
      if(d.shiftStart) $("shiftStart").value = d.shiftStart;
      if(d.shiftEnd) $("shiftEnd").value = d.shiftEnd;

      if(d.expFrom) $("expFrom").value = d.expFrom;
      if(d.expTo) $("expTo").value = d.expTo;

      if(d.logoPosition) $("logoPos").value = d.logoPosition;
      if(d.logoPositionApp) $("logoPosApp").value = d.logoPositionApp;
      if(d.selObj) $("selObj").value = d.selObj;

      setSelectedEmpIds(d.selectedEmpIds || []);
      updateSelectedCount();
    }

    // auto-save bindings
    const autosaveIds = [
      "empName","empBewacher","empPhone","empRole",
      "custName","objName","objAddr","objType",
      "selObj","shiftDate","shiftStart","shiftEnd",
      "expFrom","expTo",
      "logoPos","logoPosApp"
    ];
    autosaveIds.forEach(id=>{
      const el = $(id);
      el.addEventListener("input", queueAutoSave);
      el.addEventListener("change", queueAutoSave);
    });

    // =========================
    // Init defaults
    // =========================
    function initExportDefaults(){
      const today = new Date();
      const to = today.toISOString().slice(0,10);
      const past = new Date(today.getTime() - 7*24*60*60*1000);
      const from = past.toISOString().slice(0,10);
      if(!$("expTo").value) $("expTo").value = to;
      if(!$("expFrom").value) $("expFrom").value = from;
    }

    (function init(){
      renderAll();

      const hasDraft = !!localStorage.getItem(DRAFT_KEY);
      if(!hasDraft){
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,"0");
        const dd = String(now.getDate()).padStart(2,"0");
        $("shiftDate").value = `${yyyy}-${mm}-${dd}`;
        $("shiftStart").value = "18:00";
        $("shiftEnd").value = "06:00";
        initExportDefaults();
      }

      restoreDraftToUI();
      if(!$("expFrom").value || !$("expTo").value) initExportDefaults();

      applyLogoPos();
      applyLogoPositionUI();
      sigEmp.restore();
      sigAg.restore();

      setSaveStatus("saved");
      showTab("app");
    })();
  </script>
</body>
</html>
