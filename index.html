<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Einsatzmeldung (All-in-One)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --bg:#071225;
      --panel:#0b1a33;
      --panel2:#0c2242;
      --card:#0f2a4f;
      --line:#16345e;
      --text:#e7f0ff;
      --muted:#9bb1d5;
      --accent:#3aa6ff;
      --danger:#ff4d6d;
      --good:#21d19f;
      --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(33,209,159,.12), transparent 55%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg, rgba(11,26,51,.92), rgba(7,18,37,.78));
      border-bottom:1px solid rgba(22,52,94,.7);
      backdrop-filter: blur(10px);
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .logo{
      width:44px; height:44px; border-radius:12px;
      object-fit:contain; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:none;
    }
    .brandName{font-weight:800; letter-spacing:.2px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}

    .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .wrap{max-width:1220px; margin:18px auto; padding:0 16px}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    .card{
      background:linear-gradient(180deg, rgba(15,42,79,.92), rgba(11,26,51,.85));
      border:1px solid rgba(22,52,94,.8);
      border-radius:var(--r);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      padding:14px;
    }
    .card h2{margin:0 0 6px 0; font-size:18px}
    .muted{color:var(--muted); margin:0 0 12px 0}
    .small{font-size:12px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px}
    .tab{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    .tab.active{
      background:rgba(58,166,255,.16);
      border-color:rgba(58,166,255,.28);
    }

    .row{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .row.actions{display:flex; gap:10px; flex-wrap:wrap}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
      resize:vertical;
    }
    textarea{min-height:84px}
    input:focus, select:focus, textarea:focus{border-color:rgba(58,166,255,.9); box-shadow:0 0 0 3px rgba(58,166,255,.15)}
    .btn{
      border:0;
      padding:10px 12px;
      border-radius:14px;
      color:#061226;
      background:var(--accent);
      font-weight:800;
      cursor:pointer;
    }
    .btn.ghost{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
    }
    .btn.danger{
      background:rgba(255,77,109,.18);
      color:#ffd7de;
      border:1px solid rgba(255,77,109,.35);
    }
    .btn:hover{filter:brightness(1.05)}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(7,18,37,.45);
      border:1px solid rgba(22,52,94,.7);
    }
    .item b{display:block}
    .item .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .item .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(58,166,255,.12);
      border:1px solid rgba(58,166,255,.22);
      color:var(--text);
    }
    .linkbtn{
      background:transparent; border:1px solid rgba(255,255,255,.14);
      color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer;
    }
    .linkbtn:hover{background:rgba(255,255,255,.06)}
    .sigBox{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(7,18,37,.35);
      border-radius:16px;
      padding:10px;
    }
    canvas{
      width:100%;
      height:160px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      touch-action:none;
    }
    .sigActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .span2{grid-column: 1 / span 2}
    .foot{padding:14px 2px 22px}
    code{background:rgba(255,255,255,.06); padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.10)}
    .doc{
      line-height:1.5;
      color:var(--text);
    }
    .doc h3{margin:12px 0 6px}
    .doc ul{margin:6px 0 10px; padding-left:18px}
    .note{
      border:1px solid rgba(33,209,159,.25);
      background:rgba(33,209,159,.08);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      color:#dbfff5;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .row{grid-template-columns:1fr}
      .brand{min-width:unset}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="logo" id="logoImg" alt="Masculine Security Logo"/>
      <div class="brandText">
        <div class="brandName">Masculine Security</div>
        <div class="brandSub">Einsatzmeldung • PDF • Signatur • Offline (All-in-One HTML)</div>
      </div>
    </div>

    <div class="topActions">
      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px">
        Logo PNG
        <input id="logoFile" type="file" accept="image/png" style="display:none">
      </label>
      <button class="btn ghost" id="btnClearLogo" title="Remove stored logo">Remove Logo</button>

      <button class="btn ghost" id="btnBackup">Backup</button>
      <button class="btn ghost" id="btnRestore">Restore</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="app">App</button>
      <button class="tab" data-tab="doc">Documentation</button>
    </div>

    <!-- APP -->
    <section id="tab-app">
      <section class="grid">
        <!-- Mitarbeiter -->
        <div class="card">
          <h2>Mitarbeiter</h2>
          <p class="muted">Ku dar shaqaalaha (Bewacher-ID optional).</p>

          <div class="row">
            <div class="field">
              <label>Vorname & Nachname</label>
              <input id="empName" placeholder="z.B. Ahmed Ali" />
            </div>
            <div class="field">
              <label>Bewacher-ID (optional)</label>
              <input id="empBewacher" placeholder="z.B. HB-123456" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Telefon (optional)</label>
              <input id="empPhone" placeholder="z.B. 0157..." />
            </div>
            <div class="field">
              <label>Position (optional)</label>
              <input id="empRole" placeholder="z.B. Wachmann" />
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnAddEmp">Add Mitarbeiter</button>
            <button class="btn danger" id="btnClearEmp">Clear</button>
          </div>

          <div class="list" id="empList"></div>
        </div>

        <!-- Kunde/Objekt -->
        <div class="card">
          <h2>Kunde & Objekt</h2>
          <p class="muted">Ku kaydi Kunde/Objekt (hotel/baustelle/event...).</p>

          <div class="row">
            <div class="field">
              <label>Kunde (Firma/Name)</label>
              <input id="custName" placeholder="z.B. Hotel Bremen GmbH" />
            </div>
            <div class="field">
              <label>Objektname</label>
              <input id="objName" placeholder="z.B. Eingang / Lobby" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Einsatzort (Adresse)</label>
              <input id="objAddr" placeholder="Straße, PLZ Ort" />
            </div>
            <div class="field">
              <label>Objekt-Typ</label>
              <select id="objType">
                <option value="Hotel">Hotel</option>
                <option value="Baustelle">Baustelle</option>
                <option value="Event">Event</option>
                <option value="Asylheim">Asylheim</option>
                <option value="Nachtwache">Nachtwache</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnSaveObj">Save Objekt</button>
            <button class="btn danger" id="btnClearObj">Clear</button>
          </div>

          <div class="list" id="objList"></div>
        </div>

        <!-- Einsatzmeldung -->
        <div class="card span2">
          <h2>Einsatzmeldung erstellen</h2>
          <p class="muted">Doorta Mitarbeiter + Objekt, geli shift, kadib PDF.</p>

          <div class="row">
            <div class="field">
              <label>Mitarbeiter wählen</label>
              <select id="selEmp"></select>
            </div>
            <div class="field">
              <label>Objekt wählen</label>
              <select id="selObj"></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Datum</label>
              <input id="shiftDate" type="date"/>
            </div>
            <div class="field">
              <label>Start</label>
              <input id="shiftStart" type="time"/>
            </div>
            <div class="field">
              <label>Ende</label>
              <input id="shiftEnd" type="time"/>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Tätigkeit / Bemerkung (optional)</label>
              <input id="shiftNote" placeholder="z.B. Kontrollgänge, Eingangskontrolle..." />
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Unterschrift Mitarbeiter (draw)</label>
              <div class="sigBox">
                <canvas id="sigCanvas" width="900" height="240"></canvas>
                <div class="sigActions">
                  <button class="btn ghost" id="btnSigClear">Clear signature</button>
                  <button class="btn ghost" id="btnSigSave">Save signature</button>
                </div>
                <div class="muted small">Tip: mobile ku sawir finger, desktop ku sawir mouse.</div>
              </div>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnCreate">Save Einsatz</button>
            <button class="btn" id="btnPDF">Generate PDF</button>
            <button class="btn danger" id="btnDelete">Delete selected Einsatz</button>
          </div>

          <div class="list" id="einsatzList"></div>

          <div class="note small">
            ✅ Logo: “Logo PNG” ku upload garee (PNG kaliya). Logo + signature waxay galaan PDF.
          </div>
        </div>
      </section>

      <footer class="foot">
        <div class="muted small">
          Data waa local (browser). Backup/Restore isticmaal. PDF: browser print → “Save as PDF”.
        </div>
      </footer>
    </section>

    <!-- DOCUMENTATION -->
    <section id="tab-doc" style="display:none">
      <div class="card">
        <h2>Documentation</h2>
        <p class="muted">Buugga isticmaalka (Somali + German terms).</p>

        <div class="doc">
          <h3>1) Maxay app-kan qabanayaa?</h3>
          <ul>
            <li>Ku kaydi <b>Mitarbeiter</b> (shaqaale) + Bewacher-ID (optional)</li>
            <li>Ku kaydi <b>Kunde/Objekt</b> (hotel/baustelle/event…)</li>
            <li>Samee <b>Einsatz</b> (date + start/end + note)</li>
            <li>Ku dar <b>Unterschrift</b> (signature)</li>
            <li>Ka saar <b>PDF Einsatzmeldung</b> (print-to-PDF)</li>
            <li>Logo PNG: upload → app + PDF labadaba</li>
          </ul>

          <h3>2) Workflow (sida saxda ah)</h3>
          <ul>
            <li><b>Mitarbeiter</b> → buuxi → “Add Mitarbeiter”</li>
            <li><b>Kunde & Objekt</b> → buuxi → “Save Objekt”</li>
            <li><b>Einsatz</b> → dooro Mitarbeiter + Objekt → geli date/time → “Save Einsatz”</li>
            <li>“Select” Einsatz-ka list-ka</li>
            <li>“Generate PDF” → print dialog → dooro “Save as PDF”</li>
          </ul>

          <h3>3) Backup & Restore</h3>
          <ul>
            <li><b>Backup</b> → wuxuu soo dejinayaa JSON (xogta oo dhan)</li>
            <li><b>Restore</b> → upload JSON si data u soo laabato</li>
          </ul>

          <h3>4) Important (Prüfung/Control)</h3>
          <ul>
            <li>PDF Einsatzmeldung + Signature waa “proof” fiican (Zoll/BG/Kunde audit)</li>
            <li>App-kan waa “Einsatznachweis” (ma aha payroll system)</li>
          </ul>

          <h3>5) Company data (PDF gudaha)</h3>
          <ul>
            <li>Masculine Security</li>
            <li>Werschenregerstraße 6, 28237 Bremen</li>
            <li>Tel: 015778697052</li>
            <li>E-Mail: <a href="mailto:Kontakt.mass.bremen@hotmail.com" style="color:#9fd0ff; font-weight:800; text-decoration:none">Kontakt.mass.bremen@hotmail.com</a></li>
          </ul>

          <div class="note">
            Haddii PDF button uu diido: browser-ka ka ogolow Popups/Print.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ========= Store =========
    const STORE_KEY = "ms_einsatzmeldung_allinone_v1";
    const $ = (id)=>document.getElementById(id);
    const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return { employees:[], objects:[], einsaetze:[], sigDataUrl:null, logoDataUrl:null };
        const data = JSON.parse(raw);
        return {
          employees: Array.isArray(data.employees) ? data.employees : [],
          objects: Array.isArray(data.objects) ? data.objects : [],
          einsaetze: Array.isArray(data.einsaetze) ? data.einsaetze : [],
          sigDataUrl: data.sigDataUrl || null,
          logoDataUrl: data.logoDataUrl || null
        };
      }catch{
        return { employees:[], objects:[], einsaetze:[], sigDataUrl:null, logoDataUrl:null };
      }
    }
    function saveStore(store){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    let store = loadStore();
    let selectedEinsatzId = null;

    // ========= Tabs =========
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.getAttribute("data-tab");
        $("tab-app").style.display = (tab==="app") ? "" : "none";
        $("tab-doc").style.display = (tab==="doc") ? "" : "none";
      });
    });

    // ========= Logo =========
    function applyLogo(){
      const img = $("logoImg");
      if(store.logoDataUrl){
        img.src = store.logoDataUrl;
        img.style.display = "block";
      }else{
        img.removeAttribute("src");
        img.style.display = "none";
      }
    }

    $("logoFile").addEventListener("change", ()=>{
      const file = $("logoFile").files?.[0];
      if(!file) return;
      if(file.type !== "image/png"){
        alert("PNG kaliya ✅ (image/png).");
        $("logoFile").value = "";
        return;
      }
      // Optional: keep logo smaller in storage by limiting size check
      const maxMB = 3;
      if(file.size > maxMB * 1024 * 1024){
        alert("Logo waa weyn yahay. Fadlan ka dhig < 3MB.");
        $("logoFile").value = "";
        return;
      }
      const fr = new FileReader();
      fr.onload = ()=>{
        store.logoDataUrl = String(fr.result || "");
        saveStore(store);
        applyLogo();
        alert("Logo saved ✅");
      };
      fr.readAsDataURL(file);
      $("logoFile").value = "";
    });

    $("btnClearLogo").addEventListener("click", ()=>{
      if(!confirm("Remove stored logo?")) return;
      store.logoDataUrl = null;
      saveStore(store);
      applyLogo();
    });

    // ========= Render =========
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderEmployees(){
      const box = $("empList");
      box.innerHTML = "";
      if(store.employees.length===0){
        box.innerHTML = `<div class="muted small">No Mitarbeiter yet.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(emp.name)}</b>
              <div class="meta">${emp.bewacher ? `Bewacher-ID: ${escapeHtml(emp.bewacher)}` : "Bewacher-ID: —"}
              ${emp.role ? ` • ${escapeHtml(emp.role)}`:""}
              ${emp.phone ? ` • ${escapeHtml(emp.phone)}`:""}</div>
            </div>
            <div class="right">
              <span class="pill">Mitarbeiter</span>
              <button class="linkbtn" data-del-emp="${emp.id}">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }
      const sel = $("selEmp");
      sel.innerHTML = "";
      if(store.employees.length===0){
        sel.innerHTML = `<option value="">— no Mitarbeiter —</option>`;
      }else{
        store.employees.forEach(emp=>{
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = emp.name + (emp.bewacher ? ` (${emp.bewacher})` : "");
          sel.appendChild(opt);
        });
      }
    }

    function renderObjects(){
      const box = $("objList");
      box.innerHTML = "";
      if(store.objects.length===0){
        box.innerHTML = `<div class="muted small">No Objekt yet.</div>`;
      }else{
        store.objects.forEach(obj=>{
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(obj.cust)} — ${escapeHtml(obj.obj)}</b>
              <div class="meta">${escapeHtml(obj.type)} • ${escapeHtml(obj.addr)}</div>
            </div>
            <div class="right">
              <span class="pill">Objekt</span>
              <button class="linkbtn" data-del-obj="${obj.id}">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }
      const sel = $("selObj");
      sel.innerHTML = "";
      if(store.objects.length===0){
        sel.innerHTML = `<option value="">— no Objekt —</option>`;
      }else{
        store.objects.forEach(obj=>{
          const opt = document.createElement("option");
          opt.value = obj.id;
          opt.textContent = `${obj.cust} — ${obj.obj}`;
          sel.appendChild(opt);
        });
      }
    }

    function renderEinsaetze(){
      const box = $("einsatzList");
      box.innerHTML = "";
      if(store.einsaetze.length===0){
        box.innerHTML = `<div class="muted small">No Einsätze saved yet.</div>`;
        return;
      }
      store.einsaetze
        .slice()
        .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0))
        .forEach(ein=>{
          const emp = store.employees.find(x=>x.id===ein.empId);
          const obj = store.objects.find(x=>x.id===ein.objId);
          const title = `${emp?emp.name:"(missing Mitarbeiter)"} • ${obj?obj.obj:"(missing Objekt)"}`;
          const meta = `${ein.date} • ${ein.start}–${ein.end} • ${obj?obj.cust:""} • ${obj?obj.addr:""}`;
          const active = (selectedEinsatzId === ein.id);
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div>
              <b>${escapeHtml(title)} ${active ? "✓" : ""}</b>
              <div class="meta">${escapeHtml(meta)}</div>
              ${ein.note ? `<div class="meta">Note: ${escapeHtml(ein.note)}</div>` : ""}
            </div>
            <div class="right">
              <span class="pill">${ein.type || "Einsatz"}</span>
              <button class="linkbtn" data-pick-ein="${ein.id}">${active ? "Selected" : "Select"}</button>
            </div>
          `;
          box.appendChild(div);
        });
    }

    function renderAll(){
      renderEmployees();
      renderObjects();
      renderEinsaetze();
      applyLogo();
    }

    // ========= CRUD: Mitarbeiter =========
    $("btnAddEmp").addEventListener("click", ()=>{
      const name = $("empName").value.trim();
      if(!name) return alert("Bitte Name eingeben.");
      const emp = {
        id: uid(),
        name,
        bewacher: $("empBewacher").value.trim(),
        phone: $("empPhone").value.trim(),
        role: $("empRole").value.trim()
      };
      store.employees.push(emp);
      saveStore(store);
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      renderAll();
    });
    $("btnClearEmp").addEventListener("click", ()=>{
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
    });
    $("empList").addEventListener("click",(e)=>{
      const id = e.target?.getAttribute?.("data-del-emp");
      if(!id) return;
      if(!confirm("Delete Mitarbeiter?")) return;
      store.employees = store.employees.filter(x=>x.id!==id);
      saveStore(store);
      renderAll();
    });

    // ========= CRUD: Objekt =========
    $("btnSaveObj").addEventListener("click", ()=>{
      const cust = $("custName").value.trim();
      const obj = $("objName").value.trim();
      const addr = $("objAddr").value.trim();
      const type = $("objType").value;
      if(!cust || !obj || !addr) return alert("Bitte Kunde, Objektname, Adresse ausfüllen.");
      store.objects.push({ id: uid(), cust, obj, addr, type });
      saveStore(store);
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      renderAll();
    });
    $("btnClearObj").addEventListener("click", ()=>{
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
    });
    $("objList").addEventListener("click",(e)=>{
      const id = e.target?.getAttribute?.("data-del-obj");
      if(!id) return;
      if(!confirm("Delete Objekt?")) return;
      store.objects = store.objects.filter(x=>x.id!==id);
      saveStore(store);
      renderAll();
    });

    // ========= CRUD: Einsatz =========
    $("btnCreate").addEventListener("click", ()=>{
      const empId = $("selEmp").value;
      const objId = $("selObj").value;
      const date = $("shiftDate").value;
      const start = $("shiftStart").value;
      const end = $("shiftEnd").value;
      const note = $("shiftNote").value.trim();

      if(!empId) return alert("Mitarbeiter wählen.");
      if(!objId) return alert("Objekt wählen.");
      if(!date || !start || !end) return alert("Datum/Start/Ende ausfüllen.");

      const obj = store.objects.find(x=>x.id===objId);
      store.einsaetze.push({
        id: uid(),
        empId, objId,
        date, start, end,
        note,
        type: obj?.type || "Einsatz",
        sigDataUrl: store.sigDataUrl || null,
        createdAt: Date.now()
      });
      saveStore(store);
      $("shiftNote").value="";
      renderAll();
    });

    $("einsatzList").addEventListener("click",(e)=>{
      const pick = e.target?.getAttribute?.("data-pick-ein");
      if(!pick) return;
      selectedEinsatzId = pick;
      renderEinsaetze();
    });

    $("btnDelete").addEventListener("click", ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      if(!confirm("Delete selected Einsatz?")) return;
      store.einsaetze = store.einsaetze.filter(x=>x.id!==selectedEinsatzId);
      selectedEinsatzId = null;
      saveStore(store);
      renderEinsaetze();
    });

    // ========= Signature Canvas =========
    const canvas = $("sigCanvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let last = null;

    function resizeCanvasToDevice(){
      const rect = canvas.getBoundingClientRect();
      const ratio = Math.max(1, window.devicePixelRatio || 1);
      const w = Math.floor(rect.width * ratio);
      const h = Math.floor(rect.height * ratio);

      const tmp = document.createElement("canvas");
      tmp.width = canvas.width; tmp.height = canvas.height;
      tmp.getContext("2d").drawImage(canvas, 0, 0);

      canvas.width = w;
      canvas.height = h;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(ratio, ratio);

      ctx.drawImage(tmp, 0, 0, rect.width, rect.height);
    }

    function posFromEvent(ev){
      const rect = canvas.getBoundingClientRect();
      const isTouch = ev.touches && ev.touches[0];
      const clientX = isTouch ? ev.touches[0].clientX : ev.clientX;
      const clientY = isTouch ? ev.touches[0].clientY : ev.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }
    function drawLine(a,b){
      ctx.lineWidth = 2.2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "rgba(255,255,255,.92)";
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();
    }
    function startDraw(ev){
      drawing = true;
      last = posFromEvent(ev);
    }
    function moveDraw(ev){
      if(!drawing) return;
      ev.preventDefault();
      const p = posFromEvent(ev);
      drawLine(last, p);
      last = p;
    }
    function endDraw(){
      drawing = false;
      last = null;
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);

    canvas.addEventListener("touchstart", startDraw, {passive:false});
    canvas.addEventListener("touchmove", moveDraw, {passive:false});
    canvas.addEventListener("touchend", endDraw);

    $("btnSigClear").addEventListener("click", ()=>{
      ctx.clearRect(0,0,canvas.width, canvas.height);
      store.sigDataUrl = null;
      saveStore(store);
    });

    $("btnSigSave").addEventListener("click", ()=>{
      const rect = canvas.getBoundingClientRect();
      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = Math.floor(rect.width);
      exportCanvas.height = Math.floor(rect.height);
      const ectx = exportCanvas.getContext("2d");
      ectx.drawImage(canvas, 0, 0, exportCanvas.width, exportCanvas.height);
      store.sigDataUrl = exportCanvas.toDataURL("image/png");
      saveStore(store);
      alert("Signature saved ✅");
    });

    function restoreSignature(){
      if(!store.sigDataUrl) return;
      const img = new Image();
      img.onload = ()=>{
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, rect.width, rect.height);
      };
      img.src = store.sigDataUrl;
    }

    window.addEventListener("resize", ()=>setTimeout(resizeCanvasToDevice, 150));

    // ========= Backup / Restore =========
    $("btnBackup").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "einsatzmeldung-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $("btnRestore").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type="file";
      input.accept="application/json";
      input.onchange = ()=>{
        const file = input.files?.[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const data = JSON.parse(String(r.result||""));
            store = {
              employees: Array.isArray(data.employees) ? data.employees : [],
              objects: Array.isArray(data.objects) ? data.objects : [],
              einsaetze: Array.isArray(data.einsaetze) ? data.einsaetze : [],
              sigDataUrl: data.sigDataUrl || null,
              logoDataUrl: data.logoDataUrl || null
            };
            saveStore(store);
            selectedEinsatzId = null;
            renderAll();
            setTimeout(()=>{
              resizeCanvasToDevice();
              restoreSignature();
            }, 120);
            alert("Restore done ✅");
          }catch{
            alert("Restore failed (invalid JSON).");
          }
        };
        r.readAsText(file);
      };
      input.click();
    });

    // ========= PDF Generation (Print-to-PDF) =========
    function formatDateISOToDE(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      if(!y||!m||!d) return iso;
      return `${d}.${m}.${y}`;
    }

    async function generatePdfForEinsatz(ein){
      const emp = store.employees.find(x=>x.id===ein.empId);
      const obj = store.objects.find(x=>x.id===ein.objId);

      const company = {
        name: "Masculine Security",
        address: "Werschenregerstraße 6, 28237 Bremen",
        phone: "015778697052",
        email: "Kontakt.mass.bremen@hotmail.com"
      };

      const sig = ein.sigDataUrl || store.sigDataUrl || null;
      const logo = store.logoDataUrl || null;

      const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Einsatzmeldung ${formatDateISOToDE(ein.date)}</title>
  <style>
    @page { size: A4; margin: 18mm; }
    body { font-family: Arial, sans-serif; color:#111; }
    .head { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo { width:56px; height:56px; object-fit:contain; border:1px solid #ddd; border-radius:10px; padding:6px; }
    h1 { margin:0; font-size:18px; }
    .sub { color:#444; margin-top:4px; font-size:12px; }
    .box { border:1px solid #111; border-radius:10px; padding:12px; margin-top:12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .label { font-size:11px; color:#333; margin-bottom:4px; }
    .val { font-size:12px; font-weight:700; }
    .line { height:1px; background:#111; opacity:.18; margin:12px 0; }
    .sig { display:flex; justify-content:space-between; gap:12px; margin-top:10px; }
    .sigbox { flex:1; border:1px solid #111; border-radius:10px; padding:10px; min-height:86px; }
    .sigimg { max-height:64px; max-width:100%; display:block; }
    .foot { margin-top:10px; font-size:10px; color:#333; }
    a { color:#111; text-decoration:none; }
  </style>
</head>
<body>
  <div class="head">
    <div class="brand">
      ${logo ? `<img class="logo" src="${logo}" alt="Logo"/>` : ``}
      <div>
        <h1>Einsatzmeldung</h1>
        <div class="sub">${company.name} • ${company.address}</div>
        <div class="sub">Tel: ${company.phone} • E-Mail: <a href="mailto:${company.email}">${company.email}</a></div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
      <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
    </div>
  </div>

  <div class="box">
    <div class="grid">
      <div>
        <div class="label">Mitarbeiter</div>
        <div class="val">${escapeHtml(emp?.name || "—")}</div>
        <div class="sub">Bewacher-ID: ${escapeHtml(emp?.bewacher || "—")}</div>
        <div class="sub">Position: ${escapeHtml(emp?.role || "—")}</div>
      </div>
      <div>
        <div class="label">Kunde / Objekt</div>
        <div class="val">${escapeHtml(obj?.cust || "—")} — ${escapeHtml(obj?.obj || "—")}</div>
        <div class="sub">Adresse: ${escapeHtml(obj?.addr || "—")}</div>
      </div>
    </div>

    <div class="line"></div>

    <div class="grid">
      <div>
        <div class="label">Schichtzeit</div>
        <div class="val">${escapeHtml(ein.start)} – ${escapeHtml(ein.end)}</div>
      </div>
      <div>
        <div class="label">Tätigkeit / Bemerkung</div>
        <div class="val">${escapeHtml(ein.note || "—")}</div>
      </div>
    </div>

    <div class="sig">
      <div class="sigbox">
        <div class="label">Unterschrift Mitarbeiter</div>
        ${sig ? `<img class="sigimg" src="${sig}" alt="Signature"/>` : `<div class="sub">—</div>`}
      </div>
      <div class="sigbox">
        <div class="label">Unterschrift Auftraggeber / Objektverantwortlicher</div>
        <div class="sub" style="margin-top:42px">______________________________</div>
      </div>
    </div>

    <div class="foot">
      Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.
    </div>
  </div>

  <script>
    window.onload = () => setTimeout(()=>{ window.print(); }, 250);
  </script>
</body>
</html>`;

      const w = window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups to print PDF.");
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    $("btnPDF").addEventListener("click", async ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      const ein = store.einsaetze.find(x=>x.id===selectedEinsatzId);
      if(!ein) return alert("Einsatz not found.");
      await generatePdfForEinsatz(ein);
    });

    // ========= Init =========
    (function init(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      $("shiftDate").value = `${yyyy}-${mm}-${dd}`;
      $("shiftStart").value = "18:00";
      $("shiftEnd").value = "06:00";

      renderAll();
      setTimeout(()=>{
        resizeCanvasToDevice();
        restoreSignature();
        applyLogo();
      }, 120);
    })();
  </script>
</body>
</html>
