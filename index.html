<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Masculine Security ‚Äì Mini Office (Offline)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel2:#111c36;
      --card:#0f1a33;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --accent:#3b82f6;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;
      --radius:14px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{
      min-height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
    }
    /* Sidebar */
    .sidebar{
      position:sticky; top:0; height:100vh;
      padding:18px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-right:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 10px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    .logo{
      width:40px; height:40px;
      border-radius:12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(59,130,246,.35), rgba(34,197,94,.18));
      border:1px solid var(--line);
      font-weight:800;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.2;
    }
    .brand p{
      margin:2px 0 0 0;
      color:var(--muted);
      font-size:12px;
    }
    .nav{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      transition:.15s ease;
    }
    .nav button:hover{background:rgba(255,255,255,.03); border-color:var(--line)}
    .nav button.active{
      background:rgba(59,130,246,.12);
      border-color:rgba(59,130,246,.35);
    }
    .nav .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .nav .icon{
      width:28px; height:28px;
      border-radius:10px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      flex:0 0 auto;
      font-size:13px;
    }
    .nav .label{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:13px;
    }
    .pill{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 8px;
      flex:0 0 auto;
    }
    .sidebar .footer{
      margin-top:auto;
      padding:12px 10px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }

    /* Main */
    .main{
      padding:18px 18px 26px 18px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      position:sticky; top:10px;
      z-index:10;
      backdrop-filter: blur(10px);
    }
    .crumbs{
      min-width:0;
    }
    .crumbs .title{
      font-size:14px;
      font-weight:700;
      margin:0;
    }
    .crumbs .sub{
      margin:3px 0 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18)}
    .btn.primary{border-color:rgba(59,130,246,.45); background:rgba(59,130,246,.14)}
    .btn.good{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.14)}
    .btn.danger{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    /* Layout blocks */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid{grid-template-columns:1fr}
      .topbar{position:relative; top:auto}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
    }
    .muted{color:var(--muted)}
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns:1fr}
    }
    .kpi{
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(15,26,51,.55);
    }
    .kpi .klabel{font-size:12px; color:var(--muted)}
    .kpi .kval{font-size:18px; font-weight:800; margin-top:6px}
    .kpi .kmini{font-size:11px; color:var(--muted); margin-top:2px}

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(15,26,51,.45);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid var(--line);
    }
    th{
      color:var(--muted);
      font-weight:700;
      background:rgba(255,255,255,.02);
    }
    tr:last-child td{border-bottom:none}
    .row-actions{
      display:flex; gap:6px; justify-content:flex-end;
    }
    .mini{
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .mini.danger{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12)}
    .mini.good{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12)}
    .mini:disabled{opacity:.55; cursor:not-allowed}

    /* Forms */
    .form{
      display:grid;
      gap:10px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .field input, .field select, .field textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .field textarea{min-height:90px; resize:vertical}
    .field input::placeholder, .field textarea::placeholder{color:rgba(156,163,175,.6)}
    .form-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .form-row{grid-template-columns:1fr}
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      font-size:12px;
      opacity:0;
      transform:translateY(8px);
      transition:.2s ease;
      pointer-events:none;
      max-width: 520px;
    }
    .toast.show{opacity:1; transform:translateY(0)}
    .split{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .code{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(229,231,235,.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
  <div class="app" id="root">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">MS</div>
        <div>
          <h1>Masculine Security</h1>
          <p>Mini Office ‚Ä¢ Offline (local)</p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-page="dashboard">
          <div class="left"><div class="icon">üè†</div><div class="label">√úbersicht</div></div>
          <span class="pill" id="pillDash">KPIs</span>
        </button>
        <button data-page="customers">
          <div class="left"><div class="icon">üë§</div><div class="label">Kunden</div></div>
          <span class="pill" id="pillCustomers">0</span>
        </button>
        <button data-page="invoices">
          <div class="left"><div class="icon">üßæ</div><div class="label">Rechnungen</div></div>
          <span class="pill" id="pillInvoices">0</span>
        </button>
        <button data-page="expenses">
          <div class="left"><div class="icon">üí≥</div><div class="label">Ausgaben</div></div>
          <span class="pill" id="pillExpenses">0</span>
        </button>
        <button data-page="settings">
          <div class="left"><div class="icon">‚öôÔ∏è</div><div class="label">Einstellungen</div></div>
          <span class="pill">Backup</span>
        </button>
      </nav>

      <div class="footer">
        <div><b>Tip:</b> Netlify updates = GitHub commit.</div>
        <div class="muted" style="margin-top:6px">Version: <span id="ver">v1</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumbs">
          <p class="title" id="pageTitle">√úbersicht</p>
          <p class="sub" id="pageSub">Umsatz ‚Ä¢ Ausgaben ‚Ä¢ Kunden ‚Ä¢ Rechnungen (offline)</p>
        </div>
        <div class="actions" id="topActions">
          <button class="btn primary" id="quickInvoice">Ôºã Rechnung</button>
          <button class="btn" id="quickCustomer">Ôºã Kunde</button>
          <button class="btn" id="quickExpense">Ôºã Ausgabe</button>
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn" id="importBtn">Import</button>
        </div>
      </div>

      <section id="view"></section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <input type="file" id="fileInput" accept="application/json" style="display:none" />

  <script>
    // ===============================
    // Mini Office App (offline localStorage)
    // NOTE for CodePen: keep JS only here (HTML panel). Leave JS panel EMPTY.
    // ===============================

    (function(){
      const LS_KEY = "ms_mini_office_v1";
      const $ = (sel, el=document) => el.querySelector(sel);
      const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

      const state = loadState();

      const ui = {
        nav: $("#nav"),
        view: $("#view"),
        title: $("#pageTitle"),
        sub: $("#pageSub"),
        toast: $("#toast"),
        pillCustomers: $("#pillCustomers"),
        pillInvoices: $("#pillInvoices"),
        pillExpenses: $("#pillExpenses"),
        ver: $("#ver"),
        fileInput: $("#fileInput"),
        exportBtn: $("#exportBtn"),
        importBtn: $("#importBtn"),
        quickInvoice: $("#quickInvoice"),
        quickCustomer: $("#quickCustomer"),
        quickExpense: $("#quickExpense"),
      };

      ui.ver.textContent = "v1 (offline)";

      // ---- Routing
      $$("#nav button").forEach(btn=>{
        btn.addEventListener("click", ()=>go(btn.dataset.page));
      });

      // Top actions
      ui.quickInvoice.addEventListener("click", ()=>go("invoices", {openNew:true}));
      ui.quickCustomer.addEventListener("click", ()=>go("customers", {openNew:true}));
      ui.quickExpense.addEventListener("click", ()=>go("expenses", {openNew:true}));

      ui.exportBtn.addEventListener("click", exportJSON);
      ui.importBtn.addEventListener("click", ()=>{
        ui.fileInput.value = "";
        ui.fileInput.click();
      });
      ui.fileInput.addEventListener("change", importJSON);

      // Initial
      go("dashboard");
      refreshPills();

      // ===============================
      // Pages
      // ===============================
      function go(page, opts={}){
        $$("#nav button").forEach(b=>b.classList.toggle("active", b.dataset.page===page));

        if(page === "dashboard"){
          ui.title.textContent = "√úbersicht";
          ui.sub.textContent = "Umsatz ‚Ä¢ Ausgaben ‚Ä¢ Kunden ‚Ä¢ Rechnungen (offline)";
          ui.view.innerHTML = dashboardHTML();
          wireDashboard();
          return;
        }

        if(page === "customers"){
          ui.title.textContent = "Kunden";
          ui.sub.textContent = "Kunden anlegen ‚Ä¢ bearbeiten ‚Ä¢ l√∂schen";
          ui.view.innerHTML = customersHTML();
          wireCustomers(opts);
          return;
        }

        if(page === "invoices"){
          ui.title.textContent = "Rechnungen";
          ui.sub.textContent = "Rechnungen erstellen ‚Ä¢ Liste ‚Ä¢ CSV Export";
          ui.view.innerHTML = invoicesHTML();
          wireInvoices(opts);
          return;
        }

        if(page === "expenses"){
          ui.title.textContent = "Ausgaben";
          ui.sub.textContent = "Ausgaben erfassen ‚Ä¢ Liste ‚Ä¢ CSV Export";
          ui.view.innerHTML = expensesHTML();
          wireExpenses(opts);
          return;
        }

        if(page === "settings"){
          ui.title.textContent = "Einstellungen";
          ui.sub.textContent = "Backup/Restore ‚Ä¢ CSV Export ‚Ä¢ Reset";
          ui.view.innerHTML = settingsHTML();
          wireSettings();
          return;
        }
      }

      function dashboardHTML(){
        const k = calcKPIs();
        const recent = buildRecent();
        return `
          <div class="grid">
            <div class="card">
              <h2>KPIs</h2>
              <div class="kpis">
                <div class="kpi">
                  <div class="klabel">Umsatz (dieser Monat)</div>
                  <div class="kval">${fmtEUR(k.revMonth)}</div>
                  <div class="kmini">MwSt: ${fmtEUR(0)} ‚Ä¢ Brutto: ${fmtEUR(k.revMonth)}</div>
                </div>
                <div class="kpi">
                  <div class="klabel">Ausgaben (dieser Monat)</div>
                  <div class="kval">${fmtEUR(k.expMonth)}</div>
                  <div class="kmini">Belege lokal gespeichert</div>
                </div>
                <div class="kpi">
                  <div class="klabel">Umsatz (dieses Jahr)</div>
                  <div class="kval">${fmtEUR(k.revYear)}</div>
                  <div class="kmini">Rechnungen: ${k.invCount}</div>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>Schnellstart</h2>
              <p class="muted" style="margin:0 0 10px 0">
                Wie Lexoffice-Style: Links Navigation, oben Aktionen, Daten offline.
              </p>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn primary" id="dashNewInv">Ôºã Rechnung</button>
                <button class="btn" id="dashNewCus">Ôºã Kunde</button>
                <button class="btn" id="dashNewExp">Ôºã Ausgabe</button>
              </div>

              <div style="margin-top:12px" class="muted">
                Tipp: Export/Import oben rechts f√ºr Backup.
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="split">
              <h2 style="margin:0">Letzte Aktivit√§ten</h2>
              <div class="muted" style="font-size:12px">${recent.count} Eintr√§ge</div>
            </div>
            <div style="margin-top:10px">
              ${recent.html}
            </div>
          </div>
        `;
      }

      function wireDashboard(){
        $("#dashNewInv").addEventListener("click", ()=>go("invoices", {openNew:true}));
        $("#dashNewCus").addEventListener("click", ()=>go("customers", {openNew:true}));
        $("#dashNewExp").addEventListener("click", ()=>go("expenses", {openNew:true}));
      }

      function customersHTML(){
        const rows = state.customers.map((c)=>`
          <tr>
            <td><b>${escapeHTML(c.name)}</b><div class="muted" style="font-size:11px">${escapeHTML(c.email||"")}</div></td>
            <td>${escapeHTML(c.phone||"")}</td>
            <td class="muted">${escapeHTML(c.city||"")}</td>
            <td class="muted">${escapeHTML(c.createdAt.slice(0,10))}</td>
            <td>
              <div class="row-actions">
                <button class="mini" data-act="edit" data-id="${c.id}">Bearbeiten</button>
                <button class="mini danger" data-act="del" data-id="${c.id}">L√∂schen</button>
              </div>
            </td>
          </tr>
        `).join("");

        return `
          <div class="grid">
            <div class="card">
              <h2>Kundenliste</h2>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Telefon</th>
                    <th>Ort</th>
                    <th>Datum</th>
                    <th style="text-align:right">Aktion</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows || `<tr><td colspan="5" class="muted">Noch keine Kunden. Klicke ‚ÄûÔºã Kunde‚Äú.</td></tr>`}
                </tbody>
              </table>
            </div>

            <div class="card">
              <h2 id="custFormTitle">Neuer Kunde</h2>
              <form class="form" id="custForm">
                <input type="hidden" id="custId" />
                <div class="field">
                  <label>Name *</label>
                  <input id="custName" placeholder="z.B. Beispiel Kunde GmbH" required />
                </div>
                <div class="form-row">
                  <div class="field">
                    <label>E-Mail</label>
                    <input id="custEmail" placeholder="kunde@email.de" />
                  </div>
                  <div class="field">
                    <label>Telefon</label>
                    <input id="custPhone" placeholder="+49 ..." />
                  </div>
                </div>
                <div class="form-row">
                  <div class="field">
                    <label>Stra√üe</label>
                    <input id="custStreet" placeholder="Musterstra√üe 1" />
                  </div>
                  <div class="field">
                    <label>PLZ/Ort</label>
                    <input id="custCity" placeholder="28237 Bremen" />
                  </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn good" type="submit" id="custSaveBtn">Speichern</button>
                  <button class="btn" type="button" id="custResetBtn">Reset</button>
                </div>
              </form>
            </div>
          </div>
        `;
      }

      function wireCustomers(opts){
        const form = $("#custForm");
        const title = $("#custFormTitle");
        const id = $("#custId");
        const name = $("#custName");
        const email = $("#custEmail");
        const phone = $("#custPhone");
        const street = $("#custStreet");
        const city = $("#custCity");

        if(opts.openNew){
          title.textContent = "Neuer Kunde";
          id.value = "";
          form.reset();
          name.focus();
        }

        $$("#view [data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            const cid = btn.dataset.id;
            if(act === "del"){
              if(!confirm("Kunde l√∂schen?")) return;
              state.customers = state.customers.filter(c=>c.id!==cid);
              // also remove from invoices references (keep data)
              saveState();
              toast("Kunde gel√∂scht.");
              refreshPills();
              go("customers");
            }
            if(act === "edit"){
              const c = state.customers.find(x=>x.id===cid);
              if(!c) return;
              title.textContent = "Kunde bearbeiten";
              id.value = c.id;
              name.value = c.name || "";
              email.value = c.email || "";
              phone.value = c.phone || "";
              street.value = c.street || "";
              city.value = c.city || "";
              name.focus();
            }
          });
        });

        $("#custResetBtn").addEventListener("click", ()=>{
          title.textContent = "Neuer Kunde";
          id.value = "";
          form.reset();
        });

        form.addEventListener("submit", (e)=>{
          e.preventDefault();
          if(!name.value.trim()){
            toast("Name ist Pflicht.", true);
            return;
          }
          const payload = {
            id: id.value || uid("C"),
            name: name.value.trim(),
            email: email.value.trim(),
            phone: phone.value.trim(),
            street: street.value.trim(),
            city: city.value.trim(),
            createdAt: new Date().toISOString(),
          };

          if(id.value){
            const idx = state.customers.findIndex(c=>c.id===id.value);
            if(idx>=0){
              payload.createdAt = state.customers[idx].createdAt;
              state.customers[idx] = payload;
              toast("Kunde aktualisiert.");
            }
          } else {
            state.customers.unshift(payload);
            toast("Kunde gespeichert.");
          }

          saveState();
          refreshPills();
          go("customers");
        });
      }

      function invoicesHTML(){
        const rows = state.invoices.map(inv=>{
          const c = state.customers.find(x=>x.id===inv.customerId);
          return `
            <tr>
              <td><b>${escapeHTML(inv.number)}</b><div class="muted" style="font-size:11px">${escapeHTML(inv.date)}</div></td>
              <td>${escapeHTML(c ? c.name : "(ohne Kunde)")}</td>
              <td class="muted">${escapeHTML(inv.title || "")}</td>
              <td><b>${fmtEUR(inv.total)}</b></td>
              <td>
                <div class="row-actions">
                  <button class="mini" data-act="editInv" data-id="${inv.id}">Bearbeiten</button>
                  <button class="mini" data-act="csvInv" data-id="${inv.id}">CSV</button>
                  <button class="mini danger" data-act="delInv" data-id="${inv.id}">L√∂schen</button>
                </div>
              </td>
            </tr>
          `;
        }).join("");

        const customerOptions = state.customers.map(c=>`<option value="${c.id}">${escapeHTML(c.name)}</option>`).join("");

        return `
          <div class="grid">
            <div class="card">
              <div class="split">
                <h2 style="margin:0">Rechnungen</h2>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn" id="exportInvoicesCsv">Rechnungen CSV</button>
                </div>
              </div>
              <div style="margin-top:10px">
                <table>
                  <thead>
                    <tr>
                      <th>Nr / Datum</th>
                      <th>Kunde</th>
                      <th>Titel</th>
                      <th>Summe</th>
                      <th style="text-align:right">Aktion</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows || `<tr><td colspan="5" class="muted">Noch keine Rechnungen. Klicke ‚ÄûÔºã Rechnung‚Äú.</td></tr>`}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <h2 id="invFormTitle">Neue Rechnung</h2>
              <form class="form" id="invForm">
                <input type="hidden" id="invId" />
                <div class="form-row">
                  <div class="field">
                    <label>Rechnungsnummer *</label>
                    <input id="invNumber" placeholder="RE-2026-0001" required />
                  </div>
                  <div class="field">
                    <label>Datum *</label>
                    <input id="invDate" type="date" required />
                  </div>
                </div>

                <div class="field">
                  <label>Kunde</label>
                  <select id="invCustomer">
                    <option value="">(ohne Kunde)</option>
                    ${customerOptions}
                  </select>
                </div>

                <div class="field">
                  <label>Titel</label>
                  <input id="invTitle" placeholder="z.B. Sicherheitsdienst ‚Äì Objektschutz" />
                </div>

                <div class="form-row">
                  <div class="field">
                    <label>Netto (EUR) *</label>
                    <input id="invNet" type="number" step="0.01" placeholder="480.00" required />
                  </div>
                  <div class="field">
                    <label>Notiz</label>
                    <input id="invNote" placeholder="Kleinunternehmer ¬ß19 UStG" />
                  </div>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn good" type="submit">Speichern</button>
                  <button class="btn" type="button" id="invResetBtn">Reset</button>
                </div>

                <div class="muted" style="margin-top:10px; font-size:12px">
                  MwSt wird hier als 0 gerechnet (Kleinunternehmer). Du kannst sp√§ter erweitern.
                </div>
              </form>
            </div>
          </div>
        `;
      }

      function wireInvoices(opts){
        const form = $("#invForm");
        const title = $("#invFormTitle");
        const id = $("#invId");
        const number = $("#invNumber");
        const date = $("#invDate");
        const customer = $("#invCustomer");
        const invTitle = $("#invTitle");
        const net = $("#invNet");
        const note = $("#invNote");

        // defaults
        if(!date.value) date.value = today();

        if(opts.openNew){
          title.textContent = "Neue Rechnung";
          id.value = "";
          form.reset();
          date.value = today();
          number.value = nextInvoiceNumber();
          number.focus();
        } else {
          // if empty list, propose next number
          if(!number.value) number.value = nextInvoiceNumber();
        }

        $("#exportInvoicesCsv").addEventListener("click", ()=>{
          const csv = makeInvoicesCSV();
          downloadText(csv, "rechnungen.csv", "text/csv;charset=utf-8");
        });

        $$("#view [data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            const iid = btn.dataset.id;

            if(act === "delInv"){
              if(!confirm("Rechnung l√∂schen?")) return;
              state.invoices = state.invoices.filter(x=>x.id!==iid);
              saveState();
              toast("Rechnung gel√∂scht.");
              refreshPills();
              go("invoices");
            }

            if(act === "editInv"){
              const inv = state.invoices.find(x=>x.id===iid);
              if(!inv) return;
              title.textContent = "Rechnung bearbeiten";
              id.value = inv.id;
              number.value = inv.number;
              date.value = inv.date;
              customer.value = inv.customerId || "";
              invTitle.value = inv.title || "";
              net.value = inv.net;
              note.value = inv.note || "";
              number.focus();
            }

            if(act === "csvInv"){
              const inv = state.invoices.find(x=>x.id===iid);
              if(!inv) return;
              const c = state.customers.find(x=>x.id===inv.customerId);
              const header = ["number","date","customer","title","net","total","note"];
              const row = [
                inv.number,
                inv.date,
                c ? c.name : "",
                inv.title || "",
                String(inv.net),
                String(inv.total),
                inv.note || ""
              ].map(csvEscape).join(",");
              const csv = header.join(",") + "\n" + row + "\n";
              downloadText(csv, `${inv.number}.csv`, "text/csv;charset=utf-8");
              toast("CSV erstellt.");
            }
          });
        });

        $("#invResetBtn").addEventListener("click", ()=>{
          title.textContent = "Neue Rechnung";
          id.value = "";
          form.reset();
          date.value = today();
          number.value = nextInvoiceNumber();
        });

        form.addEventListener("submit", (e)=>{
          e.preventDefault();

          if(!number.value.trim() || !date.value){
            toast("Nummer & Datum sind Pflicht.", true);
            return;
          }
          const netVal = Number(net.value);
          if(!isFinite(netVal) || netVal < 0){
            toast("Netto Betrag ist ung√ºltig.", true);
            return;
          }

          const payload = {
            id: id.value || uid("I"),
            number: number.value.trim(),
            date: date.value,
            customerId: customer.value || "",
            title: invTitle.value.trim(),
            note: note.value.trim(),
            net: round2(netVal),
            total: round2(netVal), // MwSt 0
            createdAt: new Date().toISOString(),
          };

          if(id.value){
            const idx = state.invoices.findIndex(x=>x.id===id.value);
            if(idx>=0){
              payload.createdAt = state.invoices[idx].createdAt;
              state.invoices[idx] = payload;
              toast("Rechnung aktualisiert.");
            }
          } else {
            state.invoices.unshift(payload);
            toast("Rechnung gespeichert.");
          }

          saveState();
          refreshPills();
          go("invoices");
        });
      }

      function expensesHTML(){
        const rows = state.expenses.map(ex=>`
          <tr>
            <td><b>${escapeHTML(ex.title)}</b><div class="muted" style="font-size:11px">${escapeHTML(ex.date)}</div></td>
            <td class="muted">${escapeHTML(ex.category||"")}</td>
            <td><b>${fmtEUR(ex.amount)}</b></td>
            <td>
              <div class="row-actions">
                <button class="mini" data-act="editEx" data-id="${ex.id}">Bearbeiten</button>
                <button class="mini danger" data-act="delEx" data-id="${ex.id}">L√∂schen</button>
              </div>
            </td>
          </tr>
        `).join("");

        return `
          <div class="grid">
            <div class="card">
              <div class="split">
                <h2 style="margin:0">Ausgaben</h2>
                <button class="btn" id="exportExpensesCsv">Ausgaben CSV</button>
              </div>

              <div style="margin-top:10px">
                <table>
                  <thead>
                    <tr>
                      <th>Bezeichnung / Datum</th>
                      <th>Kategorie</th>
                      <th>Betrag</th>
                      <th style="text-align:right">Aktion</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows || `<tr><td colspan="4" class="muted">Noch keine Ausgaben. Klicke ‚ÄûÔºã Ausgabe‚Äú.</td></tr>`}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <h2 id="exFormTitle">Neue Ausgabe</h2>
              <form class="form" id="exForm">
                <input type="hidden" id="exId" />
                <div class="form-row">
                  <div class="field">
                    <label>Datum *</label>
                    <input id="exDate" type="date" required />
                  </div>
                  <div class="field">
                    <label>Betrag (EUR) *</label>
                    <input id="exAmount" type="number" step="0.01" placeholder="29.90" required />
                  </div>
                </div>
                <div class="field">
                  <label>Bezeichnung *</label>
                  <input id="exTitle" placeholder="z.B. B√ºromaterial" required />
                </div>
                <div class="field">
                  <label>Kategorie</label>
                  <input id="exCategory" placeholder="z.B. B√ºro / Fahrt / Telefon" />
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn good" type="submit">Speichern</button>
                  <button class="btn" type="button" id="exResetBtn">Reset</button>
                </div>
              </form>
            </div>
          </div>
        `;
      }

      function wireExpenses(opts){
        const form = $("#exForm");
        const title = $("#exFormTitle");
        const id = $("#exId");
        const date = $("#exDate");
        const amount = $("#exAmount");
        const exTitle = $("#exTitle");
        const category = $("#exCategory");

        if(!date.value) date.value = today();

        if(opts.openNew){
          title.textContent = "Neue Ausgabe";
          id.value = "";
          form.reset();
          date.value = today();
          exTitle.focus();
        }

        $("#exportExpensesCsv").addEventListener("click", ()=>{
          const csv = makeExpensesCSV();
          downloadText(csv, "ausgaben.csv", "text/csv;charset=utf-8");
        });

        $$("#view [data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            const eid = btn.dataset.id;

            if(act === "delEx"){
              if(!confirm("Ausgabe l√∂schen?")) return;
              state.expenses = state.expenses.filter(x=>x.id!==eid);
              saveState();
              toast("Ausgabe gel√∂scht.");
              refreshPills();
              go("expenses");
            }

            if(act === "editEx"){
              const ex = state.expenses.find(x=>x.id===eid);
              if(!ex) return;
              title.textContent = "Ausgabe bearbeiten";
              id.value = ex.id;
              date.value = ex.date;
              amount.value = ex.amount;
              exTitle.value = ex.title;
              category.value = ex.category || "";
              exTitle.focus();
            }
          });
        });

        $("#exResetBtn").addEventListener("click", ()=>{
          title.textContent = "Neue Ausgabe";
          id.value = "";
          form.reset();
          date.value = today();
        });

        form.addEventListener("submit", (e)=>{
          e.preventDefault();

          if(!date.value || !exTitle.value.trim()){
            toast("Datum & Bezeichnung sind Pflicht.", true);
            return;
          }

          const amt = Number(amount.value);
          if(!isFinite(amt) || amt < 0){
            toast("Betrag ist ung√ºltig.", true);
            return;
          }

          const payload = {
            id: id.value || uid("E"),
            date: date.value,
            amount: round2(amt),
            title: exTitle.value.trim(),
            category: category.value.trim(),
            createdAt: new Date().toISOString(),
          };

          if(id.value){
            const idx = state.expenses.findIndex(x=>x.id===id.value);
            if(idx>=0){
              payload.createdAt = state.expenses[idx].createdAt;
              state.expenses[idx] = payload;
              toast("Ausgabe aktualisiert.");
            }
          } else {
            state.expenses.unshift(payload);
            toast("Ausgabe gespeichert.");
          }

          saveState();
          refreshPills();
          go("expenses");
        });
      }

      function settingsHTML(){
        return `
          <div class="grid">
            <div class="card">
              <h2>Backup / Restore</h2>
              <p class="muted" style="margin-top:0">
                Export/Import speichert alle Daten (Kunden, Rechnungen, Ausgaben) als JSON.
              </p>

              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <button class="btn primary" id="doExport">Export JSON</button>
                <button class="btn" id="doImport">Import JSON</button>
              </div>

              <div class="card" style="margin-top:12px; background:rgba(15,26,51,.35)">
                <div class="split">
                  <div>
                    <div style="font-weight:700">CSV Export</div>
                    <div class="muted" style="font-size:12px">F√ºr Excel / Lexoffice Import sp√§ter</div>
                  </div>
                  <div class="code">UTF-8 ‚Ä¢ comma</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
                  <button class="btn" id="csvCustomers">Kunden CSV</button>
                  <button class="btn" id="csvInvoices">Rechnungen CSV</button>
                  <button class="btn" id="csvExpenses">Ausgaben CSV</button>
                </div>
              </div>
            </div>

            <div class="card">
              <h2>Danger Zone</h2>
              <p class="muted" style="margin-top:0">
                Setzt lokale Daten zur√ºck (localStorage).
              </p>
              <button class="btn danger" id="resetAll">Alles zur√ºcksetzen</button>

              <div style="margin-top:12px" class="muted">
                <b>Hinweis:</b> Wenn Netlify ‚Äúapp‚Äù nicht updatet, mach Hard-Refresh (Ctrl+F5) oder l√∂sche Site-Daten im Browser.
              </div>
            </div>
          </div>
        `;
      }

      function wireSettings(){
        $("#doExport").addEventListener("click", exportJSON);
        $("#doImport").addEventListener("click", ()=>{
          ui.fileInput.value = "";
          ui.fileInput.click();
        });

        $("#csvCustomers").addEventListener("click", ()=>{
          downloadText(makeCustomersCSV(), "kunden.csv", "text/csv;charset=utf-8");
          toast("Kunden CSV erstellt.");
        });
        $("#csvInvoices").addEventListener("click", ()=>{
          downloadText(makeInvoicesCSV(), "rechnungen.csv", "text/csv;charset=utf-8");
          toast("Rechnungen CSV erstellt.");
        });
        $("#csvExpenses").addEventListener("click", ()=>{
          downloadText(makeExpensesCSV(), "ausgaben.csv", "text/csv;charset=utf-8");
          toast("Ausgaben CSV erstellt.");
        });

        $("#resetAll").addEventListener("click", ()=>{
          if(!confirm("Wirklich ALLES l√∂schen?")) return;
          localStorage.removeItem(LS_KEY);
          state.customers = [];
          state.invoices = [];
          state.expenses = [];
          saveState();
          refreshPills();
          toast("Zur√ºckgesetzt.");
          go("dashboard");
        });
      }

      // ===============================
      // Storage
      // ===============================
      function loadState(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(!raw) return seed();
          const data = JSON.parse(raw);
          return normalize(data);
        } catch(e){
          return seed();
        }
      }

      function saveState(){
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }

      function seed(){
        // Small demo data (you can delete later)
        return normalize({
          customers: [
            { id: "C_demo", name: "Beispiel Kunde GmbH", email: "", phone:"", street:"", city:"Bremen", createdAt: new Date().toISOString() }
          ],
          invoices: [
            { id:"I_demo", number:"RE-2026-0001", date: today(), customerId:"C_demo", title:"Sicherheitsdienst", note:"Kleinunternehmer ¬ß19 UStG", net:480, total:480, createdAt: new Date().toISOString() }
          ],
          expenses: [
            { id:"E_demo", date: today(), amount:29.90, title:"B√ºromaterial", category:"B√ºro", createdAt: new Date().toISOString() }
          ]
        });
      }

      function normalize(data){
        return {
          customers: Array.isArray(data.customers) ? data.customers : [],
          invoices: Array.isArray(data.invoices) ? data.invoices : [],
          expenses: Array.isArray(data.expenses) ? data.expenses : []
        };
      }

      function exportJSON(){
        const blob = JSON.stringify(state, null, 2);
        downloadText(blob, "ms-backup.json", "application/json;charset=utf-8");
        toast("Export fertig.");
      }

      function importJSON(ev){
        const file = ev.target.files && ev.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const data = JSON.parse(String(reader.result || ""));
            const clean = normalize(data);
            state.customers = clean.customers;
            state.invoices = clean.invoices;
            state.expenses = clean.expenses;
            saveState();
            refreshPills();
            toast("Import erfolgreich.");
            go("dashboard");
          } catch(e){
            toast("Import fehlgeschlagen: JSON ung√ºltig.", true);
          }
        };
        reader.readAsText(file);
      }

      // ===============================
      // KPIs & helpers
      // ===============================
      function calcKPIs(){
        const now = new Date();
        const ym = now.toISOString().slice(0,7);
        const year = now.getFullYear();

        const invMonth = state.invoices.filter(i=>String(i.date||"").slice(0,7)===ym);
        const expMonth = state.expenses.filter(e=>String(e.date||"").slice(0,7)===ym);

        const invYear = state.invoices.filter(i=>Number(String(i.date||"").slice(0,4))===year);

        const revMonth = invMonth.reduce((s,i)=>s+Number(i.total||0),0);
        const expMonthSum = expMonth.reduce((s,e)=>s+Number(e.amount||0),0);
        const revYear = invYear.reduce((s,i)=>s+Number(i.total||0),0);

        return {
          revMonth: round2(revMonth),
          expMonth: round2(expMonthSum),
          revYear: round2(revYear),
          invCount: state.invoices.length
        };
      }

      function buildRecent(){
        const items = [];
        for(const inv of state.invoices.slice(0,6)){
          items.push({
            type:"invoice",
            date: inv.date,
            label: `${inv.number} ‚Ä¢ ${inv.title || "Rechnung"} ‚Ä¢ ${fmtEUR(inv.total)}`
          });
        }
        for(const ex of state.expenses.slice(0,6)){
          items.push({
            type:"expense",
            date: ex.date,
            label: `${ex.title} ‚Ä¢ ${fmtEUR(ex.amount)}`
          });
        }
        items.sort((a,b)=>String(b.date).localeCompare(String(a.date)));
        const top = items.slice(0,8);

        const html = top.length ? `
          <table>
            <thead><tr><th>Typ</th><th>Eintrag</th><th>Datum</th></tr></thead>
            <tbody>
              ${top.map(x=>`
                <tr>
                  <td class="muted">${x.type==="invoice" ? "Rechnung" : "Ausgabe"}</td>
                  <td><b>${escapeHTML(x.label)}</b></td>
                  <td class="muted">${escapeHTML(String(x.date||""))}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        ` : `<div class="muted">Noch keine Aktivit√§ten.</div>`;

        return { count: top.length, html };
      }

      function refreshPills(){
        ui.pillCustomers.textContent = String(state.customers.length);
        ui.pillInvoices.textContent = String(state.invoices.length);
        ui.pillExpenses.textContent = String(state.expenses.length);
      }

      function nextInvoiceNumber(){
        // simple: find max numeric tail
        const year = new Date().getFullYear();
        const prefix = `RE-${year}-`;
        let max = 0;
        for(const inv of state.invoices){
          if(typeof inv.number !== "string") continue;
          if(inv.number.startsWith(prefix)){
            const tail = inv.number.slice(prefix.length);
            const n = parseInt(tail, 10);
            if(Number.isFinite(n)) max = Math.max(max, n);
          }
        }
        const next = String(max + 1).padStart(4,"0");
        return `${prefix}${next}`;
      }

      function makeCustomersCSV(){
        const header = ["id","name","email","phone","street","city","createdAt"];
        const rows = state.customers.map(c=>[
          c.id, c.name, c.email||"", c.phone||"", c.street||"", c.city||"", c.createdAt||""
        ].map(csvEscape).join(","));
        return header.join(",") + "\n" + rows.join("\n") + "\n";
      }

      function makeInvoicesCSV(){
        const header = ["id","number","date","customerId","customerName","title","net","total","note","createdAt"];
        const rows = state.invoices.map(i=>{
          const c = state.customers.find(x=>x.id===i.customerId);
          return [
            i.id, i.number, i.date, i.customerId||"", c?c.name:"", i.title||"",
            String(i.net||0), String(i.total||0), i.note||"", i.createdAt||""
          ].map(csvEscape).join(",");
        });
        return header.join(",") + "\n" + rows.join("\n") + "\n";
      }

      function makeExpensesCSV(){
        const header = ["id","date","title","category","amount","createdAt"];
        const rows = state.expenses.map(e=>[
          e.id, e.date, e.title, e.category||"", String(e.amount||0), e.createdAt||""
        ].map(csvEscape).join(","));
        return header.join(",") + "\n" + rows.join("\n") + "\n";
      }

      function downloadText(text, filename, mime){
        const blob = new Blob([text], {type: mime || "text/plain;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function toast(msg, isError=false){
        ui.toast.textContent = msg;
        ui.toast.style.borderColor = isError ? "rgba(239,68,68,.45)" : "rgba(255,255,255,.12)";
        ui.toast.style.background = isError ? "rgba(239,68,68,.12)" : "rgba(0,0,0,.55)";
        ui.toast.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 2200);
      }

      function uid(prefix){
        return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
      }
      function today(){
        const d = new Date();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${d.getFullYear()}-${mm}-${dd}`;
      }
      function fmtEUR(n){
        const v = Number(n||0);
        return v.toLocaleString("de-DE", {style:"currency", currency:"EUR"});
      }
      function round2(n){ return Math.round((Number(n)||0)*100)/100; }
      function csvEscape(v){
        const s = String(v ?? "");
        if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }
      function escapeHTML(s){
        return String(s ?? "").replace(/[&<>"']/g, (m)=>({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
        }[m]));
      }
    })();
  </script>
</body>
</html>
