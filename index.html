<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masculine Security – Mini Office (Single File)</title>

  <!-- =========================
       SINGLE-FILE: CSS HERE
       ========================= -->
  <style>
    :root{
      --bg:#061523;
      --panel:#0b2236;
      --panel2:#0c2a42;
      --card:#0e314e;
      --line:rgba(255,255,255,.08);
      --text:#e8f1ff;
      --muted:rgba(232,241,255,.72);
      --muted2:rgba(232,241,255,.55);
      --brand:#2dd4bf;
      --brand2:#38bdf8;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --focus:0 0 0 3px rgba(56,189,248,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(56,189,248,.15), transparent 60%),
                  radial-gradient(900px 700px at 85% 15%, rgba(45,212,191,.12), transparent 55%),
                  linear-gradient(180deg, #04111c, var(--bg));
      color:var(--text);
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      padding:18px;
      min-height:100%;
    }
    .sidebar{
      background: linear-gradient(180deg, rgba(11,34,54,.92), rgba(9,26,41,.92));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sideTop{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(45,212,191,.35), rgba(56,189,248,.25));
      border:1px solid rgba(255,255,255,.10);
      display:grid;place-items:center;
      font-weight:800;
      letter-spacing:.5px;
      color:#c8fbff;
      text-shadow:0 2px 18px rgba(56,189,248,.25);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;font-size:14px;line-height:1.2
    }
    .brand p{
      margin:4px 0 0;
      font-size:12px;color:var(--muted2)
    }
    .nav{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .navBtn{
      width:100%;
      background:transparent;
      border:1px solid transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      text-align:left;
      transition:.15s ease;
    }
    .navBtn:hover{
      background:rgba(255,255,255,.04);
      border-color:rgba(255,255,255,.06);
    }
    .navBtn.active{
      background:linear-gradient(135deg, rgba(56,189,248,.12), rgba(45,212,191,.10));
      border-color:rgba(56,189,248,.22);
    }
    .navLeft{
      display:flex; gap:10px; align-items:center;
      font-weight:650;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.15);
      box-shadow:0 0 0 3px rgba(255,255,255,.05);
    }
    .navBtn.active .dot{
      background:var(--brand2);
      box-shadow:0 0 0 3px rgba(56,189,248,.18);
    }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .sideBottom{
      margin-top:auto;
      padding:14px 16px;
      border-top:1px solid var(--line);
      color:var(--muted2);
      font-size:12px;
      line-height:1.35;
    }
    .main{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-radius:var(--radius2);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(12,42,66,.85), rgba(10,34,54,.85));
      box-shadow:var(--shadow);
      overflow:auto;
    }
    .crumbs{
      display:flex; flex-direction:column;
      gap:4px;
      min-width:240px;
    }
    .crumbs .title{
      font-size:14px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .crumbs .sub{
      font-size:12px;color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .actions{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:280px;
    }
    .btn{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s ease;
      font-weight:650;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(56,189,248,.20), rgba(45,212,191,.18));
      border-color:rgba(56,189,248,.28);
    }
    .btn.danger{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.25);
    }
    .btn.ok{
      background:rgba(34,197,94,.12);
      border-color:rgba(34,197,94,.25);
    }
    .content{
      display:grid;
      grid-template-columns: 1.2fr .9fr;
      gap:14px;
      min-width:0;
    }
    @media (max-width: 1050px){
      .app{grid-template-columns:1fr}
      .content{grid-template-columns:1fr}
    }
    .panel{
      border-radius:var(--radius2);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(14,49,78,.70), rgba(10,34,54,.70));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-width:0;
    }
    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .panelHead h2{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .panelHead .hint{
      font-size:12px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .panelBody{padding:14px 16px}
    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap:12px;
    }
    @media (max-width: 1050px){
      .cards{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .card .k{font-size:12px;color:var(--muted2);margin:0 0 6px}
    .card .v{font-size:18px;font-weight:900;margin:0}
    .card .s{font-size:12px;color:var(--muted2);margin:6px 0 0}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background:rgba(255,255,255,.02);
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      font-size:12px;
      color:var(--muted2);
      text-transform:uppercase;
      letter-spacing:.08em;
      background:rgba(255,255,255,.03);
    }
    .table tr:last-child td{border-bottom:none}
    .rowActions{display:flex; gap:8px; flex-wrap:wrap}
    .mini{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .mini:hover{background:rgba(255,255,255,.06)}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
    }
    .badge.ok{border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.10); color:#bff7d2}
    .badge.warn{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.10); color:#ffe1b2}
    .badge.danger{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.10); color:#ffd0d0}

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 1050px){
      .formGrid{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted2);
      margin:0 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      transition:.15s ease;
      font-family:inherit;
      font-size:13px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--focus); border-color:rgba(56,189,248,.35)}
    .formRow{min-width:0}
    .helper{
      font-size:12px;color:var(--muted2);
      margin-top:8px;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 1050px){
      .split{grid-template-columns:1fr}
    }
    .hr{
      height:1px;background:rgba(255,255,255,.08);
      margin:12px 0;
    }

    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      min-width:260px;
      max-width:420px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,26,41,.92);
      box-shadow:var(--shadow);
      color:var(--text);
      display:none;
      z-index:9999;
    }
    .toast.show{display:block}
    .toast .t{font-weight:900;margin:0 0 4px}
    .toast .m{margin:0;color:var(--muted);font-size:13px}
    .smallNote{
      font-size:12px;color:var(--muted2);
      margin-top:10px;
    }
    .kbd{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:2px 6px;
      border-radius:8px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sideTop">
        <div class="logo">MS</div>
        <div class="brand">
          <h1 id="sideBrand">Masculine Security</h1>
          <p id="sideSub">Mini Office • Offline (local)</p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="navBtn active" data-page="dashboard">
          <div class="navLeft"><span class="dot"></span>Übersicht</div>
          <span class="pill" id="pillKpi">KPIs</span>
        </button>

        <button class="navBtn" data-page="customers">
          <div class="navLeft"><span class="dot"></span>Kunden</div>
          <span class="pill" id="pillCustomers">0</span>
        </button>

        <button class="navBtn" data-page="invoices">
          <div class="navLeft"><span class="dot"></span>Rechnungen</div>
          <span class="pill" id="pillInvoices">0</span>
        </button>

        <button class="navBtn" data-page="expenses">
          <div class="navLeft"><span class="dot"></span>Ausgaben</div>
          <span class="pill" id="pillExpenses">0</span>
        </button>

        <button class="navBtn" data-page="lohn">
          <div class="navLeft"><span class="dot"></span>Lohnabrechnung</div>
          <span class="pill" id="pillLohn">0</span>
        </button>

        <button class="navBtn" data-page="tax">
          <div class="navLeft"><span class="dot"></span>Einkommensteuer</div>
          <span class="pill" id="pillTaxYear">2026</span>
        </button>

        <button class="navBtn" data-page="emailpdf">
          <div class="navLeft"><span class="dot"></span>Email + PDF</div>
          <span class="pill">Export</span>
        </button>

        <button class="navBtn" data-page="settings">
          <div class="navLeft"><span class="dot"></span>Einstellungen</div>
          <span class="pill">Backup</span>
        </button>
      </nav>

      <div class="sideBottom" id="sideBottom">
        Tipp: GitHub commit = Netlify auto deploy.<br/>
        Hard refresh: <span class="kbd">Ctrl</span> + <span class="kbd">Shift</span> + <span class="kbd">R</span><br/>
        Version: <b id="appVersion">v1.0 (single-file)</b>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="crumbs">
          <div class="title" id="pageTitle">Übersicht</div>
          <div class="sub" id="pageSub">Umsatz • Ausgaben • Kunden • Rechnungen (offline)</div>
        </div>
        <div class="actions">
          <button class="btn primary" id="quickInvoice">+ Rechnung</button>
          <button class="btn primary" id="quickCustomer">+ Kunde</button>
          <button class="btn primary" id="quickExpense">+ Ausgabe</button>
          <button class="btn" id="quickExport">Export</button>
          <button class="btn" id="quickImport">Import</button>
        </div>
      </div>

      <div class="content">
        <section class="panel" id="leftPanel">
          <div class="panelHead">
            <h2 id="leftTitle">KPIs</h2>
            <div class="hint" id="leftHint">Lexoffice-Style Navigation, Aktionen, Daten offline.</div>
          </div>
          <div class="panelBody" id="leftBody"></div>
        </section>

        <section class="panel" id="rightPanel">
          <div class="panelHead">
            <h2 id="rightTitle">Letzte Aktivitäten</h2>
            <div class="hint" id="rightHint"><span id="activityCount">0</span> Einträge</div>
          </div>
          <div class="panelBody" id="rightBody"></div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <p class="t" id="toastTitle">OK</p>
    <p class="m" id="toastMsg">Gespeichert.</p>
  </div>

  <!-- =========================
       SINGLE-FILE: JS HERE
       (Protected from redeclare)
       ========================= -->
  <script>
  (function(){
    // Prevent "Identifier already declared" if CodePen injects/re-runs.
    if (window.__MS_MINIOFFICE_INIT__) return;
    window.__MS_MINIOFFICE_INIT__ = true;

    const APP_VERSION = "1.0-singlefile";
    const LS_KEY = "ms_mini_office_singlefile_v1";

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function nowISO(){ return new Date().toISOString(); }
    function toDateInputValue(d=new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function euro(n){
      const x = Number(n||0);
      return x.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2}) + " €";
    }
    function safeParseJSON(text){
      try{ return JSON.parse(text); }catch(e){ return null; }
    }
    function toast(title, msg){
      const t = $("#toast");
      $("#toastTitle").textContent = title;
      $("#toastMsg").textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.remove("show"), 2200);
    }

    const defaultState = () => ({
      meta: {
        version: APP_VERSION,
        createdAt: nowISO(),
        updatedAt: nowISO()
      },
      profile: {
        company: "Masculine Security",
        email: "kontakt.mass.bremen@hotmail.com",
        phone: "",
        address: "Werschenregerstraße 6\n28237 Bremen",
        iban: "DE98 1001 1001 2333 0146 96",
        bic: "NTSBDEB1XXX",
        bank: "N26",
        taxId: "",
        ustId: "",
        kleinunternehmer: true,  // default: Kleinunternehmerregelung
        steuernummer: ""
      },
      counters: {
        invoiceSeq: 1
      },
      customers: [],
      invoices: [],
      expenses: [],
      payroll: [], // lohnabrechnung entries
      tax: {
        year: new Date().getFullYear(),
        notes: ""
      },
      ui: {
        page: "dashboard"
      }
    });

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const parsed = safeParseJSON(raw);
      if(!parsed) return defaultState();
      // minimal merge
      const base = defaultState();
      return deepMerge(base, parsed);
    }

    function deepMerge(target, source){
      if(typeof target !== "object" || target === null) return source;
      if(typeof source !== "object" || source === null) return target;
      for(const k of Object.keys(source)){
        const sv = source[k];
        const tv = target[k];
        if(Array.isArray(sv)){
          target[k] = sv.slice();
        } else if(typeof sv === "object" && sv !== null){
          target[k] = deepMerge((typeof tv==="object" && tv!==null && !Array.isArray(tv)) ? tv : {}, sv);
        } else {
          target[k] = sv;
        }
      }
      return target;
    }

    let state = loadState();

    function saveState(){
      state.meta.updatedAt = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      updateBadges();
    }

    // NAV
    const nav = $("#nav");
    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest(".navBtn");
      if(!btn) return;
      showPage(btn.dataset.page);
    });

    // Topbar quick actions
    $("#quickInvoice").addEventListener("click", ()=>{ showPage("invoices"); focusFirst("#invNumber"); });
    $("#quickCustomer").addEventListener("click", ()=>{ showPage("customers"); focusFirst("#custName"); });
    $("#quickExpense").addEventListener("click", ()=>{ showPage("expenses"); focusFirst("#expTitle"); });

    $("#quickExport").addEventListener("click", ()=>{ showPage("settings"); doExportJSON(); });
    $("#quickImport").addEventListener("click", ()=>{ showPage("settings"); $("#importFile").click(); });

    function setActiveNav(page){
      $$(".navBtn").forEach(b=>b.classList.toggle("active", b.dataset.page===page));
    }

    function showPage(page){
      state.ui.page = page;
      saveState();
      setActiveNav(page);
      render();
    }

    function updateBadges(){
      $("#pillCustomers").textContent = state.customers.length;
      $("#pillInvoices").textContent = state.invoices.length;
      $("#pillExpenses").textContent = state.expenses.length;
      $("#pillLohn").textContent = state.payroll.length;
      $("#pillTaxYear").textContent = state.tax.year || new Date().getFullYear();
    }

    function focusFirst(sel){
      setTimeout(()=>{
        const el = $(sel);
        if(el) el.focus();
      }, 60);
    }

    // KPI calculations
    function monthKey(d){ // yyyy-mm
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    function getMonthTotals(){
      const mk = monthKey(new Date());
      const inv = state.invoices.filter(x=>monthKey(x.date)===mk && x.status!=="storniert");
      const exp = state.expenses.filter(x=>monthKey(x.date)===mk);
      const revenueNet = inv.reduce((a,x)=>a+Number(x.net||0),0);
      const revenueVat = inv.reduce((a,x)=>a+Number(x.vatAmount||0),0);
      const revenueGross = inv.reduce((a,x)=>a+Number(x.gross||0),0);
      const expenseSum = exp.reduce((a,x)=>a+Number(x.amount||0),0);
      return { revenueNet, revenueVat, revenueGross, expenseSum, invCount: inv.length };
    }

    function getYearTotals(){
      const y = new Date().getFullYear();
      const inv = state.invoices.filter(x=> new Date(x.date).getFullYear()===y && x.status!=="storniert");
      const exp = state.expenses.filter(x=> new Date(x.date).getFullYear()===y);
      const revenueNet = inv.reduce((a,x)=>a+Number(x.net||0),0);
      const revenueVat = inv.reduce((a,x)=>a+Number(x.vatAmount||0),0);
      const revenueGross = inv.reduce((a,x)=>a+Number(x.gross||0),0);
      const expenseSum = exp.reduce((a,x)=>a+Number(x.amount||0),0);
      return { revenueNet, revenueVat, revenueGross, expenseSum, invCount: inv.length };
    }

    // Render
    function render(){
      $("#appVersion").textContent = "v"+APP_VERSION+" (single-file)";
      $("#sideBrand").textContent = state.profile.company || "Masculine Security";

      updateBadges();

      const page = state.ui.page || "dashboard";
      setActiveNav(page);

      if(page==="dashboard"){
        $("#pageTitle").textContent = "Übersicht";
        $("#pageSub").textContent = "Umsatz • Ausgaben • Kunden • Rechnungen (offline)";
        $("#leftTitle").textContent = "KPIs";
        $("#leftHint").textContent = "Übersicht für diesen Monat & dieses Jahr.";
        $("#leftBody").innerHTML = renderDashboardLeft();
        $("#rightTitle").textContent = "Letzte Aktivitäten";
        $("#rightHint").textContent = `${getActivities().length} Einträge`;
        $("#rightBody").innerHTML = renderActivities();
        bindActivitiesActions();
        return;
      }

      if(page==="customers"){
        $("#pageTitle").textContent = "Kunden";
        $("#pageSub").textContent = "Kunden anlegen • bearbeiten • exportieren";
        $("#leftTitle").textContent = "Kunde anlegen";
        $("#leftHint").textContent = "Daten werden lokal gespeichert (LocalStorage).";
        $("#leftBody").innerHTML = renderCustomersForm();
        $("#rightTitle").textContent = "Kundenliste";
        $("#rightHint").textContent = `${state.customers.length} Kunden`;
        $("#rightBody").innerHTML = renderCustomersTable();
        bindCustomers();
        return;
      }

      if(page==="invoices"){
        $("#pageTitle").textContent = "Rechnungen";
        $("#pageSub").textContent = "Rechnung erstellen • PDF öffnen • Status";
        $("#leftTitle").textContent = "Rechnung erstellen";
        $("#leftHint").textContent = state.profile.kleinunternehmer
          ? "Kleinunternehmer: Brutto = Netto, USt = 0%."
          : "Regelbesteuerung: Netto + USt = Brutto.";
        $("#leftBody").innerHTML = renderInvoiceForm();
        $("#rightTitle").textContent = "Rechnungen";
        $("#rightHint").textContent = `${state.invoices.length} Einträge`;
        $("#rightBody").innerHTML = renderInvoicesTable();
        bindInvoices();
        return;
      }

      if(page==="expenses"){
        $("#pageTitle").textContent = "Ausgaben";
        $("#pageSub").textContent = "Ausgaben erfassen • Kategorien • Export";
        $("#leftTitle").textContent = "Ausgabe erfassen";
        $("#leftHint").textContent = "Für Büro, Fahrt, Material, Subunternehmer etc.";
        $("#leftBody").innerHTML = renderExpenseForm();
        $("#rightTitle").textContent = "Ausgabenliste";
        $("#rightHint").textContent = `${state.expenses.length} Einträge`;
        $("#rightBody").innerHTML = renderExpensesTable();
        bindExpenses();
        return;
      }

      if(page==="lohn"){
        $("#pageTitle").textContent = "Lohnabrechnung";
        $("#pageSub").textContent = "Einträge • Notizen • PDF/Export";
        $("#leftTitle").textContent = "Lohn-Eintrag";
        $("#leftHint").textContent = "Einfacher Lohnzettel (Demo).";
        $("#leftBody").innerHTML = renderPayrollForm();
        $("#rightTitle").textContent = "Lohnliste";
        $("#rightHint").textContent = `${state.payroll.length} Einträge`;
        $("#rightBody").innerHTML = renderPayrollTable();
        bindPayroll();
        return;
      }

      if(page==="tax"){
        $("#pageTitle").textContent = "Einkommensteuer";
        $("#pageSub").textContent = "Jahr • Notizen • Zusammenfassung";
        $("#leftTitle").textContent = "Steuer-Notizen";
        $("#leftHint").textContent = "Dieses Modul ist eine Offline-Notiz + Summen.";
        $("#leftBody").innerHTML = renderTaxPanel();
        $("#rightTitle").textContent = "Zusammenfassung";
        $("#rightHint").textContent = "Umsatz/Ausgaben (Jahr)";
        $("#rightBody").innerHTML = renderTaxSummary();
        bindTax();
        return;
      }

      if(page==="emailpdf"){
        $("#pageTitle").textContent = "Email + PDF";
        $("#pageSub").textContent = "PDF speichern + Email (mailto) öffnen";
        $("#leftTitle").textContent = "Email (mailto) + PDF";
        $("#leftHint").textContent = "Browser öffnet Email-App. PDF per Drucken speichern.";
        $("#leftBody").innerHTML = renderEmailPdf();
        $("#rightTitle").textContent = "Dokumente";
        $("#rightHint").textContent = "Vorlagen";
        $("#rightBody").innerHTML = renderTemplatesList();
        bindEmailPdf();
        return;
      }

      if(page==="settings"){
        $("#pageTitle").textContent = "Einstellungen";
        $("#pageSub").textContent = "Profil • Kleinunternehmer • Backup/Restore • CSV • Reset";
        $("#leftTitle").textContent = "Profil";
        $("#leftHint").textContent = "Firma, Bank, Adresse, Kleinunternehmer.";
        $("#leftBody").innerHTML = renderSettingsProfile();
        $("#rightTitle").textContent = "Backup / Restore";
        $("#rightHint").textContent = "JSON / CSV / Reset";
        $("#rightBody").innerHTML = renderSettingsBackup();
        bindSettings();
        return;
      }

      // fallback
      showPage("dashboard");
    }

    function getActivities(){
      const list = [];
      // recent invoices
      state.invoices.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,6).forEach(inv=>{
        list.push({
          type:"Rechnung",
          title:`${inv.number} • ${getCustomerName(inv.customerId)} • ${euro(inv.gross)} • ${formatDate(inv.date)}`,
          date: inv.date,
          id: inv.id,
          kind:"invoice"
        });
      });
      state.expenses.slice().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,6).forEach(ex=>{
        list.push({
          type:"Ausgabe",
          title:`${ex.title} • ${euro(ex.amount)} • ${formatDate(ex.date)}`,
          date: ex.date,
          id: ex.id,
          kind:"expense"
        });
      });
      // sort combined
      list.sort((a,b)=>new Date(b.date)-new Date(a.date));
      return list.slice(0,10);
    }

    function formatDate(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleDateString("de-DE");
      }catch{ return d; }
    }

    function renderDashboardLeft(){
      const m = getMonthTotals();
      const y = getYearTotals();

      return `
        <div class="cards">
          <div class="card">
            <p class="k">Umsatz (diesen Monat)</p>
            <p class="v">${euro(m.revenueGross)}</p>
            <p class="s">${state.profile.kleinunternehmer ? "Kleinunternehmer: Brutto=Netto" : ("USt: "+euro(m.revenueVat)+" • Netto: "+euro(m.revenueNet))}</p>
          </div>
          <div class="card">
            <p class="k">Ausgaben (diesen Monat)</p>
            <p class="v">${euro(m.expenseSum)}</p>
            <p class="s">Einträge: ${state.expenses.filter(x=>monthKey(x.date)===monthKey(new Date())).length}</p>
          </div>
          <div class="card">
            <p class="k">Umsatz (dieses Jahr)</p>
            <p class="v">${euro(y.revenueGross)}</p>
            <p class="s">${state.profile.kleinunternehmer ? "USt: 0,00 €" : ("USt: "+euro(y.revenueVat)+" • Netto: "+euro(y.revenueNet))}</p>
          </div>
        </div>

        <div class="hr"></div>

        <div class="panel" style="border:none;background:transparent;box-shadow:none">
          <div class="panelHead" style="padding:0 0 10px;border:none">
            <h2 style="margin:0;font-size:13px">Schnellstart</h2>
            <div class="hint">Aktionen</div>
          </div>
          <div class="panelBody" style="padding:0">
            <div class="actions" style="justify-content:flex-start">
              <button class="btn primary" id="dashNewInvoice">+ Rechnung</button>
              <button class="btn primary" id="dashNewCustomer">+ Kunde</button>
              <button class="btn primary" id="dashNewExpense">+ Ausgabe</button>
            </div>
            <div class="smallNote">Tipp: Export/Import oben rechts für Backup.</div>
          </div>
        </div>
      `;
    }

    function renderActivities(){
      const acts = getActivities();
      $("#activityCount").textContent = acts.length;
      if(!acts.length){
        return `<div class="helper">Noch keine Aktivitäten. Erstelle zuerst Kunden/Rechnungen/Ausgaben.</div>`;
      }
      return `
        <table class="table">
          <thead>
            <tr>
              <th style="width:90px">Typ</th>
              <th>Eintrag</th>
              <th style="width:110px">Datum</th>
              <th style="width:170px">Aktion</th>
            </tr>
          </thead>
          <tbody>
            ${acts.map(a=>`
              <tr>
                <td><span class="badge">${a.type}</span></td>
                <td>${escapeHtml(a.title)}</td>
                <td>${formatDate(a.date)}</td>
                <td class="rowActions">
                  <button class="mini" data-go="${a.kind}">Öffnen</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function bindActivitiesActions(){
      const tbody = $("#rightBody");
      if(!tbody) return;
      tbody.addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-go]");
        if(!btn) return;
        const kind = btn.dataset.go;
        if(kind==="invoice") showPage("invoices");
        if(kind==="expense") showPage("expenses");
      }, { once:true });
      // bind dashboard quick buttons
      const a = $("#dashNewInvoice"); if(a) a.onclick = ()=>{ showPage("invoices"); focusFirst("#invNumber"); };
      const b = $("#dashNewCustomer"); if(b) b.onclick = ()=>{ showPage("customers"); focusFirst("#custName"); };
      const c = $("#dashNewExpense"); if(c) c.onclick = ()=>{ showPage("expenses"); focusFirst("#expTitle"); };
    }

    // CUSTOMERS
    function renderCustomersForm(){
      return `
        <div class="formGrid">
          <div class="formRow">
            <label for="custName">Name / Firma</label>
            <input id="custName" name="custName" placeholder="z.B. Beispiel Kunde GmbH" />
          </div>
          <div class="formRow">
            <label for="custEmail">Email</label>
            <input id="custEmail" name="custEmail" placeholder="z.B. kunde@firma.de" />
          </div>
          <div class="formRow">
            <label for="custPhone">Telefon</label>
            <input id="custPhone" name="custPhone" placeholder="+49 ..." />
          </div>
          <div class="formRow">
            <label for="custVat">USt-Id / Hinweis</label>
            <input id="custVat" name="custVat" placeholder="optional" />
          </div>
          <div class="formRow" style="grid-column:1/-1">
            <label for="custAddr">Adresse</label>
            <textarea id="custAddr" name="custAddr" placeholder="Straße, PLZ Ort"></textarea>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="custSave">Speichern</button>
          <button class="btn" id="custClear">Leeren</button>
          <button class="btn" id="custCsv">Kunden CSV</button>
        </div>
        <div class="helper">Hinweis: Daten bleiben lokal im Browser gespeichert.</div>
      `;
    }

    function renderCustomersTable(){
      if(!state.customers.length){
        return `<div class="helper">Keine Kunden vorhanden.</div>`;
      }
      return `
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Telefon</th>
              <th style="width:210px">Aktion</th>
            </tr>
          </thead>
          <tbody>
            ${state.customers.map(c=>`
              <tr>
                <td><b>${escapeHtml(c.name)}</b><div class="smallNote">${escapeHtml((c.address||"").split("\n")[0]||"")}</div></td>
                <td>${c.email ? `<a href="mailto:${escapeAttr(c.email)}">${escapeHtml(c.email)}</a>` : `<span class="helper">–</span>`}</td>
                <td>${c.phone ? escapeHtml(c.phone) : `<span class="helper">–</span>`}</td>
                <td class="rowActions">
                  <button class="mini" data-edit-cust="${c.id}">Bearbeiten</button>
                  <button class="mini" data-del-cust="${c.id}">Löschen</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function bindCustomers(){
      $("#custSave").onclick = ()=>{
        const name = $("#custName").value.trim();
        if(!name){ toast("Fehler","Name ist Pflicht."); return; }
        const cust = {
          id: cryptoId(),
          name,
          email: $("#custEmail").value.trim(),
          phone: $("#custPhone").value.trim(),
          vat: $("#custVat").value.trim(),
          address: $("#custAddr").value.trim(),
          createdAt: nowISO()
        };
        state.customers.push(cust);
        saveState();
        toast("OK","Kunde gespeichert.");
        render();
        focusFirst("#custName");
      };
      $("#custClear").onclick = ()=> clearCustomerForm();
      $("#custCsv").onclick = ()=> downloadCSV("kunden.csv", customersToCSV());

      $("#rightBody").onclick = (e)=>{
        const ed = e.target.closest("[data-edit-cust]");
        const dl = e.target.closest("[data-del-cust]");
        if(ed){
          const id = ed.getAttribute("data-edit-cust");
          const c = state.customers.find(x=>x.id===id);
          if(!c) return;
          $("#custName").value = c.name||"";
          $("#custEmail").value = c.email||"";
          $("#custPhone").value = c.phone||"";
          $("#custVat").value = c.vat||"";
          $("#custAddr").value = c.address||"";
          // replace save to update
          $("#custSave").textContent = "Aktualisieren";
          $("#custSave").classList.add("primary");
          $("#custSave").onclick = ()=>{
            c.name = $("#custName").value.trim();
            if(!c.name){ toast("Fehler","Name ist Pflicht."); return; }
            c.email = $("#custEmail").value.trim();
            c.phone = $("#custPhone").value.trim();
            c.vat = $("#custVat").value.trim();
            c.address = $("#custAddr").value.trim();
            saveState();
            toast("OK","Kunde aktualisiert.");
            render();
          };
          toast("Info","Kunde geladen.");
          focusFirst("#custName");
        }
        if(dl){
          const id = dl.getAttribute("data-del-cust");
          if(!confirm("Kunde löschen?")) return;
          state.customers = state.customers.filter(x=>x.id!==id);
          // also detach from invoices
          state.invoices.forEach(inv=>{ if(inv.customerId===id) inv.customerId=""; });
          saveState();
          toast("OK","Kunde gelöscht.");
          render();
        }
      };
    }

    function clearCustomerForm(){
      $("#custName").value = "";
      $("#custEmail").value = "";
      $("#custPhone").value = "";
      $("#custVat").value = "";
      $("#custAddr").value = "";
      toast("OK","Formular geleert.");
    }

    // INVOICES
    function nextInvoiceNumber(){
      const year = new Date().getFullYear();
      const seq = state.counters.invoiceSeq || 1;
      return `RE-${year}-${String(seq).padStart(4,"0")}`;
    }

    function renderInvoiceForm(){
      const number = nextInvoiceNumber();
      const date = toDateInputValue();
      const custOptions = state.customers.length
        ? state.customers.map(c=>`<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)}</option>`).join("")
        : `<option value="">(Keine Kunden – zuerst Kunden anlegen)</option>`;

      const klein = !!state.profile.kleinunternehmer;
      return `
        <div class="formGrid">
          <div class="formRow">
            <label for="invNumber">Rechnungs-Nr.</label>
            <input id="invNumber" value="${escapeAttr(number)}" />
          </div>
          <div class="formRow">
            <label for="invDate">Datum</label>
            <input id="invDate" type="date" value="${escapeAttr(date)}" />
          </div>

          <div class="formRow" style="grid-column:1/-1">
            <label for="invCustomer">Kunde</label>
            <select id="invCustomer">
              <option value="">— Kunde wählen —</option>
              ${custOptions}
            </select>
          </div>

          <div class="formRow" style="grid-column:1/-1">
            <label for="invDesc">Leistung / Beschreibung</label>
            <input id="invDesc" placeholder="z.B. Objektschutz 12h" />
          </div>

          <div class="formRow">
            <label for="invNet">Betrag ${klein ? "(Brutto/Netto gleich)" : "Netto (€)"}</label>
            <input id="invNet" type="number" step="0.01" value="0.00" />
          </div>

          <div class="formRow">
            <label for="invVatRate">USt % ${klein ? "(0% Kleinunternehmer)" : ""}</label>
            <select id="invVatRate" ${klein ? "disabled" : ""}>
              <option value="0" ${klein ? "selected" : ""}>0</option>
              <option value="7">7</option>
              <option value="19">19</option>
            </select>
          </div>

          <div class="formRow">
            <label for="invStatus">Status</label>
            <select id="invStatus">
              <option value="entwurf">Entwurf</option>
              <option value="gesendet">Gesendet</option>
              <option value="bezahlt">Bezahlt</option>
              <option value="storniert">Storniert</option>
            </select>
          </div>

          <div class="formRow">
            <label>Hinweis</label>
            <div class="badge ${klein ? "ok" : "warn"}">
              ${klein ? "Kleinunternehmerregelung aktiv" : "Regelbesteuerung aktiv"}
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="invSave">Speichern</button>
          <button class="btn" id="invPdf">PDF öffnen</button>
          <button class="btn" id="invClear">Leeren</button>
        </div>

        <div class="helper">
          ${klein
            ? `Kleinunternehmer: <b>Netto = Brutto</b> und <b>USt = 0%</b>. Rechnungstext enthält den Hinweis.`
            : `Regelbesteuerung: <b>Brutto = Netto + USt</b>.`
          }
        </div>
      `;
    }

    function renderInvoicesTable(){
      if(!state.invoices.length){
        return `<div class="helper">Keine Rechnungen vorhanden.</div>`;
      }
      return `
        <table class="table">
          <thead>
            <tr>
              <th>Nr.</th>
              <th>Kunde</th>
              <th>Datum</th>
              <th>Betrag</th>
              <th>Status</th>
              <th style="width:260px">Aktion</th>
            </tr>
          </thead>
          <tbody>
            ${state.invoices.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).map(inv=>{
              const st = inv.status || "entwurf";
              const badgeClass = st==="bezahlt" ? "ok" : (st==="gesendet" ? "warn" : (st==="storniert" ? "danger" : ""));
              return `
                <tr>
                  <td><b>${escapeHtml(inv.number)}</b></td>
                  <td>${escapeHtml(getCustomerName(inv.customerId) || "—")}</td>
                  <td>${formatDate(inv.date)}</td>
                  <td><b>${euro(inv.gross)}</b><div class="smallNote">${state.profile.kleinunternehmer ? "USt: 0,00 €" : ("USt: "+euro(inv.vatAmount))}</div></td>
                  <td><span class="badge ${badgeClass}">${escapeHtml(cap(st))}</span></td>
                  <td class="rowActions">
                    <button class="mini" data-open-inv="${inv.id}">Öffnen</button>
                    <button class="mini" data-pdf-inv="${inv.id}">PDF</button>
                    <button class="mini" data-del-inv="${inv.id}">Löschen</button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    function bindInvoices(){
      const klein = !!state.profile.kleinunternehmer;

      function calcAmounts(net, vatRate){
        const n = Number(net||0);
        const r = Number(vatRate||0);
        const vatAmount = klein ? 0 : (n * (r/100));
        const gross = klein ? n : (n + vatAmount);
        return { net:n, vatRate:r, vatAmount, gross };
      }

      $("#invClear").onclick = ()=>{ render(); toast("OK","Leeren."); };
      $("#invSave").onclick = ()=>{
        const number = $("#invNumber").value.trim() || nextInvoiceNumber();
        const date = $("#invDate").value || toDateInputValue();
        const customerId = $("#invCustomer").value || "";
        const desc = $("#invDesc").value.trim();
        const netIn = $("#invNet").value;
        const vatRate = klein ? 0 : Number($("#invVatRate").value || 0);
        const status = $("#invStatus").value || "entwurf";

        if(!desc){ toast("Fehler","Beschreibung ist Pflicht."); return; }
        if(!number){ toast("Fehler","Rechnungsnummer fehlt."); return; }

        const { net, vatAmount, gross } = calcAmounts(netIn, vatRate);

        const inv = {
          id: cryptoId(),
          number,
          date,
          customerId,
          desc,
          net,
          vatRate,
          vatAmount,
          gross,
          status,
          createdAt: nowISO()
        };
        state.invoices.push(inv);
        // increment seq if this looks like our pattern for current year
        state.counters.invoiceSeq = (state.counters.invoiceSeq||1) + 1;
        saveState();
        toast("OK","Rechnung gespeichert.");
        render();
      };

      $("#invPdf").onclick = ()=>{
        // build a temporary preview from current form values
        const tmp = {
          id: "tmp",
          number: $("#invNumber").value.trim() || nextInvoiceNumber(),
          date: $("#invDate").value || toDateInputValue(),
          customerId: $("#invCustomer").value || "",
          desc: $("#invDesc").value.trim() || "—",
          net: Number($("#invNet").value||0),
          vatRate: klein ? 0 : Number($("#invVatRate").value||0),
          status: $("#invStatus").value || "entwurf"
        };
        const c = calcAmounts(tmp.net, tmp.vatRate);
        tmp.vatAmount = c.vatAmount;
        tmp.gross = c.gross;
        openInvoicePrint(tmp);
      };

      $("#rightBody").onclick = (e)=>{
        const open = e.target.closest("[data-open-inv]");
        const pdf = e.target.closest("[data-pdf-inv]");
        const del = e.target.closest("[data-del-inv]");
        if(open){
          const id = open.getAttribute("data-open-inv");
          const inv = state.invoices.find(x=>x.id===id);
          if(!inv) return;
          // load into form
          $("#invNumber").value = inv.number||"";
          $("#invDate").value = inv.date || toDateInputValue();
          $("#invCustomer").value = inv.customerId || "";
          $("#invDesc").value = inv.desc || "";
          $("#invNet").value = String(inv.net ?? 0);
          if(!klein && $("#invVatRate")) $("#invVatRate").value = String(inv.vatRate ?? 0);
          $("#invStatus").value = inv.status || "entwurf";

          $("#invSave").textContent = "Aktualisieren";
          $("#invSave").classList.add("primary");
          $("#invSave").onclick = ()=>{
            inv.number = $("#invNumber").value.trim() || inv.number;
            inv.date = $("#invDate").value || inv.date;
            inv.customerId = $("#invCustomer").value || "";
            inv.desc = $("#invDesc").value.trim();
            const netIn = $("#invNet").value;
            inv.vatRate = klein ? 0 : Number($("#invVatRate").value||0);
            const c = calcAmounts(netIn, inv.vatRate);
            inv.net = c.net;
            inv.vatAmount = c.vatAmount;
            inv.gross = c.gross;
            inv.status = $("#invStatus").value || inv.status;
            saveState();
            toast("OK","Rechnung aktualisiert.");
            render();
          };

          toast("Info","Rechnung geladen.");
          focusFirst("#invDesc");
        }
        if(pdf){
          const id = pdf.getAttribute("data-pdf-inv");
          const inv = state.invoices.find(x=>x.id===id);
          if(!inv) return;
          openInvoicePrint(inv);
        }
        if(del){
          const id = del.getAttribute("data-del-inv");
          if(!confirm("Rechnung löschen?")) return;
          state.invoices = state.invoices.filter(x=>x.id!==id);
          saveState();
          toast("OK","Rechnung gelöscht.");
          render();
        }
      };
    }

    function openInvoicePrint(inv){
      const cust = state.customers.find(c=>c.id===inv.customerId) || null;
      const p = state.profile;
      const klein = !!p.kleinunternehmer;

      // Important: Kleinunternehmer -> show amount as "Betrag" and VAT 0, but invoice still needs amounts.
      const vatLine = klein
        ? `<div><b>USt:</b> 0,00 € (Kleinunternehmerregelung)</div>`
        : `<div><b>USt (${inv.vatRate||0}%):</b> ${euro(inv.vatAmount)}</div>`;

      const kleinText = klein
        ? `<p style="margin:10px 0 0;color:#444;font-size:12px">
             Hinweis: Gemäß § 19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).
           </p>`
        : "";

      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Rechnung ${escapeHtml(inv.number)}</title>
<style>
  body{font-family:Arial, sans-serif; margin:30px; color:#111}
  .top{display:flex; justify-content:space-between; gap:18px}
  .box{border:1px solid #ddd; padding:14px; border-radius:10px}
  h1{margin:0 0 8px; font-size:18px}
  h2{margin:0 0 8px; font-size:14px}
  .muted{color:#555; font-size:12px}
  table{width:100%; border-collapse:collapse; margin-top:18px}
  th,td{border-bottom:1px solid #eee; padding:10px 6px; text-align:left}
  th{text-transform:uppercase; letter-spacing:.08em; font-size:11px; color:#555}
  .sum{margin-top:14px; display:flex; justify-content:flex-end}
  .sum .box{min-width:320px}
  .right{text-align:right}
</style>
</head>
<body>
  <div class="top">
    <div style="flex:1" class="box">
      <h1>${escapeHtml(p.company||"Masculine Security")}</h1>
      <div class="muted" style="white-space:pre-line">${escapeHtml(p.address||"")}</div>
      <div class="muted" style="margin-top:8px">
        Email: ${escapeHtml(p.email||"")}<br/>
        Bank: ${escapeHtml(p.bank||"")} • IBAN: ${escapeHtml(p.iban||"")} • BIC: ${escapeHtml(p.bic||"")}
      </div>
    </div>

    <div style="width:320px" class="box">
      <h2>Rechnung</h2>
      <div><b>Nr.:</b> ${escapeHtml(inv.number)}</div>
      <div><b>Datum:</b> ${escapeHtml(formatDate(inv.date))}</div>
      <div><b>Status:</b> ${escapeHtml(cap(inv.status||"entwurf"))}</div>
    </div>
  </div>

  <div class="box" style="margin-top:14px">
    <h2>Kunde</h2>
    ${cust ? `
      <div><b>${escapeHtml(cust.name||"")}</b></div>
      <div class="muted" style="white-space:pre-line">${escapeHtml(cust.address||"")}</div>
      <div class="muted">${cust.email?("Email: "+escapeHtml(cust.email)):""}</div>
    ` : `<div class="muted">Kein Kunde ausgewählt.</div>`}
  </div>

  <table>
    <thead>
      <tr>
        <th>Leistung</th>
        <th class="right">Betrag</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>${escapeHtml(inv.desc||"")}</td>
        <td class="right">${euro(inv.net)}</td>
      </tr>
    </tbody>
  </table>

  <div class="sum">
    <div class="box">
      <div><b>Netto:</b> ${euro(inv.net)}</div>
      ${vatLine}
      <div style="margin-top:8px;font-size:16px"><b>Brutto:</b> ${euro(inv.gross)}</div>
      ${kleinText}
    </div>
  </div>

  <p class="muted" style="margin-top:16px">
    Zahlungsziel: 7 Tage • Bitte geben Sie die Rechnungsnummer als Verwendungszweck an.
  </p>
</body>
</html>
      `.trim();

      const w = window.open("", "_blank");
      if(!w){ toast("Blockiert","Popup blockiert. Erlaube Popups."); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      setTimeout(()=>{ w.print(); }, 350);
    }

    function getCustomerName(id){
      if(!id) return "";
      const c = state.customers.find(x=>x.id===id);
      return c ? c.name : "";
    }

    // EXPENSES
    function renderExpenseForm(){
      return `
        <div class="formGrid">
          <div class="formRow" style="grid-column:1/-1">
            <label for="expTitle">Titel</label>
            <input id="expTitle" placeholder="z.B. Büromaterial / Fahrtkosten" />
          </div>
          <div class="formRow">
            <label for="expDate">Datum</label>
            <input id="expDate" type="date" value="${escapeAttr(toDateInputValue())}" />
          </div>
          <div class="formRow">
            <label for="expAmount">Betrag (€)</label>
            <input id="expAmount" type="number" step="0.01" value="0.00" />
          </div>
          <div class="formRow">
            <label for="expCat">Kategorie</label>
            <select id="expCat">
              <option value="Büro">Büro</option>
              <option value="Fahrt">Fahrt</option>
              <option value="Material">Material</option>
              <option value="Subunternehmer">Subunternehmer</option>
              <option value="Versicherung">Versicherung</option>
              <option value="Sonstiges">Sonstiges</option>
            </select>
          </div>
          <div class="formRow">
            <label for="expPay">Zahlungsart</label>
            <select id="expPay">
              <option value="Bar">Bar</option>
              <option value="Karte">Karte</option>
              <option value="Überweisung">Überweisung</option>
            </select>
          </div>
          <div class="formRow" style="grid-column:1/-1">
            <label for="expNote">Notiz</label>
            <textarea id="expNote" placeholder="optional"></textarea>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="expSave">Speichern</button>
          <button class="btn" id="expClear">Leeren</button>
          <button class="btn" id="expCsv">Ausgaben CSV</button>
        </div>
        <div class="helper">Ausgaben zählen automatisch in KPIs.</div>
      `;
    }

    function renderExpensesTable(){
      if(!state.expenses.length){
        return `<div class="helper">Keine Ausgaben vorhanden.</div>`;
      }
      return `
        <table class="table">
          <thead>
            <tr>
              <th>Titel</th>
              <th>Kategorie</th>
              <th>Datum</th>
              <th>Betrag</th>
              <th style="width:210px">Aktion</th>
            </tr>
          </thead>
          <tbody>
            ${state.expenses.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).map(ex=>`
              <tr>
                <td><b>${escapeHtml(ex.title)}</b><div class="smallNote">${escapeHtml(ex.note||"")}</div></td>
                <td><span class="badge">${escapeHtml(ex.category||"")}</span></td>
                <td>${formatDate(ex.date)}</td>
                <td><b>${euro(ex.amount)}</b></td>
                <td class="rowActions">
                  <button class="mini" data-edit-exp="${ex.id}">Bearbeiten</button>
                  <button class="mini" data-del-exp="${ex.id}">Löschen</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function bindExpenses(){
      $("#expSave").onclick = ()=>{
        const title = $("#expTitle").value.trim();
        if(!title){ toast("Fehler","Titel ist Pflicht."); return; }
        const ex = {
          id: cryptoId(),
          title,
          date: $("#expDate").value || toDateInputValue(),
          amount: Number($("#expAmount").value||0),
          category: $("#expCat").value,
          pay: $("#expPay").value,
          note: $("#expNote").value.trim(),
          createdAt: nowISO()
        };
        state.expenses.push(ex);
        saveState();
        toast("OK","Ausgabe gespeichert.");
        render();
      };
      $("#expClear").onclick = ()=>{ render(); toast("OK","Leeren."); };
      $("#expCsv").onclick = ()=> downloadCSV("ausgaben.csv", expensesToCSV());

      $("#rightBody").onclick = (e)=>{
        const ed = e.target.closest("[data-edit-exp]");
        const dl = e.target.closest("[data-del-exp]");
        if(ed){
          const id = ed.getAttribute("data-edit-exp");
          const ex = state.expenses.find(x=>x.id===id);
          if(!ex) return;
          $("#expTitle").value = ex.title||"";
          $("#expDate").value = ex.date||toDateInputValue();
          $("#expAmount").value = String(ex.amount??0);
          $("#expCat").value = ex.category||"Sonstiges";
          $("#expPay").value = ex.pay||"Bar";
          $("#expNote").value = ex.note||"";
          $("#expSave").textContent = "Aktualisieren";
          $("#expSave").classList.add("primary");
          $("#expSave").onclick = ()=>{
            ex.title = $("#expTitle").value.trim();
            if(!ex.title){ toast("Fehler","Titel ist Pflicht."); return; }
            ex.date = $("#expDate").value || ex.date;
            ex.amount = Number($("#expAmount").value||0);
            ex.category = $("#expCat").value;
            ex.pay = $("#expPay").value;
            ex.note = $("#expNote").value.trim();
            saveState();
            toast("OK","Ausgabe aktualisiert.");
            render();
          };
          toast("Info","Ausgabe geladen.");
          focusFirst("#expTitle");
        }
        if(dl){
          const id = dl.getAttribute("data-del-exp");
          if(!confirm("Ausgabe löschen?")) return;
          state.expenses = state.expenses.filter(x=>x.id!==id);
          saveState();
          toast("OK","Ausgabe gelöscht.");
          render();
        }
      };
    }

    // PAYROLL
    function renderPayrollForm(){
      return `
        <div class="formGrid">
          <div class="formRow">
            <label for="payEmp">Mitarbeiter</label>
            <input id="payEmp" placeholder="Name" />
          </div>
          <div class="formRow">
            <label for="payMonth">Monat</label>
            <input id="payMonth" type="month" value="${escapeAttr(monthKey(new Date()))}" />
          </div>
          <div class="formRow">
            <label for="payHours">Stunden</label>
            <input id="payHours" type="number" step="0.01" value="0.00" />
          </div>
          <div class="formRow">
            <label for="payRate">€ / Stunde</label>
            <input id="payRate" type="number" step="0.01" value="0.00" />
          </div>
          <div class="formRow" style="grid-column:1/-1">
            <label for="payNote">Notiz</label>
            <textarea id="payNote" placeholder="z.B. SV/Abzüge später"></textarea>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="paySave">Speichern</button>
          <button class="btn" id="payPdf">PDF öffnen</button>
          <button class="btn" id="payClear">Leeren</button>
        </div>
        <div class="helper">Dies ist eine Demo-Lohnabrechnung (offline).</div>
      `;
    }

    function renderPayrollTable(){
      if(!state.payroll.length){
        return `<div class="helper">Keine Lohn-Einträge vorhanden.</div>`;
      }
      return `
        <table class="table">
          <thead>
            <tr>
              <th>Mitarbeiter</th>
              <th>Monat</th>
              <th>Stunden</th>
              <th>Brutto</th>
              <th style="width:260px">Aktion</th>
            </tr>
          </thead>
          <tbody>
            ${state.payroll.slice().sort((a,b)=> (b.month||"").localeCompare(a.month||"")).map(p=>`
              <tr>
                <td><b>${escapeHtml(p.employee)}</b><div class="smallNote">${escapeHtml(p.note||"")}</div></td>
                <td>${escapeHtml(p.month)}</td>
                <td>${Number(p.hours||0).toLocaleString("de-DE",{maximumFractionDigits:2})}</td>
                <td><b>${euro(p.gross)}</b></td>
                <td class="rowActions">
                  <button class="mini" data-pdf-pay="${p.id}">PDF</button>
                  <button class="mini" data-del-pay="${p.id}">Löschen</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function bindPayroll(){
      $("#paySave").onclick = ()=>{
        const employee = $("#payEmp").value.trim();
        if(!employee){ toast("Fehler","Mitarbeiter ist Pflicht."); return; }
        const hours = Number($("#payHours").value||0);
        const rate = Number($("#payRate").value||0);
        const gross = hours * rate;

        const item = {
          id: cryptoId(),
          employee,
          month: $("#payMonth").value || monthKey(new Date()),
          hours,
          rate,
          gross,
          note: $("#payNote").value.trim(),
          createdAt: nowISO()
        };
        state.payroll.push(item);
        saveState();
        toast("OK","Lohn gespeichert.");
        render();
      };
      $("#payClear").onclick = ()=>{ render(); toast("OK","Leeren."); };
      $("#payPdf").onclick = ()=>{
        const tmp = {
          id:"tmp",
          employee: $("#payEmp").value.trim() || "—",
          month: $("#payMonth").value || monthKey(new Date()),
          hours: Number($("#payHours").value||0),
          rate: Number($("#payRate").value||0),
          note: $("#payNote").value.trim()
        };
        tmp.gross = tmp.hours*tmp.rate;
        openPayrollPrint(tmp);
      };

      $("#rightBody").onclick = (e)=>{
        const pdf = e.target.closest("[data-pdf-pay]");
        const del = e.target.closest("[data-del-pay]");
        if(pdf){
          const id = pdf.getAttribute("data-pdf-pay");
          const item = state.payroll.find(x=>x.id===id);
          if(!item) return;
          openPayrollPrint(item);
        }
        if(del){
          const id = del.getAttribute("data-del-pay");
          if(!confirm("Eintrag löschen?")) return;
          state.payroll = state.payroll.filter(x=>x.id!==id);
          saveState();
          toast("OK","Gelöscht.");
          render();
        }
      };
    }

    function openPayrollPrint(p){
      const prof = state.profile;
      const html = `
<!doctype html>
<html><head><meta charset="utf-8"><title>Lohnabrechnung ${escapeHtml(p.employee)}</title>
<style>
body{font-family:Arial,sans-serif;margin:30px;color:#111}
.box{border:1px solid #ddd;border-radius:10px;padding:14px}
h1{margin:0 0 10px;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.muted{color:#555;font-size:12px}
</style></head>
<body>
  <div class="box">
    <h1>Lohnabrechnung</h1>
    <div class="muted">${escapeHtml(prof.company||"")}</div>
  </div>
  <div class="grid" style="margin-top:12px">
    <div class="box">
      <b>Mitarbeiter:</b> ${escapeHtml(p.employee)}<br/>
      <b>Monat:</b> ${escapeHtml(p.month)}<br/>
      <b>Stunden:</b> ${Number(p.hours||0).toLocaleString("de-DE",{maximumFractionDigits:2})}<br/>
      <b>€ / Stunde:</b> ${euro(p.rate)}<br/>
    </div>
    <div class="box">
      <b>Brutto:</b> <span style="font-size:18px">${euro(p.gross)}</span><br/>
      <div class="muted" style="margin-top:8px">Hinweis (Demo): Abzüge/SV separat erfassen.</div>
    </div>
  </div>
  ${p.note ? `<div class="box" style="margin-top:12px"><b>Notiz:</b><div class="muted" style="white-space:pre-line;margin-top:6px">${escapeHtml(p.note)}</div></div>` : ""}
</body></html>
      `.trim();

      const w = window.open("", "_blank");
      if(!w){ toast("Blockiert","Popup blockiert. Erlaube Popups."); return; }
      w.document.open(); w.document.write(html); w.document.close(); w.focus();
      setTimeout(()=>w.print(), 350);
    }

    // TAX
    function renderTaxPanel(){
      const y = new Date().getFullYear();
      const yearVal = state.tax.year || y;
      return `
        <div class="formGrid">
          <div class="formRow">
            <label for="taxYear">Steuerjahr</label>
            <input id="taxYear" type="number" value="${escapeAttr(yearVal)}" />
          </div>
          <div class="formRow">
            <label>Hinweis</label>
            <div class="badge">Offline Notiz + Summen</div>
          </div>
          <div class="formRow" style="grid-column:1/-1">
            <label for="taxNotes">Notizen</label>
            <textarea id="taxNotes" placeholder="z.B. Werbungskosten, Fahrten, Belege...">${escapeHtml(state.tax.notes||"")}</textarea>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="taxSave">Speichern</button>
          <button class="btn" id="taxPdf">PDF öffnen</button>
        </div>
        <div class="helper">Tipp: Export/Import in Einstellungen für Backup.</div>
      `;
    }

    function renderTaxSummary(){
      const year = Number(state.tax.year || new Date().getFullYear());
      const inv = state.invoices.filter(x=> new Date(x.date).getFullYear()===year && x.status!=="storniert");
      const exp = state.expenses.filter(x=> new Date(x.date).getFullYear()===year);
      const revGross = inv.reduce((a,x)=>a+Number(x.gross||0),0);
      const revNet = inv.reduce((a,x)=>a+Number(x.net||0),0);
      const vat = inv.reduce((a,x)=>a+Number(x.vatAmount||0),0);
      const exSum = exp.reduce((a,x)=>a+Number(x.amount||0),0);

      return `
        <div class="cards" style="grid-template-columns:1fr">
          <div class="card">
            <p class="k">Umsatz (${year})</p>
            <p class="v">${euro(revGross)}</p>
            <p class="s">${state.profile.kleinunternehmer ? "USt: 0,00 €" : ("USt: "+euro(vat)+" • Netto: "+euro(revNet))}</p>
          </div>
          <div class="card">
            <p class="k">Ausgaben (${year})</p>
            <p class="v">${euro(exSum)}</p>
            <p class="s">Einträge: ${exp.length}</p>
          </div>
          <div class="card">
            <p class="k">Überschuss (vereinfachte Rechnung)</p>
            <p class="v">${euro(revGross - exSum)}</p>
            <p class="s">Hinweis: Keine steuerliche Beratung. Nur Übersicht.</p>
          </div>
        </div>
      `;
    }

    function bindTax(){
      $("#taxSave").onclick = ()=>{
        state.tax.year = Number($("#taxYear").value || new Date().getFullYear());
        state.tax.notes = $("#taxNotes").value || "";
        saveState();
        toast("OK","Gespeichert.");
        render();
      };
      $("#taxPdf").onclick = ()=>{
        const year = Number($("#taxYear").value || new Date().getFullYear());
        const notes = $("#taxNotes").value || "";
        openTaxPrint(year, notes);
      };
    }

    function openTaxPrint(year, notes){
      const sum = getYearTotalsFor(year);
      const prof = state.profile;
      const html = `
<!doctype html><html><head><meta charset="utf-8"><title>Einkommensteuer ${year}</title>
<style>
body{font-family:Arial,sans-serif;margin:30px;color:#111}
.box{border:1px solid #ddd;border-radius:10px;padding:14px}
h1{margin:0 0 10px;font-size:18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.muted{color:#555;font-size:12px}
</style></head><body>
  <div class="box">
    <h1>Einkommensteuer – Notizen & Summen (${year})</h1>
    <div class="muted">${escapeHtml(prof.company||"")}</div>
  </div>
  <div class="grid" style="margin-top:12px">
    <div class="box">
      <b>Umsatz (Brutto):</b> ${euro(sum.revenueGross)}<br/>
      <b>Ausgaben:</b> ${euro(sum.expenseSum)}<br/>
      <b>Überschuss:</b> ${euro(sum.revenueGross - sum.expenseSum)}<br/>
      <div class="muted" style="margin-top:8px">${prof.kleinunternehmer ? "Kleinunternehmer: USt 0" : ("USt: "+euro(sum.revenueVat))}</div>
    </div>
    <div class="box">
      <b>Notizen:</b>
      <div class="muted" style="white-space:pre-line;margin-top:8px">${escapeHtml(notes||"")}</div>
    </div>
  </div>
  <p class="muted" style="margin-top:12px">Hinweis: Keine steuerliche Beratung. Offline-Dokument.</p>
</body></html>
      `.trim();
      const w = window.open("", "_blank");
      if(!w){ toast("Blockiert","Popup blockiert. Erlaube Popups."); return; }
      w.document.open(); w.document.write(html); w.document.close(); w.focus();
      setTimeout(()=>w.print(), 350);
    }

    function getYearTotalsFor(year){
      const inv = state.invoices.filter(x=> new Date(x.date).getFullYear()===year && x.status!=="storniert");
      const exp = state.expenses.filter(x=
