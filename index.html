
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Einsatzmeldung (Auto Logo + Pen Sign + Auto Save)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --bg:#071225; --line:#16345e; --text:#e7f0ff; --muted:#9bb1d5;
      --accent:#3aa6ff; --danger:#ff4d6d; --good:#21d19f; --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(33,209,159,.12), transparent 55%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg, rgba(11,26,51,.92), rgba(7,18,37,.78));
      border-bottom:1px solid rgba(22,52,94,.7);
      backdrop-filter: blur(10px);
      gap:12px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:260px}
    .brand.right{flex-direction:row-reverse}
    .brand.top{flex-direction:column; align-items:flex-start}
    .brand.hideLogo #logoImg{display:none!important}
    .logo{
      width:44px; height:44px; border-radius:12px; object-fit:contain;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      display:none;
    }
    .brandName{font-weight:900; letter-spacing:.2px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}

    a.link{color:inherit; text-decoration:none; border-bottom:1px dotted rgba(255,255,255,.35); cursor:pointer}
    a.link:hover{border-bottom-color:rgba(255,255,255,.75)}

    .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .status{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px 10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted); font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.35); border:1px solid rgba(255,255,255,.25)}
    .dot.ok{background:rgba(33,209,159,.85); border-color:rgba(33,209,159,.65)}
    .dot.work{background:rgba(58,166,255,.85); border-color:rgba(58,166,255,.65)}
    .dot.err{background:rgba(255,77,109,.85); border-color:rgba(255,77,109,.65)}

    select{
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
    }

    .wrap{max-width:1220px; margin:18px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px;}
    .card{
      background:linear-gradient(180deg, rgba(15,42,79,.92), rgba(11,26,51,.85));
      border:1px solid rgba(22,52,94,.8);
      border-radius:var(--r);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      padding:14px;
    }
    .card h2{margin:0 0 6px 0; font-size:18px}
    .muted{color:var(--muted); margin:0 0 12px 0}
    .small{font-size:12px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px}
    .tab{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      cursor:pointer;
      font-weight:900; font-size:13px;
    }
    .tab.active{background:rgba(58,166,255,.16); border-color:rgba(58,166,255,.28);}

    .row{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-bottom:10px;}
    .row.actions{display:flex; gap:10px; flex-wrap:wrap}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    input, textarea{
      width:100%; padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
      resize:vertical;
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(58,166,255,.9); box-shadow:0 0 0 3px rgba(58,166,255,.15)}

    .btn{
      border:0; padding:10px 12px; border-radius:14px;
      color:#061226; background:var(--accent);
      font-weight:900; cursor:pointer; user-select:none;
    }
    .btn.ghost{background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12);}
    .btn.danger{background:rgba(255,77,109,.18); color:#ffd7de; border:1px solid rgba(255,77,109,.35);}
    .btn:hover{filter:brightness(1.05)}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; padding:10px; border-radius:14px;
      background:rgba(7,18,37,.45);
      border:1px solid rgba(22,52,94,.7);
    }
    .item b{display:block}
    .item .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .item .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(58,166,255,.12);
      border:1px solid rgba(58,166,255,.22);
      color:var(--text);
    }
    .countPill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(33,209,159,.12);
      border:1px solid rgba(33,209,159,.22);
      color:var(--text);
    }

    .pickWrap{border:1px solid rgba(255,255,255,.12); background:rgba(7,18,37,.35); border-radius:16px; padding:10px;}
    .pickHdr{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;}
    .pickList{display:flex; flex-direction:column; gap:8px; max-height:360px; overflow:auto; padding-right:4px;}
    .pickRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; padding:8px 10px; border-radius:14px;
      border:1px solid rgba(22,52,94,.7);
      background:rgba(7,18,37,.45);
    }
    .pickLeft{display:flex; gap:10px; align-items:flex-start;}
    .chk{width:18px; height:18px; margin-top:2px; accent-color: var(--accent);}
    .pickName{font-weight:900}
    .pickMeta{color:var(--muted); font-size:12px; margin-top:2px}

    .sigBox{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(7,18,37,.35);
      border-radius:16px;
      padding:10px;
    }
    canvas{
      width:100%;
      height:180px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      touch-action:none; /* pen/touch */
    }
    .sigActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}

    .note{
      border:1px solid rgba(33,209,159,.25);
      background:rgba(33,209,159,.08);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      color:#dbfff5;
    }

    .span2{grid-column: 1 / span 2}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .row{grid-template-columns:1fr}
      .brand{min-width:unset}
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:50;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(820px, 100%);
      background:linear-gradient(180deg, rgba(15,42,79,.98), rgba(11,26,51,.96));
      border:1px solid rgba(22,52,94,.9);
      border-radius:18px;
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      padding:14px;
    }
    .modalTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modalTop h3{margin:0; font-size:16px}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand" id="brandWrap">
      <img class="logo" id="logoImg" alt="Logo"/>
      <div>
        <div class="brandName" id="brandName">Masculine Security</div>
        <div class="brandSub" id="brandSub"></div>
      </div>
    </div>

    <div class="topActions">
      <div class="status" title="Auto-save status">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Ready</span>
      </div>

      <select id="logoPosApp" title="Logo position in App">
        <option value="left">App: Left</option>
        <option value="right">App: Right</option>
        <option value="top">App: Top</option>
        <option value="hide">App: Hide</option>
      </select>

      <select id="logoPos" title="Logo position in PDF">
        <option value="left">Logo Left (PDF)</option>
        <option value="right">Logo Right (PDF)</option>
        <option value="top">Logo Top (PDF)</option>
        <option value="hide">Hide Logo (PDF)</option>
      </select>

      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px">
        Logo PNG (optional)
        <input id="logoFile" type="file" accept="image/png" style="display:none">
      </label>
      <button class="btn ghost" id="btnClearLogo" type="button">Remove Logo</button>

      <button class="btn ghost" id="btnBackup" type="button">Backup (Full)</button>
      <button class="btn ghost" id="btnRestore" type="button">Restore (Full)</button>
      <button class="btn ghost" id="btnClearDraft" type="button">Clear Draft</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="app" type="button">App</button>
      <button class="tab" data-tab="settings" type="button">Einstellungen</button>
    </div>

    <!-- APP -->
    <section id="tab-app">
      <section class="grid">
        <!-- Mitarbeiter -->
        <div class="card">
          <h2>Mitarbeiter (unlimited)</h2>
          <p class="muted">Mitarbeiter walba wuxuu leeyahay <b>signature gaar ah</b> ✅ (pen/stylus waa shaqeeyaa).</p>

          <div class="row">
            <div class="field">
              <label>Vorname & Nachname</label>
              <input id="empName" placeholder="z.B. Ahmed Ali"/>
            </div>
            <div class="field">
              <label>Bewacher-ID (optional)</label>
              <input id="empBewacher" placeholder="z.B. HB-123456"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Telefon (optional)</label>
              <input id="empPhone" placeholder="z.B. 0157..."/>
            </div>
            <div class="field">
              <label>Position (optional)</label>
              <input id="empRole" placeholder="z.B. Wachmann"/>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnAddEmp" type="button">Add Mitarbeiter</button>
            <button class="btn danger" id="btnClearEmp" type="button">Clear</button>
          </div>

          <div class="list" id="empList"></div>
        </div>

        <!-- Kunde/Objekt -->
        <div class="card">
          <h2>Kunde & Objekt</h2>
          <p class="muted">Typing/Select = auto-save ✅</p>

          <div class="row">
            <div class="field">
              <label>Kunde (Firma/Name)</label>
              <input id="custName" placeholder="z.B. Hotel Bremen GmbH"/>
            </div>
            <div class="field">
              <label>Objektname</label>
              <input id="objName" placeholder="z.B. Eingang / Lobby"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Einsatzort (Adresse)</label>
              <input id="objAddr" placeholder="Straße, PLZ Ort"/>
            </div>
            <div class="field">
              <label>Objekt-Typ</label>
              <select id="objType">
                <option value="Hotel">Hotel</option>
                <option value="Baustelle">Baustelle</option>
                <option value="Event">Event</option>
                <option value="Asylheim">Asylheim</option>
                <option value="Nachtwache">Nachtwache</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnSaveObj" type="button">Save Objekt</button>
            <button class="btn danger" id="btnClearObj" type="button">Clear</button>
          </div>

          <div class="list" id="objList"></div>
        </div>

        <!-- Einsatz -->
        <div class="card span2">
          <h2>Einsatzmeldung erstellen</h2>
          <p class="muted">PDF: signature column → employee walba signature-kiisa.</p>

          <div class="row">
            <div class="field">
              <label>Objekt wählen</label>
              <select id="selObj"></select>
            </div>
            <div class="field">
              <label>Selected Mitarbeiter</label>
              <div class="countPill" id="selEmpCount">0 selected</div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Mitarbeiter auswählen</label>
              <div class="pickWrap">
                <div class="pickHdr">
                  <div class="muted small">Tick + haddii signature u baahan yahay → riix “Sign”.</div>
                  <div style="display:flex; gap:8px; flex-wrap:wrap">
                    <button class="btn ghost" id="btnEmpSelectAll" type="button">Select all</button>
                    <button class="btn ghost" id="btnEmpClearAll" type="button">Clear all</button>
                  </div>
                </div>
                <div class="pickList" id="empPickList"></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Datum</label>
              <input id="shiftDate" type="date"/>
            </div>
            <div class="field">
              <label>Start</label>
              <input id="shiftStart" type="time" step="60"/>
            </div>
            <div class="field">
              <label>Ende</label>
              <input id="shiftEnd" type="time" step="60"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Von (Download)</label>
              <input id="expFrom" type="date"/>
            </div>
            <div class="field">
              <label>Bis (Download)</label>
              <input id="expTo" type="date"/>
            </div>
          </div>

          <div class="row">
            <div class="field" style="grid-column:1/-1">
              <label>Unterschrift Arbeitgeber / Auftraggeber (saved)</label>
              <div class="sigBox">
                <canvas id="sigCanvasAg" width="900" height="240"></canvas>
                <div class="sigActions">
                  <button class="btn ghost" id="btnSigClearAg" type="button">Clear</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row actions">
            <button class="btn" id="btnCreate" type="button">Save / Update Einsatz</button>
            <button class="btn" id="btnPDF" type="button">Generate PDF</button>
            <button class="btn danger" id="btnDelete" type="button">Delete selected Einsatz</button>

            <button class="btn ghost" id="btnExportRangeJson" type="button">Download Einsätze (JSON)</button>
            <button class="btn ghost" id="btnExportRangeCsv" type="button">Download Einsätze (CSV)</button>
            <button class="btn ghost" id="btnImportRangeJson" type="button">Import Einsätze (JSON)</button>
          </div>

          <div class="list" id="einsatzList"></div>

          <div class="note small">
            ✅ Pen/Stylus: “Sign” → qor canvas → Save Signature. <br>
            ✅ Logo auto: Embedded base64 (best) OR auto-load from <b>logo.png</b> (optional).
          </div>
        </div>
      </section>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" style="display:none">
      <div class="card">
        <h2>Einstellungen — Firmendaten (saved)</h2>
        <p class="muted">Company data halkan ku geli. PDF kasta auto ayuu u isticmaalaa.</p>

        <div class="row">
          <div class="field">
            <label>Firmenname</label>
            <input id="setCompanyName" placeholder="z.B. Masculine Security"/>
          </div>
          <div class="field">
            <label>Straße & Hausnummer</label>
            <input id="setStreet" placeholder="z.B. Werschenregerstraße 6"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>PLZ & Ort</label>
            <input id="setCity" placeholder="z.B. 28237 Bremen"/>
          </div>
          <div class="field">
            <label>Telefon</label>
            <input id="setPhone" placeholder="z.B. 0157..."/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>E-Mail</label>
            <input id="setEmail" placeholder="z.B. Kontakt.mass.bremen@hotmail.com"/>
          </div>
          <div class="field">
            <label>Steuernummer / USt-IdNr (optional)</label>
            <input id="setTax" placeholder="optional"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Hinweis (optional, PDF footer)</label>
            <input id="setFooterNote" placeholder="z.B. Aufbewahrung empfohlen."/>
          </div>
          <div class="field">
            <label>Default Einsatz-Typ (optional)</label>
            <input id="setDefaultType" placeholder="z.B. Hotel / Baustelle"/>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnSaveSettings" type="button">Save Settings</button>
          <button class="btn danger" id="btnResetSettings" type="button">Reset</button>
        </div>

        <div class="note small">
          Tip: email & tel waa clickable: <a class="link" href="mailto:Kontakt.mass.bremen@hotmail.com">Kontakt.mass.bremen@hotmail.com</a>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: Per-Employee Signature -->
  <div class="modal" id="sigModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <h3 id="sigModalTitle">Unterschrift</h3>
          <p class="muted small" id="sigModalSub" style="margin:6px 0 0 0;">Pen / finger / mouse</p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ghost" id="btnSigModalClose" type="button">Close</button>
        </div>
      </div>

      <div class="sigBox" style="margin-top:10px">
        <canvas id="sigCanvasEmpModal" width="900" height="260"></canvas>
        <div class="sigActions">
          <button class="btn ghost" id="btnSigModalClear" type="button">Clear</button>
          <button class="btn" id="btnSigModalSave" type="button">Save Signature</button>
          <button class="btn danger" id="btnSigModalRemove" type="button">Remove Signature</button>
        </div>
      </div>

      <div class="muted small" style="margin-top:10px">
        Tip: Qalinka (stylus) ku qor → pointer events ayaa qabanaya.
      </div>
    </div>
  </div>

  <script>
    /* ==========================================================
      LOGO AUTO:
      OPTION A (BEST, hal file 100%): paste base64 after comma:
        const LOGO_EMBED_BASE64 = "iVBORw0K....";
      OPTION B: leave empty -> tries to fetch "logo.png" from same folder,
                converts to dataURL, saves once.
      OPTION C: manual upload (optional) still supported.
    ========================================================== */
    const LOGO_EMBED_BASE64 = ""; // <- haddii aad rabto embedded: paste base64 here (NO "data:image/png;base64," prefix)

    /* =======================
       STORAGE
    ======================= */
    const STORE_KEY="ms_einsatz_store_v16";
    const DRAFT_KEY="ms_einsatz_draft_v16";
    const $=(id)=>document.getElementById(id);
    const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
    function safeParse(raw,fallback){ try{return JSON.parse(raw)}catch{return fallback} }
    function escapeHtml(s){
      return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function makeEmbeddedLogoDataUrl(){
      const b=(LOGO_EMBED_BASE64||"").trim();
      if(!b) return null;
      return "data:image/png;base64," + b.replace(/\s+/g,"");
    }

    function defaultStore(){
      return {
        employees:[],
        objects:[],
        einsaetze:[],
        logoDataUrl: makeEmbeddedLogoDataUrl(), // auto embedded if provided
        logoPosition:"left",
        logoPositionApp:"left",
        sigAgDataUrl:null,
        company:{
          name:"Masculine Security",
          street:"Werschenregerstraße 6",
          city:"28237 Bremen",
          phone:"015778697052",
          email:"Kontakt.mass.bremen@hotmail.com",
          tax:"",
          footerNote:"Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.",
          defaultType:""
        }
      };
    }

    let store=safeParse(localStorage.getItem(STORE_KEY), null) || defaultStore();
    function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

    /* =======================
       AUTO-SAVE (draft)
    ======================= */
    let saveTimer=null;
    function setSaveStatus(mode){
      const dot=$("saveDot"), txt=$("saveText");
      dot.classList.remove("ok","work","err");
      if(mode==="saving"){ dot.classList.add("work"); txt.textContent="Saving…"; }
      else if(mode==="saved"){ dot.classList.add("ok"); txt.textContent="Saved"; }
      else if(mode==="error"){ dot.classList.add("err"); txt.textContent="Save error"; }
      else txt.textContent="Ready";
    }
    function getSelectedEmpIds(){
      return Array.from(document.querySelectorAll('input[data-emp-chk="1"]:checked')).map(i=>i.value);
    }
    function setSelectedEmpIds(ids){
      const set=new Set((ids||[]).map(String));
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(chk=>chk.checked=set.has(String(chk.value)));
      updateSelectedCount();
    }
    function updateSelectedCount(){ $("selEmpCount").textContent=`${getSelectedEmpIds().length} selected`; }

    function collectDraft(){
      return {
        empName:$("empName").value, empBewacher:$("empBewacher").value, empPhone:$("empPhone").value, empRole:$("empRole").value,
        custName:$("custName").value, objName:$("objName").value, objAddr:$("objAddr").value, objType:$("objType").value,
        selObj:$("selObj").value, shiftDate:$("shiftDate").value, shiftStart:$("shiftStart").value, shiftEnd:$("shiftEnd").value,
        expFrom:$("expFrom").value, expTo:$("expTo").value,
        selectedEmpIds:getSelectedEmpIds(),
        logoPosition:$("logoPos").value, logoPositionApp:$("logoPosApp").value,
        lastSavedAt:Date.now()
      };
    }
    function saveDraftNow(){
      try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(collectDraft())); setSaveStatus("saved"); }
      catch{ setSaveStatus("error"); }
    }
    function queueAutoSave(){
      setSaveStatus("saving");
      clearTimeout(saveTimer);
      saveTimer=setTimeout(saveDraftNow, 250);
    }
    window.addEventListener("beforeunload", ()=>{ try{ saveDraftNow(); saveStore(); }catch{} });

    /* =======================
       TABS
    ======================= */
    function showTab(name){
      $("tab-app").style.display = (name==="app") ? "" : "none";
      $("tab-settings").style.display = (name==="settings") ? "" : "none";
    }
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        showTab(btn.getAttribute("data-tab"));
      });
    });

    /* =======================
       BRAND + LOGO
    ======================= */
    function companyAddressLine(c){
      const street=(c.street||"").trim(), city=(c.city||"").trim();
      return [street,city].filter(Boolean).join(", ");
    }
    function refreshBrand(){
      const c=store.company||{};
      $("brandName").textContent=c.name||"Security";
      const addr=companyAddressLine(c) || "—";
      const tel=(c.phone||"").trim();
      const mail=(c.email||"").trim();
      const telHtml = tel ? `Tel: <a class="link" href="tel:${encodeURIComponent(tel)}">${escapeHtml(tel)}</a>` : `Tel: —`;
      const mailHtml = mail ? `E-Mail: <a class="link" href="mailto:${encodeURIComponent(mail)}">${escapeHtml(mail)}</a>` : `E-Mail: —`;
      const logoTxt = store.logoDataUrl ? "Logo: OK" : "Logo: none";
      $("brandSub").innerHTML = `${escapeHtml(addr)} • ${telHtml} • ${mailHtml} • ${logoTxt}`;
    }
    function applyLogo(){
      const img=$("logoImg");
      if(store.logoDataUrl){ img.src=store.logoDataUrl; img.style.display="block"; }
      else { img.removeAttribute("src"); img.style.display="none"; }
    }
    function applyLogoPositionUI(){
      const pos=store.logoPositionApp||"left";
      const brand=$("brandWrap");
      brand.classList.remove("right","top","hideLogo");
      if(pos==="right") brand.classList.add("right");
      if(pos==="top") brand.classList.add("top");
      if(pos==="hide") brand.classList.add("hideLogo");
      $("logoPosApp").value=pos;
    }
    function applyLogoPosPDF(){ $("logoPos").value=store.logoPosition||"left"; }

    $("logoPos").addEventListener("change", ()=>{ store.logoPosition=$("logoPos").value; saveStore(); queueAutoSave(); });
    $("logoPosApp").addEventListener("change", ()=>{ store.logoPositionApp=$("logoPosApp").value; saveStore(); applyLogoPositionUI(); queueAutoSave(); });

    // Optional manual upload
    $("logoFile").addEventListener("change", ()=>{
      const file=$("logoFile").files?.[0];
      if(!file) return;
      if(file.type!=="image/png"){ alert("PNG kaliya ✅"); $("logoFile").value=""; return; }
      if(file.size>3*1024*1024){ alert("Logo < 3MB"); $("logoFile").value=""; return; }
      const fr=new FileReader();
      fr.onload=()=>{
        store.logoDataUrl=String(fr.result||"");
        saveStore(); applyLogo(); refreshBrand();
        $("logoFile").value="";
      };
      fr.readAsDataURL(file);
    });

    $("btnClearLogo").addEventListener("click", ()=>{
      if(!confirm("Remove stored logo?")) return;
      store.logoDataUrl=null;
      saveStore(); applyLogo(); refreshBrand();
    });

    /* =======================
       SETTINGS
    ======================= */
    function loadSettingsToUI(){
      const c=store.company||{};
      $("setCompanyName").value=c.name||"";
      $("setStreet").value=c.street||"";
      $("setCity").value=c.city||"";
      $("setPhone").value=c.phone||"";
      $("setEmail").value=c.email||"";
      $("setTax").value=c.tax||"";
      $("setFooterNote").value=c.footerNote||"";
      $("setDefaultType").value=c.defaultType||"";
    }
    function saveSettingsFromUI(){
      store.company=store.company||{};
      store.company.name=$("setCompanyName").value.trim()||"Security";
      store.company.street=$("setStreet").value.trim();
      store.company.city=$("setCity").value.trim();
      store.company.phone=$("setPhone").value.trim();
      store.company.email=$("setEmail").value.trim();
      store.company.tax=$("setTax").value.trim();
      store.company.footerNote=$("setFooterNote").value.trim()||"Hinweis: Diese Einsatzmeldung dient als Nachweis der Einsatzzeiten. Aufbewahrung empfohlen.";
      store.company.defaultType=$("setDefaultType").value.trim();
      saveStore(); refreshBrand(); setSaveStatus("saved");
    }
    $("btnSaveSettings").addEventListener("click", ()=>{ saveSettingsFromUI(); alert("Settings saved ✅"); });
    $("btnResetSettings").addEventListener("click", ()=>{
      if(!confirm("Reset company settings?")) return;
      store.company=defaultStore().company; saveStore(); loadSettingsToUI(); refreshBrand();
    });
    ["setCompanyName","setStreet","setCity","setPhone","setEmail","setTax","setFooterNote","setDefaultType"].forEach(id=>{
      $(id).addEventListener("input", ()=>{
        clearTimeout(saveTimer); setSaveStatus("saving");
        saveTimer=setTimeout(()=>saveSettingsFromUI(), 300);
      });
    });

    /* =======================
       SIGNATURE (PEN FRIENDLY)
    ======================= */
    function attachPointerSignature(canvas, onSave){
      const ctx=canvas.getContext("2d", {willReadFrequently:true});
      let drawing=false, last=null;

      function resize(){
        const rect=canvas.getBoundingClientRect();
        const dpr=Math.max(1, window.devicePixelRatio||1);
        const w=Math.floor(rect.width*dpr), h=Math.floor(rect.height*dpr);
        if(canvas.width!==w || canvas.height!==h){
          const old=document.createElement("canvas");
          old.width=canvas.width; old.height=canvas.height;
          old.getContext("2d").drawImage(canvas,0,0);

          canvas.width=w; canvas.height=h;
          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr,dpr);
          ctx.clearRect(0,0,rect.width,rect.height);
          if(old.width && old.height){
            ctx.drawImage(old, 0,0, old.width, old.height, 0,0, rect.width, rect.height);
          }
        }else{
          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr,dpr);
        }
      }
      function pos(e){
        const rect=canvas.getBoundingClientRect();
        return { x:e.clientX-rect.left, y:e.clientY-rect.top };
      }
      function line(a,b){
        ctx.lineWidth=2.6;
        ctx.lineCap="round";
        ctx.lineJoin="round";
        ctx.strokeStyle="rgba(255,255,255,.95)";
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }
      canvas.addEventListener("pointerdown", (e)=>{
        resize();
        drawing=true; last=pos(e);
        canvas.setPointerCapture?.(e.pointerId);
      });
      canvas.addEventListener("pointermove", (e)=>{
        if(!drawing) return;
        e.preventDefault();
        const p=pos(e);
        line(last,p);
        last=p;
        setSaveStatus("saving");
      });
      function end(){
        if(!drawing) return;
        drawing=false; last=null;
        onSave?.();
      }
      canvas.addEventListener("pointerup", end);
      canvas.addEventListener("pointercancel", end);

      window.addEventListener("resize", ()=>resize());
      resize();

      return {
        clear(){
          resize();
          const rect=canvas.getBoundingClientRect();
          ctx.clearRect(0,0,rect.width,rect.height);
        },
        toDataUrl(){ return canvas.toDataURL("image/png"); },
        fromDataUrl(dataUrl){
          resize();
          const rect=canvas.getBoundingClientRect();
          ctx.clearRect(0,0,rect.width,rect.height);
          if(!dataUrl) return;
          const img=new Image();
          img.onload=()=>{ ctx.drawImage(img, 0,0, rect.width, rect.height); };
          img.src=dataUrl;
        }
      };
    }

    // Arbeitgeber signature (global)
    const agPad = attachPointerSignature($("sigCanvasAg"), ()=>{
      try{
        store.sigAgDataUrl = agPad.toDataUrl();
        saveStore();
        setSaveStatus("saved");
      }catch{ setSaveStatus("error"); }
    });
    $("btnSigClearAg").addEventListener("click", ()=>{
      agPad.clear();
      store.sigAgDataUrl=null;
      saveStore();
      setSaveStatus("saved");
    });

    // Per-Employee Signature Modal
    let modalEmpId=null;
    const modal=$("sigModal");
    const empModalPad = attachPointerSignature($("sigCanvasEmpModal"), ()=>{});

    function openEmpSigModal(empId){
      const emp=store.employees.find(e=>e.id===empId);
      if(!emp) return;
      modalEmpId=empId;
      $("sigModalTitle").textContent=`Unterschrift — ${emp.name}`;
      $("sigModalSub").textContent=`Pen / finger / mouse • Bewacher-ID: ${emp.bewacher||"—"}`;
      empModalPad.fromDataUrl(emp.sigDataUrl||null);
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function closeEmpSigModal(){
      modalEmpId=null;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    $("btnSigModalClose").addEventListener("click", closeEmpSigModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeEmpSigModal(); });

    $("btnSigModalClear").addEventListener("click", ()=>empModalPad.clear());
    $("btnSigModalRemove").addEventListener("click", ()=>{
      if(!modalEmpId) return;
      const emp=store.employees.find(e=>e.id===modalEmpId);
      if(!emp) return;
      emp.sigDataUrl=null;
      saveStore(); renderAll(); closeEmpSigModal();
    });
    $("btnSigModalSave").addEventListener("click", ()=>{
      if(!modalEmpId) return;
      const emp=store.employees.find(e=>e.id===modalEmpId);
      if(!emp) return;
      try{
        emp.sigDataUrl=empModalPad.toDataUrl();
        saveStore();
        renderAll();
        setSaveStatus("saved");
        closeEmpSigModal();
      }catch{
        setSaveStatus("error");
        alert("Could not save signature.");
      }
    });

    /* =======================
       RENDER
    ======================= */
    let selectedEinsatzId=null;

    function renderEmployees(){
      const box=$("empList");
      box.innerHTML="";
      if(store.employees.length===0){
        box.innerHTML=`<div class="muted small">No Mitarbeiter yet.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <div>
              <b>${escapeHtml(emp.name)}</b>
              <div class="meta">
                ${emp.bewacher ? `Bewacher-ID: ${escapeHtml(emp.bewacher)}` : "Bewacher-ID: —"}
                ${emp.role ? ` • ${escapeHtml(emp.role)}`:""}
                ${emp.phone ? ` • ${escapeHtml(emp.phone)}`:""}
                ${emp.sigDataUrl ? ` • <span style="color:#bfffe7">Signature: OK</span>` : ` • Signature: —`}
              </div>
            </div>
            <div class="right">
              <button class="btn ghost" data-sign-emp="${emp.id}" type="button">Sign</button>
              <button class="btn ghost" data-del-emp="${emp.id}" type="button">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }

      const pick=$("empPickList");
      pick.innerHTML="";
      if(store.employees.length===0){
        pick.innerHTML=`<div class="muted small">No Mitarbeiter to select.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const row=document.createElement("div");
          row.className="pickRow";
          row.innerHTML=`
            <div class="pickLeft">
              <input class="chk" type="checkbox" data-emp-chk="1" value="${emp.id}">
              <div>
                <div class="pickName">${escapeHtml(emp.name)} ${emp.sigDataUrl ? "✓" : ""}</div>
                <div class="pickMeta">
                  ${emp.bewacher ? `Bewacher-ID: ${escapeHtml(emp.bewacher)}` : "Bewacher-ID: —"}
                  ${emp.role ? ` • ${escapeHtml(emp.role)}`:""}
                </div>
              </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <span class="pill">${emp.sigDataUrl ? "Signed" : "No Sig"}</span>
              <button class="btn ghost" data-sign-emp="${emp.id}" type="button">Sign</button>
            </div>
          `;
          pick.appendChild(row);
        });

        pick.querySelectorAll('input[data-emp-chk="1"]').forEach(chk=>{
          chk.addEventListener("change", ()=>{ updateSelectedCount(); queueAutoSave(); });
        });
      }
      updateSelectedCount();
    }

    function renderObjects(){
      const box=$("objList");
      box.innerHTML="";
      if(store.objects.length===0){
        box.innerHTML=`<div class="muted small">No Objekt yet.</div>`;
      }else{
        store.objects.forEach(obj=>{
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <div>
              <b>${escapeHtml(obj.cust)} — ${escapeHtml(obj.obj)}</b>
              <div class="meta">${escapeHtml(obj.type)} • ${escapeHtml(obj.addr)}</div>
            </div>
            <div class="right">
              <button class="btn ghost" data-del-obj="${obj.id}" type="button">Delete</button>
            </div>
          `;
          box.appendChild(div);
        });
      }

      const sel=$("selObj");
      sel.innerHTML="";
      if(store.objects.length===0){
        sel.innerHTML=`<option value="">— no Objekt —</option>`;
      }else{
        store.objects.forEach(obj=>{
          const opt=document.createElement("option");
          opt.value=obj.id;
          opt.textContent=`${obj.cust} — ${obj.obj}`;
          sel.appendChild(opt);
        });
      }
    }

    function renderEinsaetze(){
      const box=$("einsatzList");
      box.innerHTML="";
      if(store.einsaetze.length===0){
        box.innerHTML=`<div class="muted small">No Einsätze saved yet.</div>`;
        return;
      }
      store.einsaetze.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).forEach(ein=>{
        const obj=store.objects.find(x=>x.id===ein.objId);
        const empNames=(ein.empIds||[]).map(id => store.employees.find(e=>e.id===id)?.name || "(missing)").join(", ");
        const title=`${empNames||"(no Mitarbeiter)"} • ${obj?obj.obj:"(missing Objekt)"}`;
        const meta=`${ein.date} • ${ein.start}–${ein.end} • ${obj?obj.cust:""} • ${obj?obj.addr:""}`;
        const active=selectedEinsatzId===ein.id;
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <div>
            <b>${escapeHtml(title)} ${active?"✓":""}</b>
            <div class="meta">${escapeHtml(meta)}</div>
          </div>
          <div class="right">
            <span class="pill">${ein.type||"Einsatz"}</span>
            <button class="btn ghost" data-pick-ein="${ein.id}" type="button">${active?"Selected":"Select"}</button>
          </div>
        `;
        box.appendChild(div);
      });
    }

    function renderAll(){
      renderEmployees();
      renderObjects();
      renderEinsaetze();
      applyLogo();
      applyLogoPosPDF();
      applyLogoPositionUI();
      refreshBrand();
      loadSettingsToUI();
      agPad.fromDataUrl(store.sigAgDataUrl||null);
    }

    /* =======================
       CRUD + EVENTS
    ======================= */
    $("btnAddEmp").addEventListener("click", ()=>{
      const name=$("empName").value.trim();
      if(!name) return alert("Bitte Name eingeben.");
      store.employees.push({
        id:uid(),
        name,
        bewacher:$("empBewacher").value.trim(),
        phone:$("empPhone").value.trim(),
        role:$("empRole").value.trim(),
        sigDataUrl:null
      });
      saveStore();
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      renderAll(); queueAutoSave();
    });
    $("btnClearEmp").addEventListener("click", ()=>{
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      queueAutoSave();
    });

    $("btnSaveObj").addEventListener("click", ()=>{
      const cust=$("custName").value.trim();
      const obj=$("objName").value.trim();
      const addr=$("objAddr").value.trim();
      const type=$("objType").value;
      if(!cust || !obj || !addr) return alert("Bitte Kunde, Objektname, Adresse ausfüllen.");
      store.objects.push({ id:uid(), cust, obj, addr, type });
      saveStore();
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      renderAll(); queueAutoSave();
    });
    $("btnClearObj").addEventListener("click", ()=>{
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      queueAutoSave();
    });

    $("btnEmpSelectAll").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(c=>c.checked=true);
      updateSelectedCount(); queueAutoSave();
    });
    $("btnEmpClearAll").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp-chk="1"]').forEach(c=>c.checked=false);
      updateSelectedCount(); queueAutoSave();
    });

    $("btnCreate").addEventListener("click", ()=>{
      const objId=$("selObj").value;
      const empIds=getSelectedEmpIds();
      const date=$("shiftDate").value;
      const start=$("shiftStart").value;
      const end=$("shiftEnd").value;

      if(!objId) return alert("Objekt wählen.");
      if(empIds.length===0) return alert("Mindestens 1 Mitarbeiter auswählen.");
      if(!date || !start || !end) return alert("Datum/Start/Ende ausfüllen.");

      const obj=store.objects.find(x=>x.id===objId);
      const fallbackType=(store.company?.defaultType||"").trim();
      const existing = selectedEinsatzId ? store.einsaetze.find(x=>x.id===selectedEinsatzId) : null;

      if(existing){
        existing.objId=objId;
        existing.empIds=empIds;
        existing.date=date;
        existing.start=start;
        existing.end=end;
        existing.type=obj?.type || fallbackType || "Einsatz";
        existing.sigAgDataUrl=store.sigAgDataUrl||null;
      }else{
        store.einsaetze.push({
          id:uid(),
          objId, empIds,
          date, start, end,
          type: obj?.type || fallbackType || "Einsatz",
          sigAgDataUrl: store.sigAgDataUrl || null,
          createdAt: Date.now()
        });
      }
      saveStore();
      renderEinsaetze();
      alert(existing ? "Einsatz updated ✅" : "Einsatz saved ✅");
    });

    $("btnDelete").addEventListener("click", ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      if(!confirm("Delete selected Einsatz?")) return;
      store.einsaetze=store.einsaetze.filter(x=>x.id!==selectedEinsatzId);
      selectedEinsatzId=null;
      saveStore();
      renderEinsaetze();
    });

    document.addEventListener("click", (e)=>{
      const signId=e.target?.getAttribute?.("data-sign-emp");
      if(signId){ openEmpSigModal(signId); return; }

      const delEmp=e.target?.getAttribute?.("data-del-emp");
      if(delEmp){
        if(!confirm("Delete Mitarbeiter?")) return;
        store.employees=store.employees.filter(x=>x.id!==delEmp);
        store.einsaetze.forEach(en=>{ en.empIds=(en.empIds||[]).filter(id=>id!==delEmp); });
        saveStore(); renderAll(); queueAutoSave();
        return;
      }

      const delObj=e.target?.getAttribute?.("data-del-obj");
      if(delObj){
        if(!confirm("Delete Objekt?")) return;
        store.objects=store.objects.filter(x=>x.id!==delObj);
        saveStore(); renderAll(); queueAutoSave();
        return;
      }

      const pickEin=e.target?.getAttribute?.("data-pick-ein");
      if(pickEin){
        selectedEinsatzId=pickEin;
        const ein=store.einsaetze.find(x=>x.id===selectedEinsatzId);
        if(ein){
          $("selObj").value=ein.objId||$("selObj").value;
          $("shiftDate").value=ein.date||$("shiftDate").value;
          $("shiftStart").value=ein.start||$("shiftStart").value;
          $("shiftEnd").value=ein.end||$("shiftEnd").value;
          setSelectedEmpIds(ein.empIds||[]);
        }
        renderEinsaetze();
        queueAutoSave();
      }
    });

    /* =======================
       BACKUP / RESTORE
    ======================= */
    function downloadText(filename, text, mime="text/plain"){
      const blob=new Blob([text], {type:mime});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    $("btnBackup").addEventListener("click", ()=>{
      const payload={ store, draft: collectDraft() };
      downloadText("einsatzmeldung-backup-full.json", JSON.stringify(payload, null, 2), "application/json");
    });

    $("btnRestore").addEventListener("click", ()=>{
      const input=document.createElement("input");
      input.type="file"; input.accept="application/json";
      input.onchange=()=>{
        const file=input.files?.[0];
        if(!file) return;
        const r=new FileReader();
        r.onload=()=>{
          const payload=safeParse(String(r.result||""), null);
          if(!payload || typeof payload!=="object"){ alert("Invalid backup."); return; }
          if(payload.store) store=payload.store;
          saveStore();
          if(payload.draft) localStorage.setItem(DRAFT_KEY, JSON.stringify(payload.draft));
          renderAll();
          restoreDraftToUI();
          alert("Restore done ✅");
        };
        r.readAsText(file);
      };
      input.click();
    });

    $("btnClearDraft").addEventListener("click", ()=>{
      if(!confirm("Clear saved draft?")) return;
      localStorage.removeItem(DRAFT_KEY);
      location.reload();
    });

    /* =======================
       RANGE EXPORT/IMPORT
    ======================= */
    function ymdToNum(ymd){
      if(!ymd) return null;
      const n=Number(ymd.replaceAll("-",""));
      return Number.isFinite(n)?n:null;
    }
    function getEinsaetzeInRange(fromYmd,toYmd){
      const fromN=ymdToNum(fromYmd), toN=ymdToNum(toYmd);
      if(!fromN && !toN) return store.einsaetze.slice();
      return store.einsaetze.filter(e=>{
        const d=ymdToNum(e.date);
        if(!d) return false;
        if(fromN && d<fromN) return false;
        if(toN && d>toN) return false;
        return true;
      });
    }
    function resolveObj(objId){ return store.objects.find(o=>o.id===objId) || null; }
    function resolveEmp(empId){ return store.employees.find(e=>e.id===empId) || null; }
    function csvEscape(v){ const s=String(v??""); return `"${s.replaceAll('"','""')}"`; }

    $("btnExportRangeJson").addEventListener("click", ()=>{
      const from=$("expFrom").value, to=$("expTo").value;
      const items=getEinsaetzeInRange(from,to);
      if(items.length===0) return alert("No Einsätze in this range.");
      const payload={
        exportedAt:new Date().toISOString(),
        range:{from:from||null, to:to||null},
        company:store.company||null,
        logoDataUrl:store.logoDataUrl||null,
        logoPosition:store.logoPosition||"left",
        logoPositionApp:store.logoPositionApp||"left",
        employees:store.employees||[],
        objects:store.objects||[],
        einsaetze:items||[],
        sigAgDataUrl: store.sigAgDataUrl || null
      };
      downloadText(`einsatz-export-${from||"all"}-to-${to||"all"}.json`, JSON.stringify(payload,null,2), "application/json");
    });

    $("btnExportRangeCsv").addEventListener("click", ()=>{
      const from=$("expFrom").value, to=$("expTo").value;
      const items=getEinsaetzeInRange(from,to);
      if(items.length===0) return alert("No Einsätze in this range.");
      const header=["Datum","Start","Ende","Typ","Kunde","Objekt","Adresse","Objekt-Typ","Mitarbeiter Name","Bewacher-ID","Position","Telefon","Signature"].map(csvEscape).join(",");
      const rows=[header];
      items.forEach(e=>{
        const obj=resolveObj(e.objId);
        const empIds=e.empIds||[];
        const kunde=obj?.cust||"", objekt=obj?.obj||"", addr=obj?.addr||"", otype=obj?.type||e.type||"";
        if(empIds.length===0){
          rows.push([e.date||"",e.start||"",e.end||"",e.type||"",kunde,objekt,addr,otype,"","","","",""].map(csvEscape).join(","));
          return;
        }
        empIds.forEach(empId=>{
          const emp=resolveEmp(empId);
          rows.push([e.date||"",e.start||"",e.end||"",e.type||"",kunde,objekt,addr,otype,
            emp?.name||"", emp?.bewacher||"", emp?.role||"", emp?.phone||"",
            emp?.sigDataUrl ? "YES" : "NO"
          ].map(csvEscape).join(","));
        });
      });
      downloadText(`einsatz-export-${from||"all"}-to-${to||"all"}.csv`, rows.join("\n"), "text/csv;charset=utf-8");
    });

    $("btnImportRangeJson").addEventListener("click", ()=>{
      const input=document.createElement("input");
      input.type="file"; input.accept="application/json";
      input.onchange=()=>{
        const file=input.files?.[0];
        if(!file) return;
        const r=new FileReader();
        r.onload=()=>{
          const payload=safeParse(String(r.result||""), null);
          if(!payload || typeof payload!=="object") return alert("Invalid JSON.");

          const incomingEmployees=Array.isArray(payload.employees)?payload.employees:[];
          const incomingObjects=Array.isArray(payload.objects)?payload.objects:[];
          const incomingEinsaetze=Array.isArray(payload.einsaetze)?payload.einsaetze:[];
          if(incomingEinsaetze.length===0) return alert("No Einsätze inside JSON.");

          const merge=confirm("OK = MERGE (keep existing)\nCancel = REPLACE (overwrite all)");
          if(!merge){ store=defaultStore(); selectedEinsatzId=null; }

          if(payload.company) store.company={...store.company,...payload.company};
          if(payload.logoDataUrl) store.logoDataUrl=payload.logoDataUrl;
          if(payload.logoPosition) store.logoPosition=payload.logoPosition;
          if(payload.logoPositionApp) store.logoPositionApp=payload.logoPositionApp;
          if(payload.sigAgDataUrl) store.sigAgDataUrl = payload.sigAgDataUrl;

          const empMap=new Map((store.employees||[]).map(e=>[String(e.id), e]));
          incomingEmployees.forEach(e=>{ if(e&&e.id) empMap.set(String(e.id), e); });
          store.employees=Array.from(empMap.values());

          const objMap=new Map((store.objects||[]).map(o=>[String(o.id), o]));
          incomingObjects.forEach(o=>{ if(o&&o.id) objMap.set(String(o.id), o); });
          store.objects=Array.from(objMap.values());

          const einMap=new Map((store.einsaetze||[]).map(x=>[String(x.id), x]));
          incomingEinsaetze.forEach(x=>{ if(x&&x.id) einMap.set(String(x.id), x); });
          store.einsaetze=Array.from(einMap.values());

          saveStore();
          renderAll();
          alert("Import done ✅");
        };
        r.readAsText(file);
      };
      input.click();
    });

    /* =======================
       PDF (Print -> Save as PDF)
    ======================= */
    function formatDateISOToDE(iso){
      if(!iso) return "";
      const [y,m,d]=iso.split("-");
      if(!y||!m||!d) return iso;
      return `${d}.${m}.${y}`;
    }
    function waitForImagesThenPrint(){
      const imgs=Array.from(document.images||[]);
      if(imgs.length===0){ window.print(); return; }
      let done=0;
      const finish=()=>{ done++; if(done>=imgs.length) setTimeout(()=>window.print(), 250); };
      imgs.forEach(img=>{
        if(img.complete) finish();
        else { img.onload=finish; img.onerror=finish; }
      });
      setTimeout(()=>window.print(), 1400);
    }
    async function generatePdfForEinsatz(ein){
      const obj=store.objects.find(x=>x.id===ein.objId);
      const c=store.company||{};
      const logo=store.logoDataUrl||null;
      const logoPos=store.logoPosition||"left";
      const showLogo=(logoPos!=="hide") && !!logo;

      const logoHTML = showLogo ? `<div class="logoBox"><img class="logo" src="${logo}" alt="Logo"/></div>` : ``;

      const headerHTML = (()=>{
        if(!showLogo){
          return `
            <div class="head">
              <div class="leftHead">
                <div>
                  <h1>Einsatzmeldung</h1>
                  <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c)||"")}</div>
                  <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                  ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                </div>
              </div>
              <div style="text-align:right;">
                <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>
          `;
        }
        if(logoPos==="top"){
          return `
            <div class="headTop">
              ${logoHTML}
              <div class="head">
                <div class="leftHead">
                  <div>
                    <h1>Einsatzmeldung</h1>
                    <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c)||"")}</div>
                    <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                    ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                  </div>
                </div>
                <div style="text-align:right;">
                  <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                  <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
                </div>
              </div>
            </div>
          `;
        }
        if(logoPos==="right"){
          return `
            <div class="head">
              <div class="leftHead">
                <div>
                  <h1>Einsatzmeldung</h1>
                  <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c)||"")}</div>
                  <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                  ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
                </div>
              </div>
              <div style="text-align:right; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                ${logoHTML}
                <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>
          `;
        }
        return `
          <div class="head">
            <div class="leftHead">
              ${logoHTML}
              <div>
                <h1>Einsatzmeldung</h1>
                <div class="sub">${escapeHtml(c.name||"")} • ${escapeHtml(companyAddressLine(c)||"")}</div>
                <div class="sub">Tel: ${escapeHtml(c.phone||"")} • E-Mail: <a href="mailto:${escapeHtml(c.email||"")}">${escapeHtml(c.email||"")}</a></div>
                ${c.tax ? `<div class="sub">Steuernummer/USt-IdNr: ${escapeHtml(c.tax)}</div>` : ``}
              </div>
            </div>
            <div style="text-align:right;">
              <div class="sub"><b>Datum:</b> ${formatDateISOToDE(ein.date)}</div>
              <div class="sub"><b>Typ:</b> ${(obj?.type||ein.type||"Einsatz")}</div>
            </div>
          </div>
        `;
      })();

      const employees=(ein.empIds||[]).map(id=>store.employees.find(e=>e.id===id)).filter(Boolean);

      const empRows = employees.length ? employees.map((e,idx)=>{
        const sig = e.sigDataUrl
          ? `<img src="${e.sigDataUrl}" style="max-height:42px; max-width:180px; display:block" alt="Sig"/>`
          : `<div style="height:26px; border:1px solid #111; border-radius:6px;"></div>`;
        return `
          <tr style="page-break-inside:avoid;">
            <td style="padding:6px 8px; border:1px solid #111;">${idx+1}</td>
            <td style="padding:6px 8px; border:1px solid #111;"><b>${escapeHtml(e.name)}</b></td>
            <td style="padding:6px 8px; border:1px solid #111;">${escapeHtml(e.bewacher||"—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">${escapeHtml(e.role||"—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">${sig}</td>
          </tr>
        `;
      }).join("") : `<tr><td colspan="5" style="padding:8px; border:1px solid #111;">—</td></tr>`;

      const sigAgImg = store.sigAgDataUrl || ein.sigAgDataUrl || null;

      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Einsatzmeldung ${formatDateISOToDE(ein.date)}</title>
<style>
  @page{ size:A4; margin:18mm; }
  body{ font-family:Arial,sans-serif; color:#111; }
  .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .leftHead{ display:flex; gap:12px; align-items:center; }
  .headTop{ display:flex; flex-direction:column; gap:10px; }
  .logoBox{ width:64px; height:64px; border:1px solid #111; border-radius:10px; padding:6px; background:#fff; display:flex; align-items:center; justify-content:center; }
  .logo{ width:100%; height:100%; object-fit:contain; display:block; }
  h1{ margin:0; font-size:18px; }
  .sub{ color:#444; margin-top:4px; font-size:12px; }
  .box{ border:1px solid #111; border-radius:10px; padding:12px; margin-top:12px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .label{ font-size:11px; color:#333; margin-bottom:4px; }
  .val{ font-size:12px; font-weight:700; }
  .line{ height:1px; background:#111; opacity:.18; margin:12px 0; }
  .sigimg{ max-height:70px; max-width:100%; display:block; }
  .foot{ margin-top:10px; font-size:10px; color:#333; }
  a{ color:#111; text-decoration:none; }
  table{ border-collapse:collapse; width:100%; font-size:12px; }
  thead{ display:table-header-group; }
  th{ text-align:left; padding:6px 8px; border:1px solid #111; background:#f2f2f2; }
  td{ vertical-align:top; }
</style>
</head>
<body>
  ${headerHTML}

  <div class="box">
    <div class="grid">
      <div>
        <div class="label">Kunde / Objekt</div>
        <div class="val">${escapeHtml(obj?.cust||"—")} — ${escapeHtml(obj?.obj||"—")}</div>
        <div class="sub">Adresse: ${escapeHtml(obj?.addr||"—")}</div>
      </div>
      <div>
        <div class="label">Schichtzeit</div>
        <div class="val">${escapeHtml(ein.start)} – ${escapeHtml(ein.end)}</div>
      </div>
    </div>

    <div class="line"></div>

    <div class="label">Mitarbeiter (Liste)</div>
    <table>
      <thead>
        <tr>
          <th style="width:44px;">#</th>
          <th>Name</th>
          <th style="width:160px;">Bewacher-ID</th>
          <th style="width:140px;">Position</th>
          <th style="width:200px;">Unterschrift Mitarbeiter</th>
        </tr>
      </thead>
      <tbody>${empRows}</tbody>
    </table>

    <div style="margin-top:14px; display:flex; justify-content:space-between; gap:12px; align-items:flex-end;">
      <div style="flex:1;">
        <div class="label">Unterschrift Arbeitgeber / Auftraggeber</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          ${sigAgImg ? `<img class="sigimg" src="${sigAgImg}" alt="Signature Arbeitgeber"/>` : `<div class="sub">—</div>`}
        </div>
      </div>
      <div style="width:240px;">
        <div class="label">Ort / Datum</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          <div style="height:20px;"></div>
          <div style="border-top:1px solid #111; margin-top:26px;"></div>
        </div>
      </div>
    </div>

    <div class="foot">${escapeHtml(c.footerNote||"")}</div>
  </div>

  <script>window.onload = () => (${waitForImagesThenPrint.toString()})();<\/script>
</body>
</html>`;

      const w=window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups to print PDF.");
      w.document.open(); w.document.write(html); w.document.close();
    }

    $("btnPDF").addEventListener("click", async ()=>{
      if(!selectedEinsatzId) return alert("Select Einsatz first.");
      const ein=store.einsaetze.find(x=>x.id===selectedEinsatzId);
      if(!ein) return alert("Einsatz not found.");
      ein.date = $("shiftDate").value || ein.date;
      ein.start = $("shiftStart").value || ein.start;
      ein.end = $("shiftEnd").value || ein.end;
      ein.sigAgDataUrl = store.sigAgDataUrl || null;
      saveStore();
      renderEinsaetze();
      await generatePdfForEinsatz(ein);
    });

    /* =======================
       DRAFT RESTORE
    ======================= */
    function restoreDraftToUI(){
      const d=safeParse(localStorage.getItem(DRAFT_KEY), null) || {};
      if(!d || typeof d!=="object") return;

      $("empName").value=d.empName||"";
      $("empBewacher").value=d.empBewacher||"";
      $("empPhone").value=d.empPhone||"";
      $("empRole").value=d.empRole||"";

      $("custName").value=d.custName||"";
      $("objName").value=d.objName||"";
      $("objAddr").value=d.objAddr||"";
      $("objType").value=d.objType||"Hotel";

      if(d.shiftDate) $("shiftDate").value=d.shiftDate;
      if(d.shiftStart) $("shiftStart").value=d.shiftStart;
      if(d.shiftEnd) $("shiftEnd").value=d.shiftEnd;

      if(d.expFrom) $("expFrom").value=d.expFrom;
      if(d.expTo) $("expTo").value=d.expTo;

      if(d.logoPosition) $("logoPos").value=d.logoPosition;
      if(d.logoPositionApp) $("logoPosApp").value=d.logoPositionApp;
      if(d.selObj) $("selObj").value=d.selObj;

      setSelectedEmpIds(d.selectedEmpIds||[]);
      updateSelectedCount();
    }

    const autosaveIds=[
      "empName","empBewacher","empPhone","empRole",
      "custName","objName","objAddr","objType",
      "selObj","shiftDate","shiftStart","shiftEnd",
      "expFrom","expTo",
      "logoPos","logoPosApp"
    ];
    autosaveIds.forEach(id=>{
      const el=$(id);
      el.addEventListener("input", queueAutoSave);
      el.addEventListener("change", queueAutoSave);
    });

    function initExportDefaults(){
      const today=new Date();
      const to=today.toISOString().slice(0,10);
      const past=new Date(today.getTime()-7*24*60*60*1000);
      const from=past.toISOString().slice(0,10);
      if(!$("expTo").value) $("expTo").value=to;
      if(!$("expFrom").value) $("expFrom").value=from;
    }

    /* =======================
       AUTO LOGO LOAD (if not embedded)
       - tries "logo.png" in same folder (github pages ok)
    ======================= */
    async function tryAutoLoadLogoPng(){
      if(store.logoDataUrl) return;                 // already has logo
      const embedded=makeEmbeddedLogoDataUrl();
      if(embedded){ store.logoDataUrl=embedded; saveStore(); return; }

      // Try fetch logo.png
      try{
        const res=await fetch("logo.png", {cache:"no-store"});
        if(!res.ok) return;
        const blob=await res.blob();
        if(blob.type!=="image/png") return;
        const dataUrl=await new Promise((resolve,reject)=>{
          const fr=new FileReader();
          fr.onload=()=>resolve(String(fr.result||""));
          fr.onerror=reject;
          fr.readAsDataURL(blob);
        });
        store.logoDataUrl=dataUrl;
        saveStore();
      }catch{}
    }

    /* =======================
       INIT
    ======================= */
    (function init(){
      // Ensure store has required defaults if old save is missing fields
      const base=defaultStore();
      store = {
        ...base,
        ...store,
        company:{...base.company, ...(store.company||{})}
      };
      if(!store.logoPosition) store.logoPosition="left";
      if(!store.logoPositionApp) store.logoPositionApp="left";

      renderAll();

      const hasDraft=!!localStorage.getItem(DRAFT_KEY);
      if(!hasDraft){
        const now=new Date();
        $("shiftDate").value=now.toISOString().slice(0,10);
        if(!$("shiftStart").value) $("shiftStart").value="18:00";
        if(!$("shiftEnd").value) $("shiftEnd").value="06:00";
        initExportDefaults();
      }

      restoreDraftToUI();
      if(!$("expFrom").value || !$("expTo").value) initExportDefaults();

      applyLogoPosPDF();
      applyLogoPositionUI();
      refreshBrand();

      // Auto load logo if not embedded
      tryAutoLoadLogoPng().then(()=>{
        applyLogo();
        refreshBrand();
      });

      // Arbeitgeber signature restore
      if(store.sigAgDataUrl) agPad.fromDataUrl(store.sigAgDataUrl);

      setSaveStatus("saved");
      showTab("app");
    })();
  </script>
</body>
</html>
