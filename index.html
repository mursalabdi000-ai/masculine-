<!-- =========================
FILE: index.html
========================= -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Masculine Security ‚Äî Mini Office</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs/%3E%3Crect width='64' height='64' rx='16' fill='%230b1220'/%3E%3Cpath d='M10 40c9-18 20-18 44-22-4 20-18 28-34 30-4 .5-7-.5-10-2z' fill='%233aa6ff' opacity='.9'/%3E%3Ctext x='16' y='40' font-family='Arial' font-size='18' fill='%23e7eeff'%3EMS%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2f; --panel2:#0c1629; --card:#10203a;
      --muted:#93a4c6; --text:#e7eeff; --line:#1a2a4b;
      --accent:#3aa6ff; --accent2:#2bd4bd; --danger:#ff4d6d;
      --shadow:0 14px 40px rgba(0,0,0,.45);
      --radius:16px; --radius2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(1000px 600px at 90% 10%, rgba(43,212,189,.18), transparent 55%),
        linear-gradient(180deg, #07101f 0%, #070d18 100%);
      color:var(--text);
    }
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      padding:18px;
      max-width:1320px;
      margin:0 auto;
    }
    .sidebar{
      background: linear-gradient(180deg, rgba(16,32,58,.78), rgba(12,22,41,.78));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:sticky; top:14px; height: calc(100vh - 28px);
      display:flex; flex-direction:column;
      z-index:2;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius: var(--radius2);
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.05);
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(58,166,255,.9), rgba(43,212,189,.9));
      display:grid; place-items:center;
      color:#06101f; font-weight:900;
    }
    .brand h1{margin:0; font-size:14px}
    .brand small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .nav{margin-top:12px; display:flex; flex-direction:column; gap:8px}
    .nav button{
      all:unset;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 12px;
      border-radius: 14px; cursor:pointer;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      transition: .15s ease;
      user-select:none;
    }
    .nav button:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.35); background: rgba(58,166,255,.08)}
    .nav button.active{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.14)}
    .nav .left{display:flex; align-items:center; gap:10px; font-weight:800; font-size:13px}
    .pill{font-size:12px; color:var(--muted); padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.16)}
    .foot{margin-top:auto; padding:10px; border-top:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:12px}

    .main{
      background: linear-gradient(180deg, rgba(16,32,58,.55), rgba(12,22,41,.55));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: calc(100vh - 36px);
      z-index:1;
    }
    .topbar{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
    }
    .crumb h2{margin:0; font-size:14px}
    .crumb small{color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px; border-radius: 12px;
      cursor:pointer; transition:.15s ease;
      font-weight:800; font-size:13px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(58,166,255,.4); background: rgba(58,166,255,.10)}
    .btn.primary{border-color: rgba(58,166,255,.55); background: rgba(58,166,255,.16)}
    .btn.good{border-color: rgba(43,212,189,.55); background: rgba(43,212,189,.14)}
    .btn.danger{border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10)}

    .content{padding:14px; display:grid; gap:14px}
    .grid2{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:14px}
    .card{background: rgba(16,32,58,.55); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius2); padding:14px}
    .card h3{margin:0 0 10px 0; font-size:14px}
    .muted{color:var(--muted)}
    .kpi{display:flex; align-items:flex-end; justify-content:space-between; gap:10px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi .label{color:var(--muted); font-size:12px; font-weight:800}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color:var(--muted)}
    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 12px}
    .table th,.table td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; font-size:13px}
    .table th{color:var(--muted); font-weight:900; font-size:12px}
    .right{text-align:right}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted); font-weight:900}
    .field input,.field select,.field textarea{
      width:100%; padding:10px 12px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18); color:var(--text); outline:none;
    }
    .field textarea{min-height:96px; resize:vertical}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .notice{border:1px dashed rgba(58,166,255,.45); background: rgba(58,166,255,.08); padding:12px; border-radius: 12px; font-size:13px}
    .hide{display:none !important}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:10px 0}

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    /* PRINT: only print invoice/payroll templates opened in new window, NOT this app */
    @media print { body { background:#fff !important; color:#000 !important; } }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">MS</div>
      <div>
        <h1>Masculine Security</h1>
        <small>Mini Office ‚Ä¢ Offline (local)</small>
      </div>
    </div>

    <div class="nav" id="nav">
      <button data-page="overview" class="active"><div class="left">üè† √úbersicht <span class="pill">KPIs</span></div><span class="pill">‚Äì</span></button>
      <button data-page="customers"><div class="left">üë§ Kunden</div><span class="pill" id="countCustomers">0</span></button>
      <button data-page="invoices"><div class="left">üßæ Rechnungen</div><span class="pill" id="countInvoices">0</span></button>
      <button data-page="expenses"><div class="left">üí≥ Ausgaben</div><span class="pill" id="countExpenses">0</span></button>
      <button data-page="payroll"><div class="left">üíº Lohnabrechnung</div><span class="pill" id="countPayroll">0</span></button>
      <button data-page="emailpdf"><div class="left">‚úâÔ∏è Email + PDF</div><span class="pill">Export</span></button>
      <button data-page="settings"><div class="left">‚öôÔ∏è Einstellungen</div><span class="pill">Save</span></button>
    </div>

    <div class="foot">
      <div><b>Tipp:</b> GitHub commit ‚Üí Netlify auto deploy.</div>
      <div class="muted">Haddii update muuqan waayo: Ctrl+Shift+R</div>
      <div class="muted" id="versionLabel"></div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumb">
        <h2 id="pageTitle">√úbersicht</h2>
        <small id="pageSub" class="muted">Umsatz ‚Ä¢ Ausgaben ‚Ä¢ Kunden ‚Ä¢ Rechnungen (offline)</small>
      </div>
      <div class="actions">
        <button class="btn primary" id="quickInvoice">+ Rechnung</button>
        <button class="btn" id="quickCustomer">+ Kunde</button>
        <button class="btn" id="quickExpense">+ Ausgabe</button>
        <button class="btn good" id="btnExport">Export JSON</button>
        <button class="btn" id="btnImport">Import JSON</button>
      </div>
    </div>

    <div class="content">
      <!-- OVERVIEW -->
      <section id="page-overview">
        <div class="grid3">
          <div class="card"><div class="kpi"><div><div class="label">Umsatz (dieses Jahr)</div><div class="value" id="kpiYearRevenue">0,00 ‚Ç¨</div><div class="muted" style="font-size:12px">Rechnungen: <span id="kpiInvoiceCount">0</span></div></div><span class="tag">üßæ</span></div></div>
          <div class="card"><div class="kpi"><div><div class="label">Ausgaben (dieses Jahr)</div><div class="value" id="kpiYearExpenses">0,00 ‚Ç¨</div><div class="muted" style="font-size:12px">Betrag total gespeichert</div></div><span class="tag">üí≥</span></div></div>
          <div class="card"><div class="kpi"><div><div class="label">Kleinunternehmer</div><div class="value">¬ß19 UStG</div><div class="muted" style="font-size:12px">USt wird nicht berechnet</div></div><span class="tag">‚úÖ</span></div></div>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Letzte Aktivit√§ten</h3>
            <table class="table">
              <thead><tr><th>Typ</th><th>Beschreibung</th><th>Datum</th><th class="right">Betrag</th></tr></thead>
              <tbody id="recentList"></tbody>
            </table>
            <div class="muted" style="margin-top:10px">Offline via localStorage.</div>
          </div>
          <div class="card">
            <h3>Schnellstart</h3>
            <div class="notice">
              Lexoffice-Style: links Navigation, oben Aktionen, Daten offline.<br>
              <b>PDF:</b> ‚ÄúPDF √∂ffnen‚Äù ‚Üí tab cusub ‚Üí Save as PDF (hal page).
            </div>
            <div class="hr"></div>
            <div class="split">
              <button class="btn primary" onclick="UI.go('invoices')">+ Rechnung</button>
              <button class="btn" onclick="UI.go('customers')">+ Kunde</button>
            </div>
            <div class="split" style="margin-top:10px">
              <button class="btn" onclick="UI.go('expenses')">+ Ausgabe</button>
              <button class="btn good" onclick="UI.go('emailpdf')">Email + PDF</button>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section id="page-customers" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Kunde hinzuf√ºgen</h3>
            <div class="field"><label>Name / Firma</label><input id="c_name" placeholder="z.B. Beispiel Kunde GmbH"></div>
            <div class="field"><label>Email</label><input id="c_email" placeholder="kunde@email.de"></div>
            <div class="field"><label>Adresse</label><input id="c_addr" placeholder="Stra√üe, PLZ Ort"></div>
            <button class="btn primary" onclick="Customers.add()">Speichern</button>
            <button class="btn danger" onclick="Customers.clearForm()">Leeren</button>
          </div>
          <div class="card">
            <h3>Kundenliste</h3>
            <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Adresse</th><th class="right">Aktion</th></tr></thead>
              <tbody id="customersList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVOICES -->
      <section id="page-invoices" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Rechnung erstellen</h3>
            <div class="split">
              <div class="field"><label>Rechnungs-Nr.</label><input id="i_no" placeholder="RE-2026-0001"></div>
              <div class="field"><label>Datum</label><input id="i_date" type="date"></div>
            </div>
            <div class="field"><label>Kunde</label><select id="i_customer"></select></div>
            <div class="split">
              <div class="field"><label>Leistung / Beschreibung</label><input id="i_desc" placeholder="z.B. Objektschutz 12h"></div>
              <div class="field"><label>Betrag (‚Ç¨)</label><input id="i_net" type="number" step="0.01" placeholder="0.00"></div>
            </div>

            <div class="notice">
              <b>Umsatzsteuer:</b> 0,00 ‚Ç¨<br>
              <span class="muted">Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.</span>
            </div>

            <div class="split" style="margin-top:10px">
              <div class="field"><label>Status</label>
                <select id="i_status">
                  <option value="Entwurf">Entwurf</option>
                  <option value="Gesendet">Gesendet</option>
                  <option value="Bezahlt">Bezahlt</option>
                </select>
              </div>
              <div class="field"><label>USt %</label><input value="0" disabled></div>
            </div>

            <button class="btn primary" onclick="Invoices.add()">Speichern</button>
            <button class="btn" onclick="Invoices.print()">PDF √∂ffnen</button>
            <button class="btn danger" onclick="Invoices.clearForm()">Leeren</button>
            <div class="muted" style="margin-top:10px">PDF: tab cusub ‚Üí Print ‚Üí Save as PDF (1 page).</div>
          </div>

          <div class="card">
            <h3>Rechnungen</h3>
            <table class="table">
              <thead><tr><th>Nr.</th><th>Kunde</th><th>Datum</th><th>Status</th><th class="right">Betrag</th><th class="right">Aktion</th></tr></thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EXPENSES -->
      <section id="page-expenses" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Ausgabe hinzuf√ºgen</h3>
            <div class="split">
              <div class="field"><label>Datum</label><input id="e_date" type="date"></div>
              <div class="field"><label>Betrag (‚Ç¨)</label><input id="e_amount" type="number" step="0.01" placeholder="0.00"></div>
            </div>
            <div class="field"><label>Kategorie</label>
              <select id="e_cat">
                <option>B√ºromaterial</option>
                <option>Fahrtkosten</option>
                <option>Versicherung</option>
                <option>Telefon/Internet</option>
                <option>Sonstiges</option>
              </select>
            </div>
            <div class="field"><label>Notiz</label><input id="e_note" placeholder="z.B. Quittung #123"></div>
            <button class="btn primary" onclick="Expenses.add()">Speichern</button>
            <button class="btn danger" onclick="Expenses.clearForm()">Leeren</button>
          </div>
          <div class="card">
            <h3>Ausgabenliste</h3>
            <table class="table">
              <thead><tr><th>Datum</th><th>Kategorie</th><th>Notiz</th><th class="right">Betrag</th><th class="right">Aktion</th></tr></thead>
              <tbody id="expensesList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PAYROLL -->
      <section id="page-payroll" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Lohnabrechnung (intern)</h3>
            <div class="split">
              <div class="field"><label>Mitarbeiter Name</label><input id="p_name" placeholder="Name"></div>
              <div class="field"><label>Monat (YYYY-MM)</label><input id="p_month" placeholder="2026-02"></div>
            </div>
            <div class="split">
              <div class="field"><label>Stunden</label><input id="p_hours" type="number" step="0.01" placeholder="0"></div>
              <div class="field"><label>Stundenlohn (‚Ç¨)</label><input id="p_rate" type="number" step="0.01" placeholder="16.00"></div>
            </div>
            <div class="field"><label>Abz√ºge (‚Ç¨)</label><input id="p_deduct" type="number" step="0.01" value="0"></div>
            <button class="btn primary" onclick="Payroll.add()">Speichern</button>
            <button class="btn" onclick="Payroll.print()">PDF √∂ffnen</button>
            <button class="btn danger" onclick="Payroll.clearForm()">Leeren</button>
            <div class="muted" style="margin-top:10px">Tani waa list gudaha ah (ma aha dokument rasmi ah).</div>
          </div>
          <div class="card">
            <h3>Lohnliste</h3>
            <table class="table">
              <thead><tr><th>Monat</th><th>Name</th><th>Stunden</th><th class="right">Brutto</th><th class="right">Netto</th><th class="right">Aktion</th></tr></thead>
              <tbody id="payrollList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- EMAIL + PDF -->
      <section id="page-emailpdf" class="hide">
        <div class="card">
          <h3>Email (mailto) + PDF</h3>
          <div class="notice">
            Browser-ka ayaa fura email app-ka (mailto). PDF-ka waxa laga sameeyaa ‚ÄúPDF √∂ffnen‚Äù (invoice/payroll).
          </div>
          <div class="split" style="margin-top:10px">
            <div class="field"><label>To</label><input id="m_to" placeholder="z.B. buchhaltung@firma.de"></div>
            <div class="field"><label>Subject</label><input id="m_subj" value="Dokumente ‚Äì Rechnung / Lohnabrechnung"></div>
          </div>
          <div class="field"><label>Message</label><textarea id="m_msg">Guten Tag,&#10;&#10;anbei die gew√ºnschten Unterlagen.&#10;&#10;Viele Gr√º√üe</textarea></div>
          <button class="btn primary" onclick="Mailto.open()">Email √∂ffnen</button>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="page-settings" class="hide">
        <div class="grid2">
          <div class="card">
            <h3>Firmendaten (Save)</h3>
            <div class="field"><label>Firmenname</label><input id="s_company" placeholder="Masculine Security"></div>
            <div class="field"><label>Dein Name</label><input id="s_name" placeholder="Mustafa Abdi"></div>
            <div class="field"><label>Adresse</label><input id="s_addr" placeholder="Werschenregerstra√üe 6, 28237 Bremen"></div>
            <div class="field"><label>Email</label><input id="s_email" placeholder="kontakt.mass.bremen@hotmail.com"></div>
            <div class="field"><label>IBAN</label><input id="s_iban" placeholder="DE98 1001 1001 2333 0146 96"></div>
            <div class="field"><label>Kleinunternehmer Text</label>
              <textarea id="s_klein_text">Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.</textarea>
            </div>
            <button class="btn primary" onclick="Settings.save()">Save</button>
            <button class="btn danger" onclick="Settings.reset()">Reset</button>
          </div>

          <div class="card">
            <h3>Backup</h3>
            <button class="btn good" onclick="Backup.export()">Export JSON</button>
            <button class="btn" onclick="Backup.import()">Import JSON</button>
            <button class="btn danger" onclick="Backup.clearAll()">Alles l√∂schen</button>
            <div class="muted" style="margin-top:10px">Haddii app ‚Äúqallooco‚Äù, samee Export ‚Üí kadib Clear ‚Üí Import.</div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
/* =========================================================
SAFE SINGLE-FILE JS (NO "already declared" errors)
Everything inside IIFE so it won't redeclare on refresh.
========================================================= */
(() => {
  const APP_VERSION = "v1.0-baseline";
  const LS_KEY = "ms_mini_office_v1";

  const $ = (id) => document.getElementById(id);

  const todayISO = () => {
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  };

  const moneyDE = (n) => (Number(n||0)).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}) + " ‚Ç¨";

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return {
        settings:{
          company:"Masculine Security",
          name:"Mustafa Abdi",
          addr:"Werschenregerstra√üe 6, 28237 Bremen",
          email:"kontakt.mass.bremen@hotmail.com",
          iban:"DE98 1001 1001 2333 0146 96",
          klein_text:"Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."
        },
        customers:[],
        invoices:[],
        expenses:[],
        payroll:[]
      };
      return JSON.parse(raw);
    }catch(e){
      console.error("loadState error", e);
      return {
        settings:{company:"Masculine Security", name:"Mustafa Abdi", addr:"", email:"", iban:"", klein_text:"Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."},
        customers:[], invoices:[], expenses:[], payroll:[]
      };
    }
  }

  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    renderAll();
  }

  const state = loadState();

  const UI = {
    go(page){
      document.querySelectorAll(".nav button").forEach(b => b.classList.toggle("active", b.dataset.page===page));
      document.querySelectorAll(".content section").forEach(s => s.classList.add("hide"));
      $("page-"+page).classList.remove("hide");

      const titles = {
        overview:["√úbersicht","Umsatz ‚Ä¢ Ausgaben ‚Ä¢ Kunden ‚Ä¢ Rechnungen (offline)"],
        customers:["Kunden","Kunden verwalten"],
        invoices:["Rechnungen","Rechnung erstellen ‚Ä¢ PDF √∂ffnen ‚Ä¢ Status"],
        expenses:["Ausgaben","Ausgaben speichern"],
        payroll:["Lohnabrechnung","Interne Lohnliste + PDF"],
        emailpdf:["Email + PDF","Mailto √∂ffnen (PDF separat)"],
        settings:["Einstellungen","Firmendaten + Backup"]
      };
      $("pageTitle").textContent = titles[page][0];
      $("pageSub").textContent = titles[page][1];
    }
  };
  window.UI = UI;

  // NAV click
  $("nav").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-page]");
    if(!btn) return;
    UI.go(btn.dataset.page);
  });

  // Quick actions
  $("quickInvoice").onclick = () => UI.go("invoices");
  $("quickCustomer").onclick = () => UI.go("customers");
  $("quickExpense").onclick = () => UI.go("expenses");

  // SETTINGS
  const Settings = {
    loadForm(){
      $("s_company").value = state.settings.company || "";
      $("s_name").value = state.settings.name || "";
      $("s_addr").value = state.settings.addr || "";
      $("s_email").value = state.settings.email || "";
      $("s_iban").value = state.settings.iban || "";
      $("s_klein_text").value = state.settings.klein_text || "";
    },
    save(){
      state.settings.company = $("s_company").value.trim();
      state.settings.name = $("s_name").value.trim();
      state.settings.addr = $("s_addr").value.trim();
      state.settings.email = $("s_email").value.trim();
      state.settings.iban = $("s_iban").value.trim();
      state.settings.klein_text = $("s_klein_text").value.trim() || "Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.";
      saveState();
      alert("Saved ‚úÖ");
    },
    reset(){
      if(!confirm("Reset settings?")) return;
      state.settings = {company:"Masculine Security", name:"Mustafa Abdi", addr:"", email:"", iban:"", klein_text:"Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet."};
      saveState();
      Settings.loadForm();
    }
  };
  window.Settings = Settings;

  // CUSTOMERS
  const Customers = {
    add(){
      const name = $("c_name").value.trim();
      if(!name) return alert("Name fehlt");
      state.customers.push({
        id: crypto.randomUUID(),
        name,
        email: $("c_email").value.trim(),
        addr: $("c_addr").value.trim()
      });
      Customers.clearForm();
      saveState();
    },
    remove(id){
      state.customers = state.customers.filter(c=>c.id!==id);
      saveState();
    },
    clearForm(){
      $("c_name").value=""; $("c_email").value=""; $("c_addr").value="";
    }
  };
  window.Customers = Customers;

  // INVOICES (Kleinunternehmer: VAT always 0; amount is total)
  const Invoices = {
    nextNo(){
      const y = new Date().getFullYear();
      const n = state.invoices.length + 1;
      return `RE-${y}-${String(n).padStart(4,"0")}`;
    },
    fillDefaults(){
      if(!$("i_no").value) $("i_no").value = Invoices.nextNo();
      if(!$("i_date").value) $("i_date").value = todayISO();
      Invoices.refreshCustomerSelect();
    },
    refreshCustomerSelect(){
      const sel = $("i_customer");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value=""; opt0.textContent="‚Äî Kunde w√§hlen ‚Äî";
      sel.appendChild(opt0);
      for(const c of state.customers){
        const o = document.createElement("option");
        o.value=c.id; o.textContent=c.name;
        sel.appendChild(o);
      }
    },
    add(){
      const no = $("i_no").value.trim() || Invoices.nextNo();
      const date = $("i_date").value || todayISO();
      const custId = $("i_customer").value;
      const desc = $("i_desc").value.trim();
      const amount = Number($("i_net").value || 0);

      if(!desc) return alert("Beschreibung fehlt");
      if(!amount || amount<=0) return alert("Betrag fehlt");

      const customer = state.customers.find(c=>c.id===custId) || {name:"(ohne Kunde)", email:"", addr:""};

      state.invoices.unshift({
        id: crypto.randomUUID(),
        no, date,
        customer,
        desc,
        amount, // total (no VAT)
        vat: 0,
        status: $("i_status").value
      });

      saveState();
      alert("Rechnung gespeichert ‚úÖ");
    },
    clearForm(){
      $("i_no").value=""; $("i_date").value=""; $("i_customer").value="";
      $("i_desc").value=""; $("i_net").value="";
      $("i_status").value="Entwurf";
      Invoices.fillDefaults();
    },
    remove(id){
      state.invoices = state.invoices.filter(i=>i.id!==id);
      saveState();
    },
    print(id){
      const inv = id ? state.invoices.find(i=>i.id===id) : null;
      const use = inv || (() => {
        // print from form without saving
        const no = $("i_no").value.trim() || Invoices.nextNo();
        const date = $("i_date").value || todayISO();
        const custId = $("i_customer").value;
        const customer = state.customers.find(c=>c.id===custId) || {name:"(ohne Kunde)", email:"", addr:""};
        return {
          no, date, customer,
          desc: $("i_desc").value.trim() || "(ohne Beschreibung)",
          amount: Number($("i_net").value||0),
          vat:0,
          status: $("i_status").value
        };
      })();

      const s = state.settings;
      const html = `
<!doctype html><html lang="de"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rechnung ${escapeHtml(use.no)}</title>
<style>
  body{font-family:Arial, sans-serif; margin:32px; color:#111}
  .top{display:flex; justify-content:space-between; gap:16px}
  .box{border:1px solid #ddd; padding:12px; border-radius:10px}
  h1{margin:0 0 8px 0; font-size:20px}
  .muted{color:#555; font-size:12px}
  table{width:100%; border-collapse:collapse; margin-top:16px}
  th,td{border-bottom:1px solid #eee; padding:10px; text-align:left}
  th{font-size:12px; color:#444}
  .r{text-align:right}
  .total{font-weight:800}
  @media print{.noprint{display:none}}
</style>
</head><body>
<div class="top">
  <div>
    <h1>${escapeHtml(s.company || "Firma")}</h1>
    <div class="muted">${escapeHtml(s.name||"")}</div>
    <div class="muted">${escapeHtml(s.addr||"")}</div>
    <div class="muted">${escapeHtml(s.email||"")}</div>
    <div class="muted">IBAN: ${escapeHtml(s.iban||"")}</div>
  </div>
  <div class="box">
    <div><b>Rechnung</b></div>
    <div class="muted">Nr.: ${escapeHtml(use.no)}</div>
    <div class="muted">Datum: ${escapeHtml(use.date)}</div>
    <div class="muted">Status: ${escapeHtml(use.status||"")}</div>
  </div>
</div>

<div class="box" style="margin-top:16px">
  <b>Rechnung an:</b><br>
  ${escapeHtml(use.customer?.name||"")}<br>
  <span class="muted">${escapeHtml(use.customer?.addr||"")}</span><br>
  <span class="muted">${escapeHtml(use.customer?.email||"")}</span>
</div>

<table>
  <thead><tr><th>Leistung</th><th class="r">Betrag</th></tr></thead>
  <tbody>
    <tr><td>${escapeHtml(use.desc)}</td><td class="r">${moneyDE(use.amount)}</td></tr>
    <tr><td class="r total">Umsatzsteuer</td><td class="r total">${moneyDE(0)}</td></tr>
    <tr><td class="r total">Gesamt</td><td class="r total">${moneyDE(use.amount)}</td></tr>
  </tbody>
</table>

<div class="muted" style="margin-top:12px">${escapeHtml(s.klein_text || "Hinweis: Gem√§√ü ¬ß19 UStG wird keine Umsatzsteuer berechnet.")}</div>

<div class="noprint" style="margin-top:18px">
  <button onclick="window.print()">Print / Save as PDF</button>
</div>
</body></html>
      `.trim();

      const w = window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups then try again.");
      w.document.open(); w.document.write(html); w.document.close();
      w.focus();
    }
  };
  window.Invoices = Invoices;

  // EXPENSES
  const Expenses = {
    add(){
      const date = $("e_date").value || todayISO();
      const amount = Number($("e_amount").value||0);
      if(!amount || amount<=0) return alert("Betrag fehlt");
      state.expenses.unshift({
        id: crypto.randomUUID(),
        date,
        cat: $("e_cat").value,
        note: $("e_note").value.trim(),
        amount
      });
      Expenses.clearForm();
      saveState();
    },
    remove(id){
      state.expenses = state.expenses.filter(e=>e.id!==id);
      saveState();
    },
    clearForm(){
      $("e_date").value = todayISO();
      $("e_amount").value=""; $("e_note").value="";
      $("e_cat").value="B√ºromaterial";
    }
  };
  window.Expenses = Expenses;

  // PAYROLL
  const Payroll = {
    add(){
      const name = $("p_name").value.trim();
      const month = $("p_month").value.trim();
      const hours = Number($("p_hours").value||0);
      const rate = Number($("p_rate").value||0);
      const deduct = Number($("p_deduct").value||0);
      if(!name || !month) return alert("Name/Monat fehlt");
      if(hours<=0 || rate<=0) return alert("Stunden/Stundenlohn fehlt");
      const brutto = hours*rate;
      const netto = Math.max(0, brutto - deduct);
      state.payroll.unshift({
        id: crypto.randomUUID(),
        name, month, hours, rate, deduct, brutto, netto
      });
      Payroll.clearForm();
      saveState();
    },
    remove(id){
      state.payroll = state.payroll.filter(p=>p.id!==id);
      saveState();
    },
    clearForm(){
      $("p_name").value=""; $("p_month").value=""; $("p_hours").value=""; $("p_rate").value=""; $("p_deduct").value="0";
    },
    print(id){
      const p = id ? state.payroll.find(x=>x.id===id) : null;
      if(!p) return alert("Select entry to print");
      const s = state.settings;
      const html = `
<!doctype html><html><head><meta charset="utf-8"><title>Lohn ${escapeHtml(p.month)}</title>
<style>body{font-family:Arial;margin:32px;color:#111}.box{border:1px solid #ddd;padding:12px;border-radius:10px;margin-bottom:12px}table{width:100%;border-collapse:collapse}td{padding:10px;border-bottom:1px solid #eee}.r{text-align:right}.b{font-weight:800}</style>
</head><body>
<div class="box"><div class="b">${escapeHtml(s.company||"Firma")}</div><div>${escapeHtml(s.addr||"")}</div></div>
<div class="box"><div class="b">Lohnabrechnung (intern)</div><div>Mitarbeiter: ${escapeHtml(p.name)}</div><div>Monat: ${escapeHtml(p.month)}</div></div>
<table>
<tr><td>Stunden</td><td class="r">${p.hours}</td></tr>
<tr><td>Stundenlohn</td><td class="r">${moneyDE(p.rate)}</td></tr>
<tr><td class="b">Brutto</td><td class="r b">${moneyDE(p.brutto)}</td></tr>
<tr><td>Abz√ºge</td><td class="r">${moneyDE(p.deduct)}</td></tr>
<tr><td class="b">Netto</td><td class="r b">${moneyDE(p.netto)}</td></tr>
</table>
<div style="margin-top:16px"><button onclick="window.print()">Print / Save as PDF</button></div>
</body></html>`;
      const w = window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups then try again.");
      w.document.open(); w.document.write(html); w.document.close();
      w.focus();
    }
  };
  window.Payroll = Payroll;

  // MAILTO
  const Mailto = {
    open(){
      const to = $("m_to").value.trim();
      const subj = encodeURIComponent($("m_subj").value.trim());
      const msg = encodeURIComponent($("m_msg").value);
      if(!to) return alert("To fehlt");
      window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${msg}`;
    }
  };
  window.Mailto = Mailto;

  // BACKUP
  const Backup = {
    export(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ms-mini-office-backup.json";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    },
    import(){
      const inp = document.createElement("input");
      inp.type="file"; inp.accept="application/json";
      inp.onchange = () => {
        const f = inp.files && inp.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try{
            const data = JSON.parse(String(r.result||""));
            // basic shape
            if(!data || typeof data !== "object") throw new Error("Bad JSON");
            Object.assign(state, data);
            saveState();
            Settings.loadForm();
            alert("Import OK ‚úÖ");
          }catch(e){ alert("Import error: " + e.message); }
        };
        r.readAsText(f);
      };
      inp.click();
    },
    clearAll(){
      if(!confirm("Alles l√∂schen?")) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    }
  };
  window.Backup = Backup;

  // Top buttons
  $("btnExport").onclick = Backup.export;
  $("btnImport").onclick = Backup.import;

  // Render
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderCounts(){
    $("countCustomers").textContent = state.customers.length;
    $("countInvoices").textContent = state.invoices.length;
    $("countExpenses").textContent = state.expenses.length;
    $("countPayroll").textContent = state.payroll.length;
  }

  function renderCustomers(){
    const tb = $("customersList");
    tb.innerHTML = "";
    for(const c of state.customers){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td class="muted">${escapeHtml(c.email||"")}</td>
        <td class="muted">${escapeHtml(c.addr||"")}</td>
        <td class="right">
          <button class="btn danger" onclick="Customers.remove('${c.id}')">Delete</button>
        </td>`;
      tb.appendChild(tr);
    }
    Invoices.refreshCustomerSelect();
  }

  function renderInvoices(){
    const tb = $("invoicesList");
    tb.innerHTML = "";
    for(const i of state.invoices){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(i.no)}</td>
        <td class="muted">${escapeHtml(i.customer?.name||"")}</td>
        <td class="muted">${escapeHtml(i.date)}</td>
        <td>${escapeHtml(i.status)}</td>
        <td class="right">${moneyDE(i.amount)}</td>
        <td class="right">
          <button class="btn" onclick="Invoices.print('${i.id}')">PDF</button>
          <button class="btn danger" onclick="Invoices.remove('${i.id}')">Delete</button>
        </td>`;
      tb.appendChild(tr);
    }
  }

  function renderExpenses(){
    const tb = $("expensesList");
    tb.innerHTML = "";
    for(const e of state.expenses){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="muted">${escapeHtml(e.date)}</td>
        <td>${escapeHtml(e.cat)}</td>
        <td class="muted">${escapeHtml(e.note||"")}</td>
        <td class="right">${moneyDE(e.amount)}</td>
        <td class="right"><button class="btn danger" onclick="Expenses.remove('${e.id}')">Delete</button></td>`;
      tb.appendChild(tr);
    }
  }

  function renderPayroll(){
    const tb = $("payrollList");
    tb.innerHTML = "";
    for(const p of state.payroll){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="muted">${escapeHtml(p.month)}</td>
        <td>${escapeHtml(p.name)}</td>
        <td class="muted">${p.hours}</td>
        <td class="right">${moneyDE(p.brutto)}</td>
        <td class="right">${moneyDE(p.netto)}</td>
        <td class="right">
          <button class="btn" onclick="Payroll.print('${p.id}')">PDF</button>
          <button class="btn danger" onclick="Payroll.remove('${p.id}')">Delete</button>
        </td>`;
      tb.appendChild(tr);
    }
  }

  function renderKPIs(){
    const year = new Date().getFullYear();
    const yearInv = state.invoices.filter(i => String(i.date||"").startsWith(String(year)));
    const yearRev = yearInv.reduce((a,i)=>a+Number(i.amount||0),0);
    const yearExp = state.expenses.filter(e => String(e.date||"").startsWith(String(year))).reduce((a,e)=>a+Number(e.amount||0),0);

    $("kpiYearRevenue").textContent = moneyDE(yearRev);
    $("kpiYearExpenses").textContent = moneyDE(yearExp);
    $("kpiInvoiceCount").textContent = String(yearInv.length);
  }

  function renderRecent(){
    const list = [];
    for(const i of state.invoices.slice(0,5)){
      list.push({type:"Rechnung", desc:`${i.no} ‚Ä¢ ${i.customer?.name||""}`, date:i.date, amount:i.amount});
    }
    for(const e of state.expenses.slice(0,5)){
      list.push({type:"Ausgabe", desc:`${e.cat} ‚Ä¢ ${e.note||""}`, date:e.date, amount:-e.amount});
    }
    list.sort((a,b)=>String(b.date).localeCompare(String(a.date)));
    const tb = $("recentList");
    tb.innerHTML = "";
    for(const x of list.slice(0,8)){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(x.type)}</td>
        <td class="muted">${escapeHtml(x.desc)}</td>
        <td class="muted">${escapeHtml(x.date)}</td>
        <td class="right">${moneyDE(Math.abs(x.amount))}</td>`;
      tb.appendChild(tr);
    }
  }

  function renderAll(){
    $("versionLabel").textContent = "Version: " + APP_VERSION;
    Settings.loadForm();
    Invoices.fillDefaults();
    Expenses.clearForm();
    renderCounts();
    renderCustomers();
    renderInvoices();
    renderExpenses();
    renderPayroll();
    renderKPIs();
    renderRecent();
  }

  renderAll();

  // Register service worker ONLY if you later add sw.js (not included now to avoid cache problems)
  // if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

})();
</script>
</body>
</html>
// =========================
// FILE: manifest.json
// (ku samee GitHub: Add file ‚Üí Create new file ‚Üí manifest.json)
// =========================
{
  "name": "Masculine Security ‚Äî Mini Office",
  "short_name": "MS Office",
  "start_url": "./",
  "scope": "./",
  "display": "standalone",
  "background_color": "#0b1220",
  "theme_color": "#0b1220",
  "description": "Offline Mini Office: Kunden, Rechnungen, Ausgaben, Lohnabrechnung. Kleinunternehmer ¬ß19 UStG.",
  "icons": [
    {
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
========================
1) FILE: index.html
========================
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Masculine Security ‚Äî Mini Office</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
</head>
<body>
  <!-- Halkan ku hay app-kaaga (HTML/CSS/JS). -->
  <h1 style="color:#fff;background:#0b1220;padding:20px;border-radius:12px;font-family:Arial">MS Mini Office</h1>

  <script>
    // Register Service Worker (PWA Install muhiim)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
          console.log("SW registered:", reg.scope);
        } catch (e) {
          console.error("SW register failed:", e);
        }
      });
    }
  </script>
</body>
</html>


========================
2) FILE: manifest.json
========================
{
  "id": "/",
  "name": "Masculine Security ‚Äî Mini Office",
  "short_name": "MS Office",
  "start_url": "./index.html",
  "scope": "./",
  "display": "standalone",
  "background_color": "#0b1220",
  "theme_color": "#0b1220",
  "description": "Offline Mini Office: Kunden, Rechnungen, Ausgaben, Lohnabrechnung. Kleinunternehmer ¬ß19 UStG.",
  "icons": [
    { "src": "./icons/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
    { "src": "./icons/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
  ]
}


========================
3) FILE: sw.js
========================
const CACHE = "ms-mini-office-v1";
const ASSETS = [
  "./",
  "./index.html",
  "./manifest.json",
  "./icons/icon-192.png",
  "./icons/icon-512.png"
];

self.addEventListener("install", (event) => {
  event.waitUntil(
    caches.open(CACHE).then((cache) => cache.addAll(ASSETS)).then(() => self.skipWaiting())
  );
});

self.addEventListener("activate", (event) => {
  event.waitUntil(
    caches.keys().then((keys) =>
      Promise.all(keys.map((k) => (k !== CACHE ? caches.delete(k) : null)))
    ).then(() => self.clients.claim())
  );
});

self.addEventListener("fetch", (event) => {
  event.respondWith(
    caches.match(event.request).then((cached) => cached || fetch(event.request))
  );
});


========================
4) FILES: icons (folder)
Create folder: icons/
- icons/icon-192.png  (192x192 png)
- icons/icon-512.png  (512x512 png)
========================
