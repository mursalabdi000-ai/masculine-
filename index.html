<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masculine Security — Einsatzmeldung (Final Fixed)</title>
  <meta name="theme-color" content="#0b3a78"/>

  <style>
    :root{
      --bg:#071225; --panel:#0b1a33; --panel2:#0c2242; --card:#0f2a4f;
      --line:#16345e; --text:#e7f0ff; --muted:#9bb1d5; --accent:#3aa6ff;
      --good:#21d19f; --danger:#ff4d6d; --r:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(58,166,255,.22), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(33,209,159,.12), transparent 55%),
        var(--bg);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg, rgba(11,26,51,.92), rgba(7,18,37,.78));
      border-bottom:1px solid rgba(22,52,94,.7);
      backdrop-filter: blur(10px);
      gap:12px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .brand.right{flex-direction:row-reverse}
    .brand.top{flex-direction:column; align-items:flex-start}
    .brand.hideLogo #logoImg{display:none!important}
    .logo{
      width:44px; height:44px; border-radius:12px; object-fit:contain;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      display:none;
    }
    .brandName{font-weight:900; letter-spacing:.2px}
    .brandSub{color:var(--muted); font-size:12px; margin-top:2px}
    .status{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px 10px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--muted); font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.35); border:1px solid rgba(255,255,255,.25)}
    .dot.ok{background:rgba(33,209,159,.85); border-color:rgba(33,209,159,.65)}
    .dot.work{background:rgba(58,166,255,.85); border-color:rgba(58,166,255,.65)}
    .dot.err{background:rgba(255,77,109,.85); border-color:rgba(255,77,109,.65)}
    .topActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    select{
      padding:9px 10px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
    }
    .wrap{max-width:1220px; margin:18px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px;}
    .span2{grid-column: 1 / span 2}
    .card{
      background:linear-gradient(180deg, rgba(15,42,79,.92), rgba(11,26,51,.85));
      border:1px solid rgba(22,52,94,.8);
      border-radius:var(--r);
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      padding:14px;
    }
    .card h2{margin:0 0 6px 0; font-size:18px}
    .muted{color:var(--muted); margin:0 0 12px 0}
    .small{font-size:12px}
    .row{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-bottom:10px;}
    .row.actions{display:flex; gap:10px; flex-wrap:wrap}
    .field label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    input, textarea{
      width:100%; padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(22,52,94,.9);
      background:rgba(7,18,37,.55);
      color:var(--text);
      outline:none;
      resize:vertical;
    }
    input:focus, textarea:focus, select:focus{border-color:rgba(58,166,255,.9); box-shadow:0 0 0 3px rgba(58,166,255,.15)}
    .btn{
      border:0; padding:10px 12px; border-radius:14px;
      color:#061226; background:var(--accent);
      font-weight:900; cursor:pointer; user-select:none;
    }
    .btn.ghost{background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12);}
    .btn.danger{background:rgba(255,77,109,.18); color:#ffd7de; border:1px solid rgba(255,77,109,.35);}
    .btn:hover{filter:brightness(1.05)}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; padding:10px; border-radius:14px;
      background:rgba(7,18,37,.45);
      border:1px solid rgba(22,52,94,.7);
    }
    .item b{display:block}
    .item .meta{color:var(--muted); font-size:12px; margin-top:3px}
    .item .right{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(58,166,255,.12);
      border:1px solid rgba(58,166,255,.22);
      color:var(--text);
    }
    .pickWrap{border:1px solid rgba(255,255,255,.12); background:rgba(7,18,37,.35); border-radius:16px; padding:10px;}
    .pickHdr{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px;}
    .pickList{display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; padding-right:4px;}
    .pickRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; padding:8px 10px; border-radius:14px;
      border:1px solid rgba(22,52,94,.7);
      background:rgba(7,18,37,.45);
    }
    .pickLeft{display:flex; gap:10px; align-items:flex-start;}
    .chk{width:18px; height:18px; margin-top:2px; accent-color: var(--accent);}
    .pickName{font-weight:900}
    .pickMeta{color:var(--muted); font-size:12px; margin-top:2px}
    .sigBox{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(7,18,37,.35);
      border-radius:16px;
      padding:10px;
    }
    canvas{
      width:100%;
      height:180px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      touch-action:none;
    }
    .sigActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .note{
      border:1px solid rgba(33,209,159,.25);
      background:rgba(33,209,159,.08);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      color:#dbfff5;
    }
    .modal{
      position:fixed; inset:0; z-index:50;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(820px, 100%);
      background:linear-gradient(180deg, rgba(15,42,79,.98), rgba(11,26,51,.96));
      border:1px solid rgba(22,52,94,.9);
      border-radius:18px;
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      padding:14px;
    }
    .modalTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .modalTop h3{margin:0; font-size:16px}

    /* Footer buttons clickable (no link issues) */
    .footer{
      margin-top:18px;
      text-align:center;
      padding:14px 10px;
      border-top:1px solid rgba(255,255,255,.10);
      color:rgba(231,240,255,.92);
    }
    .footerBtn{
      all:unset;
      cursor:pointer;
      text-decoration:underline;
      padding:2px 6px;
      border-radius:8px;
    }
    .footerBtn:hover{background:rgba(255,255,255,.06)}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .span2{grid-column:auto}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand" id="brandWrap">
      <img class="logo" id="logoImg" alt="Logo"/>
      <div>
        <div class="brandName" id="brandName">Masculine Security</div>
        <div class="brandSub" id="brandSub"></div>
      </div>
    </div>

    <div class="topActions">
      <div class="status" title="Auto-save status">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Ready</span>
      </div>

      <select id="logoPosApp" title="Logo position in App">
        <option value="left">App: Left</option>
        <option value="right">App: Right</option>
        <option value="top">App: Top</option>
        <option value="hide">App: Hide</option>
      </select>

      <select id="logoPosPdf" title="Logo position in PDF">
        <option value="left">PDF: Left</option>
        <option value="right">PDF: Right</option>
        <option value="top">PDF: Top</option>
        <option value="hide">PDF: Hide</option>
      </select>

      <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px">
        Logo PNG (optional)
        <input id="logoFile" type="file" accept="image/png" style="display:none">
      </label>
      <button class="btn ghost" id="btnRemoveLogo" type="button">Remove Logo</button>

      <button class="btn ghost" id="btnBackup" type="button">Backup</button>
      <button class="btn ghost" id="btnRestore" type="button">Restore</button>
      <button class="btn ghost" id="btnClearAll" type="button">Reset</button>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <h2>Mitarbeiter</h2>
        <p class="muted">Add Mitarbeiter + Sign (pen) + Save ✅</p>

        <div class="row">
          <div class="field">
            <label>Name</label>
            <input id="empName" placeholder="z.B. Ahmed Ali"/>
          </div>
          <div class="field">
            <label>Bewacher-ID (optional)</label>
            <input id="empBewacher" placeholder="z.B. HB-123456"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Telefon (optional)</label>
            <input id="empPhone" placeholder="z.B. 0157..."/>
          </div>
          <div class="field">
            <label>Position (optional)</label>
            <input id="empRole" placeholder="z.B. Wachmann"/>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnAddEmp" type="button">Add Mitarbeiter</button>
          <button class="btn danger" id="btnClearEmpFields" type="button">Clear</button>
        </div>

        <div class="list" id="empList"></div>
      </div>

      <div class="card">
        <h2>Kunde & Objekt</h2>
        <p class="muted">Save objekt si aad mar kale u isticmaasho ✅</p>

        <div class="row">
          <div class="field">
            <label>Kunde</label>
            <input id="custName" placeholder="z.B. Hotel Bremen GmbH"/>
          </div>
          <div class="field">
            <label>Objektname</label>
            <input id="objName" placeholder="z.B. Eingang / Lobby"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Adresse</label>
            <input id="objAddr" placeholder="Straße, PLZ Ort"/>
          </div>
          <div class="field">
            <label>Objekt-Typ</label>
            <select id="objType">
              <option value="Hotel">Hotel</option>
              <option value="Baustelle">Baustelle</option>
              <option value="Event">Event</option>
              <option value="Asylheim">Asylheim</option>
              <option value="Nachtwache">Nachtwache</option>
              <option value="Sonstiges">Sonstiges</option>
            </select>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnAddObj" type="button">Save Objekt</button>
          <button class="btn danger" id="btnClearObjFields" type="button">Clear</button>
        </div>

        <div class="list" id="objList"></div>
      </div>

      <div class="card span2">
        <h2>Einsatzmeldung</h2>
        <p class="muted">Select Objekt + Mitarbeiter + times → Save Einsatz → PDF ✅</p>

        <div class="row">
          <div class="field">
            <label>Objekt wählen</label>
            <select id="selObj"></select>
          </div>
          <div class="field">
            <label>Datum</label>
            <input id="shiftDate" type="date"/>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Start</label>
            <input id="shiftStart" type="time" step="60"/>
          </div>
          <div class="field">
            <label>Ende</label>
            <input id="shiftEnd" type="time" step="60"/>
          </div>
        </div>

        <div class="row">
          <div class="field" style="grid-column:1/-1">
            <label>Mitarbeiter auswählen</label>
            <div class="pickWrap">
              <div class="pickHdr">
                <div class="muted small" id="selCount">0 selected</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn ghost" id="btnSelectAll" type="button">Select all</button>
                  <button class="btn ghost" id="btnClearAllEmp" type="button">Clear all</button>
                </div>
              </div>
              <div class="pickList" id="empPickList"></div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="field" style="grid-column:1/-1">
            <label>Unterschrift Arbeitgeber / Auftraggeber (saved)</label>
            <div class="sigBox">
              <canvas id="sigAg" width="900" height="240"></canvas>
              <div class="sigActions">
                <button class="btn ghost" id="btnAgClear" type="button">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <div class="row actions">
          <button class="btn" id="btnSaveEinsatz" type="button">Save Einsatz</button>
          <button class="btn ghost" id="btnPickLatest" type="button">Select Latest</button>
          <button class="btn" id="btnPdf" type="button">Generate PDF</button>
          <button class="btn danger" id="btnDeleteEinsatz" type="button">Delete Selected</button>
        </div>

        <div class="list" id="einsatzList"></div>

        <div class="note small">
          ✅ Logo: file <b>logo.png</b> ku rid isla folder-ka index.html → auto ayuu u soo qaadanayaa, PDF-na wuu ka muuqanayaa.<br>
          ✅ Clickable: Tel/E-Mail waxaa lagu furayaa buttons (ma aha links) → mobile 100% works.<br>
          ✅ Add Mitarbeiter: now guaranteed working (no global click hacks).
        </div>
      </div>
    </section>

    <!-- Footer clickable -->
    <div class="footer">
      Tel: <button class="footerBtn" id="btnCall" type="button">015778697052</button>
      • E-Mail: <button class="footerBtn" id="btnMail" type="button">Kontakt.mass.bremen@hotmail.com</button>
    </div>
  </main>

  <!-- Signature modal for employee -->
  <div class="modal" id="sigModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <div>
          <h3 id="sigTitle">Unterschrift</h3>
          <p class="muted small" id="sigSub" style="margin:6px 0 0 0;">Pen / finger / mouse</p>
        </div>
        <button class="btn ghost" id="btnSigClose" type="button">Close</button>
      </div>

      <div class="sigBox" style="margin-top:10px">
        <canvas id="sigEmp" width="900" height="260"></canvas>
        <div class="sigActions">
          <button class="btn ghost" id="btnSigClear" type="button">Clear</button>
          <button class="btn" id="btnSigSave" type="button">Save</button>
          <button class="btn danger" id="btnSigRemove" type="button">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =======================
       STORE
    ======================= */
    const STORE_KEY="ms_einsatz_FINAL_v1";
    const $=id=>document.getElementById(id);
    const uid=()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
    const safeParse=(s,f)=>{ try{return JSON.parse(s)}catch{return f} };
    const esc=(s)=>String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function defaultStore(){
      return {
        logoDataUrl:null,
        logoPosApp:"left",
        logoPosPdf:"left",
        company:{
          name:"Masculine Security",
          street:"Werschenregerstraße 6",
          city:"28237 Bremen",
          phone:"015778697052",
          email:"Kontakt.mass.bremen@hotmail.com"
        },
        employees:[],
        objects:[],
        einsaetze:[],
        sigAgDataUrl:null,
        selectedEinsatzId:null
      };
    }

    let store = safeParse(localStorage.getItem(STORE_KEY), null) || defaultStore();
    function saveStore(){ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }

    /* =======================
       AUTOSAVE STATUS
    ======================= */
    let saveTimer=null;
    function setSaveStatus(mode){
      const dot=$("saveDot"), txt=$("saveText");
      dot.classList.remove("ok","work","err");
      if(mode==="saving"){ dot.classList.add("work"); txt.textContent="Saving…"; }
      else if(mode==="saved"){ dot.classList.add("ok"); txt.textContent="Saved"; }
      else if(mode==="error"){ dot.classList.add("err"); txt.textContent="Error"; }
      else { txt.textContent="Ready"; }
    }
    function queueSave(){
      setSaveStatus("saving");
      clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        try{ saveStore(); setSaveStatus("saved"); }
        catch{ setSaveStatus("error"); }
      }, 250);
    }

    /* =======================
       LOGO (logo.png -> DataURL)
    ======================= */
    async function forceAutoLogoFromPng(){
      if(store.logoDataUrl && String(store.logoDataUrl).startsWith("data:image/")) return;
      try{
        const url = new URL("logo.png", location.href);
        url.searchParams.set("v", Date.now().toString());
        const res = await fetch(url.href, { cache:"no-store" });
        if(!res.ok) throw new Error("logo.png not found");
        const blob = await res.blob();
        if(blob.type!=="image/png") throw new Error("logo.png is not PNG");
        const dataUrl = await new Promise((resolve,reject)=>{
          const fr=new FileReader();
          fr.onload=()=>resolve(String(fr.result||""));
          fr.onerror=reject;
          fr.readAsDataURL(blob);
        });
        store.logoDataUrl=dataUrl;
        saveStore();
      }catch(e){
        // OK if missing. App still works.
        console.warn(e);
      }
    }

    function applyLogo(){
      const img=$("logoImg");
      if(store.logoDataUrl){
        img.src=store.logoDataUrl;
        img.style.display="block";
      }else{
        img.removeAttribute("src");
        img.style.display="none";
      }
    }
    function applyLogoPosApp(){
      const wrap=$("brandWrap");
      wrap.classList.remove("right","top","hideLogo");
      const pos=store.logoPosApp||"left";
      if(pos==="right") wrap.classList.add("right");
      if(pos==="top") wrap.classList.add("top");
      if(pos==="hide") wrap.classList.add("hideLogo");
      $("logoPosApp").value=pos;
    }
    function refreshBrand(){
      const c=store.company||{};
      $("brandName").textContent=c.name||"Security";
      $("brandSub").textContent = `${(c.street||"").trim()} ${((c.street||"")&&(c.city||""))?", ":""}${(c.city||"").trim()} • Tel: ${(c.phone||"").trim()} • E-Mail: ${(c.email||"").trim()} • ${store.logoDataUrl?"Logo: OK":"Logo: none"}`;
    }

    $("logoPosApp").addEventListener("change", ()=>{
      store.logoPosApp = $("logoPosApp").value;
      applyLogoPosApp();
      queueSave();
    });
    $("logoPosPdf").addEventListener("change", ()=>{
      store.logoPosPdf = $("logoPosPdf").value;
      queueSave();
    });

    $("logoFile").addEventListener("change", ()=>{
      const f=$("logoFile").files?.[0];
      if(!f) return;
      if(f.type!=="image/png"){ alert("PNG kaliya ✅"); $("logoFile").value=""; return; }
      if(f.size>3*1024*1024){ alert("Logo < 3MB"); $("logoFile").value=""; return; }
      const fr=new FileReader();
      fr.onload=()=>{
        store.logoDataUrl=String(fr.result||"");
        $("logoFile").value="";
        applyLogo(); refreshBrand(); queueSave();
      };
      fr.readAsDataURL(f);
    });

    $("btnRemoveLogo").addEventListener("click", ()=>{
      if(!confirm("Remove stored logo?")) return;
      store.logoDataUrl=null;
      applyLogo(); refreshBrand(); queueSave();
    });

    /* =======================
       CLICKABLE FOOTER (NO BUGS)
    ======================= */
    $("btnCall").addEventListener("click", ()=>{ location.href="tel:015778697052"; });
    $("btnMail").addEventListener("click", ()=>{ location.href="mailto:Kontakt.mass.bremen@hotmail.com"; });

    /* =======================
       SIGNATURE PAD (Pointer events)
    ======================= */
    function makePad(canvas, onEnd){
      const ctx=canvas.getContext("2d", {willReadFrequently:true});
      let drawing=false, last=null;

      function resize(){
        const rect=canvas.getBoundingClientRect();
        const dpr=Math.max(1, window.devicePixelRatio||1);
        const w=Math.floor(rect.width*dpr), h=Math.floor(rect.height*dpr);
        if(canvas.width!==w || canvas.height!==h){
          const tmp=document.createElement("canvas");
          tmp.width=canvas.width; tmp.height=canvas.height;
          tmp.getContext("2d").drawImage(canvas,0,0);

          canvas.width=w; canvas.height=h;
          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr,dpr);
          ctx.clearRect(0,0,rect.width,rect.height);

          if(tmp.width && tmp.height){
            ctx.drawImage(tmp, 0,0, tmp.width, tmp.height, 0,0, rect.width, rect.height);
          }
        }else{
          ctx.setTransform(1,0,0,1,0,0);
          ctx.scale(dpr,dpr);
        }
      }
      function pos(e){
        const r=canvas.getBoundingClientRect();
        return {x:e.clientX-r.left, y:e.clientY-r.top};
      }
      function line(a,b){
        ctx.lineWidth=2.6;
        ctx.lineCap="round";
        ctx.lineJoin="round";
        ctx.strokeStyle="rgba(255,255,255,.95)";
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }

      canvas.addEventListener("pointerdown", (e)=>{
        resize();
        drawing=true;
        last=pos(e);
        canvas.setPointerCapture?.(e.pointerId);
      });
      canvas.addEventListener("pointermove", (e)=>{
        if(!drawing) return;
        e.preventDefault();
        const p=pos(e);
        line(last,p);
        last=p;
      });
      function end(){
        if(!drawing) return;
        drawing=false; last=null;
        onEnd?.();
      }
      canvas.addEventListener("pointerup", end);
      canvas.addEventListener("pointercancel", end);
      window.addEventListener("resize", resize);
      resize();

      return {
        clear(){
          resize();
          const r=canvas.getBoundingClientRect();
          ctx.clearRect(0,0,r.width,r.height);
        },
        toDataUrl(){ return canvas.toDataURL("image/png"); },
        fromDataUrl(dataUrl){
          this.clear();
          if(!dataUrl) return;
          const img=new Image();
          img.onload=()=>{
            const r=canvas.getBoundingClientRect();
            ctx.drawImage(img,0,0,r.width,r.height);
          };
          img.src=dataUrl;
        }
      };
    }

    const agPad = makePad($("sigAg"), ()=>{
      store.sigAgDataUrl = agPad.toDataUrl();
      queueSave();
    });
    $("btnAgClear").addEventListener("click", ()=>{
      agPad.clear();
      store.sigAgDataUrl=null;
      queueSave();
    });

    /* Employee signature modal */
    const modal=$("sigModal");
    const empPad = makePad($("sigEmp"), ()=>{});
    let modalEmpId=null;

    function openSig(empId){
      const emp=store.employees.find(e=>e.id===empId);
      if(!emp) return;
      modalEmpId=empId;
      $("sigTitle").textContent = `Unterschrift — ${emp.name}`;
      $("sigSub").textContent = `Bewacher-ID: ${emp.bewacher||"—"}`;
      empPad.fromDataUrl(emp.sigDataUrl||null);
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function closeSig(){
      modalEmpId=null;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    $("btnSigClose").addEventListener("click", closeSig);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeSig(); });

    $("btnSigClear").addEventListener("click", ()=>empPad.clear());
    $("btnSigRemove").addEventListener("click", ()=>{
      if(!modalEmpId) return;
      const emp=store.employees.find(e=>e.id===modalEmpId);
      if(!emp) return;
      emp.sigDataUrl=null;
      queueSave();
      renderAll();
      closeSig();
    });
    $("btnSigSave").addEventListener("click", ()=>{
      if(!modalEmpId) return;
      const emp=store.employees.find(e=>e.id===modalEmpId);
      if(!emp) return;
      emp.sigDataUrl = empPad.toDataUrl();
      queueSave();
      renderAll();
      closeSig();
    });

    /* =======================
       RENDER
    ======================= */
    function selectedEmpIds(){
      return Array.from(document.querySelectorAll('input[data-emp="1"]:checked')).map(x=>x.value);
    }
    function setSelectedCount(){
      $("selCount").textContent = `${selectedEmpIds().length} selected`;
    }

    function renderEmployees(){
      const list=$("empList");
      list.innerHTML="";
      if(store.employees.length===0){
        list.innerHTML=`<div class="muted small">No Mitarbeiter yet.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <div>
              <b>${esc(emp.name)}</b>
              <div class="meta">
                Bewacher-ID: ${esc(emp.bewacher||"—")}
                ${emp.role?` • ${esc(emp.role)}`:""}
                ${emp.phone?` • ${esc(emp.phone)}`:""}
                • Signature: ${emp.sigDataUrl?`<span style="color:#bfffe7">OK</span>`:"—"}
              </div>
            </div>
            <div class="right">
              <button class="btn ghost" type="button" data-sign="${emp.id}">Sign</button>
              <button class="btn danger" type="button" data-del="${emp.id}">Delete</button>
            </div>`;
          list.appendChild(div);
        });
      }

      const pick=$("empPickList");
      pick.innerHTML="";
      if(store.employees.length===0){
        pick.innerHTML=`<div class="muted small">No Mitarbeiter to select.</div>`;
      }else{
        store.employees.forEach(emp=>{
          const row=document.createElement("div");
          row.className="pickRow";
          row.innerHTML=`
            <div class="pickLeft">
              <input class="chk" type="checkbox" data-emp="1" value="${emp.id}">
              <div>
                <div class="pickName">${esc(emp.name)} ${emp.sigDataUrl?"✓":""}</div>
                <div class="pickMeta">Bewacher-ID: ${esc(emp.bewacher||"—")} ${emp.role?` • ${esc(emp.role)}`:""}</div>
              </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <span class="pill">${emp.sigDataUrl?"Signed":"No Sig"}</span>
              <button class="btn ghost" type="button" data-sign="${emp.id}">Sign</button>
            </div>`;
          pick.appendChild(row);
        });
        pick.querySelectorAll('input[data-emp="1"]').forEach(chk=>{
          chk.addEventListener("change", ()=>{ setSelectedCount(); });
        });
      }
      setSelectedCount();

      // bind sign/delete buttons
      document.querySelectorAll("[data-sign]").forEach(btn=>{
        btn.onclick=()=>openSig(btn.getAttribute("data-sign"));
      });
      document.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-del");
          if(!confirm("Delete Mitarbeiter?")) return;
          store.employees=store.employees.filter(e=>e.id!==id);
          // remove from einsaetze
          store.einsaetze.forEach(en=>en.empIds=(en.empIds||[]).filter(x=>x!==id));
          queueSave();
          renderAll();
        };
      });
    }

    function renderObjects(){
      const list=$("objList");
      list.innerHTML="";
      if(store.objects.length===0){
        list.innerHTML=`<div class="muted small">No Objekt yet.</div>`;
      }else{
        store.objects.forEach(obj=>{
          const div=document.createElement("div");
          div.className="item";
          div.innerHTML=`
            <div>
              <b>${esc(obj.cust)} — ${esc(obj.obj)}</b>
              <div class="meta">${esc(obj.type)} • ${esc(obj.addr)}</div>
            </div>
            <div class="right">
              <button class="btn danger" type="button" data-delobj="${obj.id}">Delete</button>
            </div>`;
          list.appendChild(div);
        });
      }

      const sel=$("selObj");
      sel.innerHTML="";
      if(store.objects.length===0){
        sel.innerHTML=`<option value="">— no Objekt —</option>`;
      }else{
        store.objects.forEach(obj=>{
          const opt=document.createElement("option");
          opt.value=obj.id;
          opt.textContent=`${obj.cust} — ${obj.obj}`;
          sel.appendChild(opt);
        });
      }

      document.querySelectorAll("[data-delobj]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-delobj");
          if(!confirm("Delete Objekt?")) return;
          store.objects=store.objects.filter(o=>o.id!==id);
          queueSave();
          renderAll();
        };
      });
    }

    function renderEinsaetze(){
      const list=$("einsatzList");
      list.innerHTML="";
      if(store.einsaetze.length===0){
        list.innerHTML=`<div class="muted small">No Einsätze yet.</div>`;
        return;
      }
      store.einsaetze.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).forEach(ein=>{
        const obj=store.objects.find(o=>o.id===ein.objId);
        const names=(ein.empIds||[]).map(id=>store.employees.find(e=>e.id===id)?.name||"(missing)").join(", ");
        const active = store.selectedEinsatzId===ein.id;
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <div>
            <b>${esc(names||"(no Mitarbeiter)")} • ${esc(obj?.obj||"(missing Objekt)")} ${active?"✓":""}</b>
            <div class="meta">${esc(ein.date)} • ${esc(ein.start)}–${esc(ein.end)} • ${esc(obj?.cust||"")}</div>
          </div>
          <div class="right">
            <span class="pill">${esc(obj?.type||ein.type||"Einsatz")}</span>
            <button class="btn ghost" type="button" data-pick="${ein.id}">${active?"Selected":"Select"}</button>
          </div>`;
        list.appendChild(div);
      });

      document.querySelectorAll("[data-pick]").forEach(btn=>{
        btn.onclick=()=>{
          const id=btn.getAttribute("data-pick");
          store.selectedEinsatzId=id;
          const ein=store.einsaetze.find(x=>x.id===id);
          if(ein){
            $("selObj").value=ein.objId||"";
            $("shiftDate").value=ein.date||"";
            $("shiftStart").value=ein.start||"";
            $("shiftEnd").value=ein.end||"";
            // check employees
            const set=new Set((ein.empIds||[]).map(String));
            document.querySelectorAll('input[data-emp="1"]').forEach(chk=>chk.checked=set.has(String(chk.value)));
            setSelectedCount();
          }
          queueSave();
          renderEinsaetze();
        };
      });
    }

    function renderAll(){
      applyLogo();
      applyLogoPosApp();
      refreshBrand();
      $("logoPosPdf").value = store.logoPosPdf || "left";
      renderEmployees();
      renderObjects();
      renderEinsaetze();
      agPad.fromDataUrl(store.sigAgDataUrl||null);
    }

    /* =======================
       BUTTONS: Mitarbeiter/Object/Einsatz
    ======================= */
    $("btnAddEmp").addEventListener("click", ()=>{
      const name=$("empName").value.trim();
      if(!name) return alert("Bitte Name eingeben.");
      store.employees.push({
        id:uid(),
        name,
        bewacher:$("empBewacher").value.trim(),
        phone:$("empPhone").value.trim(),
        role:$("empRole").value.trim(),
        sigDataUrl:null
      });
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
      queueSave();
      renderAll();
    });
    $("btnClearEmpFields").addEventListener("click", ()=>{
      $("empName").value=""; $("empBewacher").value=""; $("empPhone").value=""; $("empRole").value="";
    });

    $("btnAddObj").addEventListener("click", ()=>{
      const cust=$("custName").value.trim();
      const obj=$("objName").value.trim();
      const addr=$("objAddr").value.trim();
      const type=$("objType").value;
      if(!cust || !obj || !addr) return alert("Bitte Kunde, Objektname, Adresse ausfüllen.");
      store.objects.push({id:uid(), cust, obj, addr, type});
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
      queueSave();
      renderAll();
    });
    $("btnClearObjFields").addEventListener("click", ()=>{
      $("custName").value=""; $("objName").value=""; $("objAddr").value=""; $("objType").value="Hotel";
    });

    $("btnSelectAll").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp="1"]').forEach(chk=>chk.checked=true);
      setSelectedCount();
    });
    $("btnClearAllEmp").addEventListener("click", ()=>{
      document.querySelectorAll('input[data-emp="1"]').forEach(chk=>chk.checked=false);
      setSelectedCount();
    });

    $("btnSaveEinsatz").addEventListener("click", ()=>{
      const objId=$("selObj").value;
      const empIds=selectedEmpIds();
      const date=$("shiftDate").value;
      const start=$("shiftStart").value;
      const end=$("shiftEnd").value;
      if(!objId) return alert("Objekt wählen.");
      if(empIds.length===0) return alert("Mindestens 1 Mitarbeiter auswählen.");
      if(!date || !start || !end) return alert("Datum/Start/Ende ausfüllen.");

      const obj=store.objects.find(o=>o.id===objId);
      const type=obj?.type || "Einsatz";

      store.einsaetze.push({
        id:uid(),
        objId, empIds,
        date, start, end,
        type,
        createdAt:Date.now(),
        sigAgDataUrl: store.sigAgDataUrl || null
      });
      store.selectedEinsatzId = store.einsaetze[store.einsaetze.length-1].id;
      queueSave();
      renderAll();
      alert("Einsatz saved ✅");
    });

    $("btnPickLatest").addEventListener("click", ()=>{
      if(store.einsaetze.length===0) return alert("No Einsatz yet.");
      const latest = store.einsaetze.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))[0];
      store.selectedEinsatzId = latest.id;
      queueSave();
      renderAll();
      // pick UI
      const ein=latest;
      $("selObj").value=ein.objId||"";
      $("shiftDate").value=ein.date||"";
      $("shiftStart").value=ein.start||"";
      $("shiftEnd").value=ein.end||"";
      const set=new Set((ein.empIds||[]).map(String));
      document.querySelectorAll('input[data-emp="1"]').forEach(chk=>chk.checked=set.has(String(chk.value)));
      setSelectedCount();
      renderEinsaetze();
    });

    $("btnDeleteEinsatz").addEventListener("click", ()=>{
      const id=store.selectedEinsatzId;
      if(!id) return alert("Select Einsatz first.");
      if(!confirm("Delete selected Einsatz?")) return;
      store.einsaetze = store.einsaetze.filter(e=>e.id!==id);
      store.selectedEinsatzId=null;
      queueSave();
      renderEinsaetze();
    });

    /* =======================
       BACKUP / RESTORE / RESET
    ======================= */
    function downloadText(name, text, mime="application/json"){
      const blob=new Blob([text], {type:mime});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=name;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    $("btnBackup").addEventListener("click", ()=>{
      downloadText("einsatzmeldung-backup.json", JSON.stringify(store,null,2));
    });
    $("btnRestore").addEventListener("click", ()=>{
      const input=document.createElement("input");
      input.type="file"; input.accept="application/json";
      input.onchange=()=>{
        const f=input.files?.[0]; if(!f) return;
        const r=new FileReader();
        r.onload=()=>{
          const data=safeParse(String(r.result||""), null);
          if(!data || typeof data!=="object") return alert("Invalid JSON.");
          store = { ...defaultStore(), ...data };
          saveStore();
          renderAll();
          alert("Restore done ✅");
        };
        r.readAsText(f);
      };
      input.click();
    });
    $("btnClearAll").addEventListener("click", ()=>{
      if(!confirm("Reset everything?")) return;
      store=defaultStore();
      saveStore();
      location.reload();
    });

    /* =======================
       PDF
    ======================= */
    function formatDE(iso){
      if(!iso) return "";
      const [y,m,d]=iso.split("-");
      return (y&&m&&d) ? `${d}.${m}.${y}` : iso;
    }
    function waitForImagesThenPrint(){
      const imgs=Array.from(document.images||[]);
      if(imgs.length===0){ window.print(); return; }
      let done=0;
      const fin=()=>{ done++; if(done>=imgs.length) setTimeout(()=>window.print(), 250); };
      imgs.forEach(img=>{
        if(img.complete) fin();
        else { img.onload=fin; img.onerror=fin; }
      });
      setTimeout(()=>window.print(), 1400);
    }

    async function generatePdf(ein){
      await forceAutoLogoFromPng(); // ensure dataURL if logo.png exists

      const c=store.company||{};
      const obj=store.objects.find(o=>o.id===ein.objId);
      const employees=(ein.empIds||[]).map(id=>store.employees.find(e=>e.id===id)).filter(Boolean);

      const logoPos = store.logoPosPdf || "left";
      const showLogo = (logoPos!=="hide") && !!store.logoDataUrl;
      const logoHTML = showLogo ? `
        <div class="logoBox"><img class="logo" src="${store.logoDataUrl}" alt="Logo"/></div>` : ``;

      const header = (()=>{
        const companyLine = `${esc(c.name||"")} • ${esc((c.street||"").trim())}${(c.street&&c.city)?", ":""}${esc((c.city||"").trim())}`;
        const contactLine = `Tel: ${esc(c.phone||"")} • E-Mail: ${esc(c.email||"")}`;
        if(!showLogo){
          return `
            <div class="head">
              <div>
                <h1>Einsatzmeldung</h1>
                <div class="sub">${companyLine}</div>
                <div class="sub">${contactLine}</div>
              </div>
              <div style="text-align:right;">
                <div class="sub"><b>Datum:</b> ${formatDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${esc(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>`;
        }
        if(logoPos==="top"){
          return `
            <div style="display:flex; flex-direction:column; gap:10px;">
              ${logoHTML}
              <div class="head">
                <div>
                  <h1>Einsatzmeldung</h1>
                  <div class="sub">${companyLine}</div>
                  <div class="sub">${contactLine}</div>
                </div>
                <div style="text-align:right;">
                  <div class="sub"><b>Datum:</b> ${formatDE(ein.date)}</div>
                  <div class="sub"><b>Typ:</b> ${esc(obj?.type||ein.type||"Einsatz")}</div>
                </div>
              </div>
            </div>`;
        }
        if(logoPos==="right"){
          return `
            <div class="head">
              <div>
                <h1>Einsatzmeldung</h1>
                <div class="sub">${companyLine}</div>
                <div class="sub">${contactLine}</div>
              </div>
              <div style="text-align:right; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                ${logoHTML}
                <div class="sub"><b>Datum:</b> ${formatDE(ein.date)}</div>
                <div class="sub"><b>Typ:</b> ${esc(obj?.type||ein.type||"Einsatz")}</div>
              </div>
            </div>`;
        }
        return `
          <div class="head">
            <div style="display:flex; gap:12px; align-items:center;">
              ${logoHTML}
              <div>
                <h1>Einsatzmeldung</h1>
                <div class="sub">${companyLine}</div>
                <div class="sub">${contactLine}</div>
              </div>
            </div>
            <div style="text-align:right;">
              <div class="sub"><b>Datum:</b> ${formatDE(ein.date)}</div>
              <div class="sub"><b>Typ:</b> ${esc(obj?.type||ein.type||"Einsatz")}</div>
            </div>
          </div>`;
      })();

      const empRows = employees.length ? employees.map((e,idx)=>{
        const sig = e.sigDataUrl
          ? `<img src="${e.sigDataUrl}" style="max-height:42px; max-width:180px; display:block" alt="Sig"/>`
          : `<div style="height:26px; border:1px solid #111; border-radius:6px;"></div>`;
        return `
          <tr style="page-break-inside:avoid;">
            <td style="padding:6px 8px; border:1px solid #111;">${idx+1}</td>
            <td style="padding:6px 8px; border:1px solid #111;"><b>${esc(e.name)}</b></td>
            <td style="padding:6px 8px; border:1px solid #111;">${esc(e.bewacher||"—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">${esc(e.role||"—")}</td>
            <td style="padding:6px 8px; border:1px solid #111;">${sig}</td>
          </tr>`;
      }).join("") : `<tr><td colspan="5" style="padding:8px; border:1px solid #111;">—</td></tr>`;

      const sigAg = store.sigAgDataUrl || ein.sigAgDataUrl || null;

      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Einsatzmeldung ${formatDE(ein.date)}</title>
<style>
  @page{ size:A4; margin:18mm; }
  body{ font-family:Arial,sans-serif; color:#111; }
  .head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
  .logoBox{ width:64px; height:64px; border:1px solid #111; border-radius:10px; padding:6px; background:#fff; display:flex; align-items:center; justify-content:center; }
  .logo{ width:100%; height:100%; object-fit:contain; display:block; }
  h1{ margin:0; font-size:18px; }
  .sub{ color:#444; margin-top:4px; font-size:12px; }
  .box{ border:1px solid #111; border-radius:10px; padding:12px; margin-top:12px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .label{ font-size:11px; color:#333; margin-bottom:4px; }
  .val{ font-size:12px; font-weight:700; }
  .line{ height:1px; background:#111; opacity:.18; margin:12px 0; }
  table{ border-collapse:collapse; width:100%; font-size:12px; }
  thead{ display:table-header-group; }
  th{ text-align:left; padding:6px 8px; border:1px solid #111; background:#f2f2f2; }
  td{ vertical-align:top; }
  .sigimg{ max-height:70px; max-width:100%; display:block; }
</style>
</head>
<body>
  ${header}

  <div class="box">
    <div class="grid">
      <div>
        <div class="label">Kunde / Objekt</div>
        <div class="val">${esc(obj?.cust||"—")} — ${esc(obj?.obj||"—")}</div>
        <div class="sub">Adresse: ${esc(obj?.addr||"—")}</div>
      </div>
      <div>
        <div class="label">Schichtzeit</div>
        <div class="val">${esc(ein.start)} – ${esc(ein.end)}</div>
      </div>
    </div>

    <div class="line"></div>

    <div class="label">Mitarbeiter (Liste)</div>
    <table>
      <thead>
        <tr>
          <th style="width:44px;">#</th>
          <th>Name</th>
          <th style="width:160px;">Bewacher-ID</th>
          <th style="width:140px;">Position</th>
          <th style="width:200px;">Unterschrift Mitarbeiter</th>
        </tr>
      </thead>
      <tbody>${empRows}</tbody>
    </table>

    <div style="margin-top:14px; display:flex; justify-content:space-between; gap:12px; align-items:flex-end;">
      <div style="flex:1;">
        <div class="label">Unterschrift Arbeitgeber / Auftraggeber</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          ${sigAg ? `<img class="sigimg" src="${sigAg}" alt="Signature Arbeitgeber"/>` : `<div class="sub">—</div>`}
        </div>
      </div>
      <div style="width:240px;">
        <div class="label">Ort / Datum</div>
        <div style="border:1px solid #111; border-radius:10px; padding:10px; min-height:86px;">
          <div style="height:20px;"></div>
          <div style="border-top:1px solid #111; margin-top:26px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>window.onload = () => (${waitForImagesThenPrint.toString()})();<\/script>
</body>
</html>`;

      const w=window.open("", "_blank");
      if(!w) return alert("Popup blocked. Allow popups to print PDF.");
      w.document.open(); w.document.write(html); w.document.close();
    }

    $("btnPdf").addEventListener("click", async ()=>{
      const id=store.selectedEinsatzId;
      if(!id) return alert("Select Einsatz first.");
      const ein=store.einsaetze.find(e=>e.id===id);
      if(!ein) return alert("Einsatz not found.");

      // update employer signature snapshot
      ein.sigAgDataUrl = store.sigAgDataUrl || null;
      queueSave();

      await generatePdf(ein);
    });

    /* =======================
       INIT
    ======================= */
    async function init(){
      // normalize store
      const base=defaultStore();
      store = { ...base, ...store, company:{...base.company, ...(store.company||{})} };
      if(!store.logoPosApp) store.logoPosApp="left";
      if(!store.logoPosPdf) store.logoPosPdf="left";

      // default date/time
      const now=new Date();
      if(!$("shiftDate").value) $("shiftDate").value = now.toISOString().slice(0,10);
      if(!$("shiftStart").value) $("shiftStart").value = "18:00";
      if(!$("shiftEnd").value) $("shiftEnd").value = "06:00";

      await forceAutoLogoFromPng();
      saveStore();
      renderAll();
      setSaveStatus("saved");
    }
    init();
  </script>
</body>
</html>
